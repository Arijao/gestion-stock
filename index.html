<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="description" content="Application gestion stock, achats et ventes">
    <title>Gestion Achat-Vente</title>
    
    <!-- ✅ PWA META TAGS -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Stock Manager">
    <!-- Librairies JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

    <style>
        *{margin:0;padding:0;box-sizing:border-box;}

        /* ✅ ANTI-OVERFLOW GLOBAL */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            font-family: Inter, 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #e4f0f8;
            color: #111827;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden; /* Misoroka ny scroll horizontal amin'ny pejy manontolo */
            width: 100%;
            max-width: 100vw;
            position: relative;
        }

        .main-wrapper,
        .container,
        .content,
        .tab-content {
            max-width: 100%;
            overflow-x: hidden; /* Naverina mba tsy ho tapaka ny sisiny */
        }

        /* ✅ TABLE CONTAINER FOR HORIZONTAL SCROLL */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 12px;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            background: white;
        }

        .table-container table {
            margin-top: 0;
            min-width: 100%; /* Mampiasa ny toerana misy azy */
            width: max-content; /* Manery ny tabilao hihalehibe araka ny votoatiny */
        }


        /* SIDEBAR */
        .sidebar{
            width:72px;
            background:#050816;
            padding:18px 0;
            color:#f9fafb;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:16px;
            position:fixed;
            top:0;
            left:0;
            height:100vh; 
            transition:width .3s ease;
            box-shadow:4px 0 18px rgba(15,23,42,.45);
            z-index:10;
        }
        .sidebar.open{width:220px;}

        .sidebar.open + .main-wrapper {
            margin-left:220px;
        }
        .sidebar-logo{
            width:36px;
            height:36px;
            border-radius:999px;
            background:#111827;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#fff;
            font-weight:700;
            margin-bottom:8px;
        }

        .sidebar-toggle{
            position:absolute;
            right:-14px;
            top:40px;
            width:28px;
            height:28px;
            border-radius:999px;
            border:none;
            background:#ffffff;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            box-shadow:0 6px 12px rgba(0,0,0,.25);
        }

        .sidebar-menu{
            list-style:none;
            width:100%;
            margin-top:12px;
        }
        .sidebar-item{margin:4px 0;}
        .sidebar-link{
            width:100%;
            border:none;
            background:transparent;
            color:#9ca3af;
            padding:10px 18px;
            display:flex;
            align-items:center;
            gap:12px;
            cursor:pointer;
            font-size:14px;
            transition:background .2s,color .2s;
        }
        .sidebar-link i{
            font-size:18px;
            min-width:18px;
            text-align:center;
            color:#f9fafb;
        }
        .sidebar-text{
            opacity:0;
            max-width:0;
            overflow:hidden;
            white-space:nowrap;
            transition:opacity .2s,max-width .2s;
        }
        .sidebar.open .sidebar-text{
            opacity:1;
            max-width:180px;
        }
        .sidebar-link.active,
        .sidebar-link:hover{
            background:#111827;
            color:#f9fafb;
        }

        /* MAIN WRAPPER */
        .main-wrapper{
            flex:1;
            padding:24px 28px;
            margin-left:72px;
        }

        /* LAYOUT MODERNE CONTAINER / HEADER / TABS */
        .container{
            max-width:1200px;
            margin:0 auto;
            background: #f8fafc;
            border-radius:24px;
            box-shadow:0 18px 45px rgba(15,23,42,0.18);
            overflow:hidden;
        }

        .header {
            background:transparent;
            padding:22px 26px 10px 26px;
            border-bottom:0;
            overflow: visible;
        }
        .header h1{
            font-size:24px;
            font-weight:700;
            margin-bottom:4px;
        }
        .header p{
            font-size:13px;
            color:#6b7280;
        }

        .tabs{
            display:flex;
            gap:6px;
            padding:0 22px 12px 22px;
            border-bottom:0;
            background:transparent;
        }
        .tab{
            flex:none;
            padding:9px 14px;
            text-align:center;
            cursor:pointer;
            background:#e5edf7;
            border:none;
            font-size:13px;
            font-weight:600;
            color:#4b5563;
            border-radius:999px;
            border-bottom:0;
            position:relative;
        }
        .tab::after{display:none;}
        .tab.active{
            background:#111827;
            color:#f9fafb;
        }
        .tab:hover{
            background:#cdd9f2;
            color:#111827;
        }

        .content{
            padding:20px 24px 24px 24px;
            background: #f1f5f9;
        }

        .tab-content{
            display:none;
            animation:fadeSlideIn .4s ease-out;
        }
        .tab-content.active{
            display:block;
        }
        @keyframes fadeSlideIn{
            from{opacity:0;transform:translateY(18px);}
            to{opacity:1;transform:translateY(0);}
        }

        /* FORM / BUTTONS / TABLE: modernisé fa mitovy classes */
        .form-section{
            background: #f8fafc;
            padding:18px;
            border-radius:18px;
            margin-bottom:16px;
            border: 1px solid #e2e8f0;
            box-shadow:0 6px 16px rgba(15,23,42,0.06);
        }
        .form-section h3{
            color:#111827;
            margin-bottom:12px;
            font-size:15px;
            font-weight:600;
        }

            .form-grid{
                display:grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap:10px;
            }
        .form-group{display:flex;flex-direction:column;}
        .form-group label{
            margin-bottom:5px;
            font-weight:600;
            color:#374151;
            font-size:12px;
        }
        /* ========== FORM INPUTS - Style cohérent ========== */

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 9px 11px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            font-size: 13px;
            background: #ffffff;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #111827;
            background: white;
            box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1);
        }

        .form-group input[readonly] {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }


        .btn {
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #111827;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn:hover {
            background: #111827;
            color: white;
            border-color: #111827;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(17, 24, 39, 0.3);
        }
        
        /* Variantes principales */
        .btn-primary {
            background: #111827;
            color: white;
            border: 1px solid #111827;
        }

        .btn-primary:hover {
            background: #0f172a;
            border-color: #0f172a;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.4);
        }

        .btn-success {
            background: white;
            color: #16a34a;
            border: 1px solid #16a34a;
        }

        .btn-success:hover {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        .btn-pdf {
            background: white;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .btn-pdf:hover {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .btn-info {
            background: white;
            color: #0891b2;
            border: 1px solid #0891b2;
        }

        .btn-info:hover {
            background: #0891b2;
            color: white;
            border-color: #0891b2;
        }

        #scan-preview img{
            animation:zoomIn .3s ease-out;
            border-radius:18px;
            box-shadow:0 12px 30px rgba(15,23,42,0.4);
        }
        @keyframes zoomIn{
            from{opacity:0;transform:scale(.9);}
            to{opacity:1;transform:scale(1);}
        }

        /* ========== FORCE STYLE POUR TOUS LES BOUTONS PRIMARY ========== */

        button.btn-primary,
        .btn.btn-primary,
        input[type="button"].btn-primary {
            background: #111827 !important;
            color: white !important;
            border: 1px solid #111827 !important;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }

        button.btn-primary:hover,
        .btn.btn-primary:hover,
        input[type="button"].btn-primary:hover {
            background: #0f172a !important;
            border-color: #0f172a !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.4);
        }

        /* Style pour l'icône + dans le bouton */
        button.btn-primary::before,
        .btn.btn-primary::before {
            content: '';
            /* Reset si besoin */
        }


        /* ========== TABLEAU STYLES - Cohérent avec boutons ========== */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            /* border-radius: 14px; */ /* Nafindra any amin'ny container */
            /* overflow: hidden; */
        }

        th {
            background: #111827;
            color: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
        }

        tr:hover {
            background: #f3f4f6;
        }

        /* Row total - beige/gold */
        tfoot tr {
            background: #fef3c7;
            font-weight: bold;
        }

        tfoot td {
            border: none;
        }

        .action-buttons{
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            margin-top:12px;
        }

        .logo-upload{
            text-align:center;
            padding:14px;
            border:2px dashed #2563eb;
            border-radius:16px;
            cursor:pointer;
            background:#eff6ff;
        }
        .logo-preview{
            max-width:150px;
            max-height:80px;
            margin:10px auto;
            display:block;
        }

        .stats-grid{
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap:14px;
            margin-bottom:16px;
        }
        /* Stats cards */
        .stat-card {
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 14px;
            border-left: 4px solid #111827;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            background: rgba(248, 250, 252, 0.95);
        }

        .stat-card h3 {
            font-size: 18px;
            margin-bottom: 4px;
            color: #111827;
        }

        .stat-card p {
            font-size: 12px;
            color: #6b7280;
        }


        .search-box{
            display:flex;
            gap:10px;
            margin-bottom:14px;
        }
        .search-box input,
        .search-box select{
            padding:9px 11px;
            border-radius:999px;
            border:1px solid #d1d5db;
            font-size:13px;
            background: #f8fafc;
        }

        /* ========== BADGES & CARDS ========== */

        .stock-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .stock-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .stock-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .stock-high {
            background: #dcfce7;
            color: #166534;
        }

        .section-title{
            border-left:4px solid #2563eb;
            padding-left:10px;
            margin-bottom:10px;
            font-size:14px;
            font-weight:600;
            color:#111827;
        }

        #pdf-preview-container{
            position:fixed;
            top:-10000px;
            left:-10000px;
            width:210mm;
            background:white;
            padding:20mm;
            font-family:Arial,Helvetica,sans-serif;
        }

        /* ========== BOUTONS COMPACT THÈME DARK ========== */

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #111827;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0; 
        }

        .btn-icon:hover {
            background: #111827;
            color: white;
            border-color: #111827;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 24, 39, 0.3);
        }

        /* Version plus grand pour form buttons */
        .btn-icon-lg {
            width: 38px;
            height: 38px;
            font-size: 16px;
        }

        /* Boutons compacts pour historique */
        .btn-compact {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #111827;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
            min-width: 32px;
        }

        .btn-compact i {
            font-size: 12px;
        }

        .btn-compact:hover {
            background: #111827;
            color: white;
            border-color: #111827;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 24, 39, 0.25);
        }

        /* Variante: Bouton noir par défaut */
        .btn-compact-dark {
            background: #111827;
            color: white;
            border: 1px solid #111827;
        }

        .btn-compact-dark:hover {
            background: #0f172a;
            border-color: #0f172a;
        }

        /* Variante: Bouton gris */
        .btn-compact-gray {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
        }

        .btn-compact-gray:hover {
            background: #6b7280;
            color: white;
            border-color: #6b7280;
        }

        /* Variante spéciale: Bouton vert pour "Payé" */
        .btn-compact-success {
            background: white;
            color: #16a34a;
            border: 1px solid #16a34a;
        }

        .btn-compact-success:hover {
            background: #16a34a;
            color: white;
        }

        /* Variante spéciale: Bouton rouge pour actions importantes */
        .btn-compact-danger {
            background: white;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .btn-compact-danger:hover {
            background: #dc2626;
            color: white;
        }


        /*FACTURE PDF*/

        /* ===== PDF LAYOUT CSS ===== */
        .doc-logo-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            gap: 30px;
        }

        .doc-logo-box {
            background: white;
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border: 2px solid #e2e8f0;
        }

        .doc-logo {
            width: 200px;
            height: auto;
        }

        .doc-supplier-info {
            font-size: 10px;
            line-height: 1.8;
            color: #334155;
            margin-top: 20px;
        }

        .doc-supplier-info p {
            margin: 3px 0;
            display: flex;
        }

        .doc-supplier-info strong {
            font-weight: 600;
            color: #1e293b;
            min-width: 140px;
            display: inline-block;
        }

        .doc-client-box {
            background: linear-gradient(145deg, #ffffff 0%, #f0f4ff 100%);
            padding: 28px 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.8);
            border: 4px solid #667eea;
            text-align: right;
            min-width: 350px;
            position: relative;
            overflow: hidden;
        }

        .doc-client-box::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .doc-client-box p {
            margin: 10px 0;
            font-size: 13px;
            color: #1e293b;
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .doc-client-box strong {
            font-weight: 800;
            color: #4338ca;
            text-shadow: 0 1px 2px rgba(102, 126, 234, 0.2);
            min-width: 140px;
            text-align: right;
        }

        .doc-table{
            width:100%;
            border-collapse:collapse;
            border-spacing:0;
            margin:30px 0;
            box-shadow:none;
            border-radius:0;
        }


        .doc-table th {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
            font-weight: 600;
            text-align: center;
            font-size: 12px;
            padding: 10px 12px;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .doc-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            font-size: 12px;
            background: white;
        }

        .doc-table tbody tr:nth-child(even) td {
            background: #f8fafc;
        }

        .doc-table tbody tr:hover td {
            background: #eff6ff;
        }

        .doc-table .text-right {
            text-align: right;
        }

        .doc-table .text-center {
            text-align: center;
        }

        .total-row {
            font-weight: 600;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
            font-size: 14px !important;
        }

        .total-row td {
            border: 1px solid #f59e0b !important;
            padding: 10px 12px !important;
        }

        .doc-footer {
            margin-top: 40px;
            font-size: 13px;
            line-height: 1.8;
            color: #334155;
        }

        .doc-footer p {
            margin: 15px 0;
        }

        .doc-footer strong {
            color: #1e293b;
            font-weight: 600;
        }

        .signature-area {
            margin-top: 80px;
            text-align: right;
            font-weight: 700;
            color: #1e293b;
            font-size: 14px;
        }

        .doc-number-badge {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            padding: 12px 20px;
            border-radius: 12px;
            border-left: 6px solid #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            margin-top: 20px;
        }

        .doc-number-badge p:first-child {
            margin: 0;
            font-size: 16px;
            font-weight: 900;
            color: #5b21b6;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .doc-number-badge p:last-child {
            margin: 4px 0 0 0;
            font-size: 10px;
            color: #667eea;
            font-weight: 600;
        }

        /*MODAL Aperçu*/
        .modal-overlay{
            position:fixed;
            inset:0;
            background:rgba(15,23,42,0.45);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:2000;
        }

        .modal {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 24px 60px rgba(15,23,42,0.45);
            width: min(700px, 90vw); /* Default pour autres modals */
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ✅ VAOVAO - Style spécial pour modal comparaison */
        #comparaison-modal .modal {
            width: min(1100px, 95vw) !important; /* Plus large */
            max-height: 90vh;
        }

        #comparaison-modal .modal-body {
            padding: 20px 24px;
            overflow-y: auto;
            overflow-x: hidden; /* Misoroka scroll horizontal amin'ny modal body */
        }

        #comparaison-modal .modal-table {
            width: 100%;
            min-width: 100%;
            table-layout: auto;
        }

        /* ✅ RESPONSIVE FORM GRID */
        .responsive-form-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 12px;
        }

        @media (min-width: 641px) {
            .grid-3-cols { grid-template-columns: 2fr 1.2fr 1fr; }
            .grid-2-cols-btn { grid-template-columns: 1fr auto; }
        }

        @media (max-width: 640px) {
            .grid-3-cols, .grid-2-cols-btn { grid-template-columns: 1fr; }
            .grid-2-cols-btn button { width: 100%; }
            
            #comparaison-modal .modal-body {
                padding: 12px;
            }
            
            .modal-table {
                min-width: 100% !important;
                display: block;
                overflow-x: auto;
            }
        }
        
        /* Misoroka ny fifanosin'ny soratra ao anatin'ny tabilao */
        .modal-table th, .modal-table td {
            white-space: nowrap;
            min-width: 100px;
        }


        .modal-header{
            padding:14px 18px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom:1px solid #e5e7eb;
            background:#111827;
            color:#f9fafb;
        }

        .modal-header h3{
            font-size:16px;
            font-weight:600;
        }

        .modal-close{
            border:none;
            background:transparent;
            color:#f9fafb;
            font-size:22px;
            cursor:pointer;
        }

        .modal-body{
            padding:16px 18px 18px;
            overflow:auto;
        }

        .modal-info{
            margin-bottom:10px;
            font-size:13px;
            color:#4b5563;
        }

        .modal-table{
            width:100%;
            min-width: 100%;
            border-collapse:collapse;
            background:white;
        }
        
        @media (max-width: 640px) {
            .modal-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        .modal-table th,
        .modal-table td{
            padding:8px 10px;
            border:1px solid #e5e7eb;
            font-size:12px;
        }

        .modal-table th{
            background:#111827;
            color:#f9fafb;
            text-align:left;
        }

        /*DASHBOARD*/
        .app-mark{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            width:34px; height:34px;
            margin-right:10px;
            border-radius:999px;
            background:#111827;
            color:#fff;
            font-family:'Pacifico', cursive;
            font-weight:400;
            font-size:20px;
        }

        .sidebar-logo{
            font-family:'Pacifico', cursive;
            font-weight:400;
            letter-spacing:0.5px;
        }

        #dashboard-tab .dash-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 14px;
            overflow: visible;      /* ← AMPIO IO */
            padding-top: 6px;       /* ← AMPIO IO */
        }


        #dashboard-tab .dash-top h2{
            margin:0;
            font-size:26px;
            font-weight:800;
            color:#0f172a;
        }
        #dashboard-tab .dash-top p{ margin:6px 0 0 0; color:#64748b; font-size:13px; }

        .dash-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: visible;
            padding-top: 8px;      /* ← Ampio padding ambony */
            padding-right: 8px;    /* ← Ampio padding ankavanana */
        }

        .icon-btn {
            width:36px;height:36px;border-radius:12px;
            border:1px solid #e5e7eb; background:#fff; cursor:pointer;
            display:flex;align-items:center;justify-content:center; position: relative;  /* ← Très important! */
        }
        .icon-btn i{ color:#0f172a; }

        .user-chip{ display:flex; align-items:center; gap:10px; padding-left:6px; }
        .user-avatar{
            width:40px;height:40px;border-radius:999px;
            background:#0f172a;color:#fff;font-weight:800;
            display:flex;align-items:center;justify-content:center; 
        }

        /* Bouton mini (pour stock lots details) */
        .btn-mini {
            background: white;
            color: #111827;
            border: 1px solid #e5e7eb;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            font-weight: 600;
        }

        .btn-mini:hover {
            background: #111827;
            color: white;
            border-color: #111827;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(17, 24, 39, 0.25);
        }

        .dash-layout{
            display:grid;
            grid-template-columns: 1.9fr 1fr;
            gap:14px;
        }

        .dash-cards{
            display:grid;
            grid-template-columns: repeat(4, minmax(140px, 1fr));
            gap:12px;
            margin-bottom:12px;
        }
        .dash-card{
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            padding: 14px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            overflow: visible !important;
            position: relative;
            transition: all 0.3s ease;
        }

        .dash-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            background: rgba(248, 250, 252, 0.95);
        }
        .dash-card-icon{
            width:38px;height:38px;border-radius:14px;
            background:#eef2ff; color:#111827;
            display:flex;align-items:center;justify-content:center;
            margin-bottom:10px;
        }
        .dash-card-kpi{ font-size:20px; font-weight:900; color:#0f172a; }
        .dash-card-label{ margin-top:4px; font-size:12px; color:#64748b; font-weight:700; }

        .dash-card:nth-child(2) {
            z-index: 10 !important;
            position: relative;
        }

        .dash-panel{
            background:#ebf0f2;
            border:1px solid #e5e7eb;
            border-radius:18px;
            padding:14px;
            box-shadow:0 10px 24px rgba(15,23,42,0.08);
        }
        .dash-panel-title{ font-weight:900; color:#0f172a; }
        .dash-panel-sub{ font-size:12px; color:#7e9eaf; margin-top:2px; }
        .dash-chart-wrap{ height:230px; margin-top:10px; }
        #dash-chart{ width:100%; height:100%; }

        .dash-mini{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap:12px;
            margin-top:12px;
        }
        .dash-mini-card{
            background: #f7f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            padding: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            z-index: 1 !important;
            overflow: visible !important;
            position: relative;
        }

        .dash-mini-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            background: #ebf0f2;
        }
        .dash-mini-title{ color:#64748b; font-weight:800; font-size:12px; }
        .dash-mini-kpi{ margin-top:6px; font-size:18px; font-weight:700; color:#0f172a; line-height: 1.2;
    letter-spacing: -0.5px; }

        .dash-right{ display:flex; flex-direction:column; gap:12px; }
        .dash-right-card{
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            padding: 14px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }

        .dash-right-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            background: rgba(248, 250, 252, 0.95);
        }

        .dash-right-card.dash-right-dark:hover {
            background: #0b1220;
        }
        .dash-right-dark{
            background:#0b1220;
            color:#fff;
            border:1px solid rgba(255,255,255,0.08);
        }
        .dash-right-dark .dash-right-title,
        .dash-right-dark .dash-right-sub{ color:#fff; }
        .dash-right-title{ font-weight:900; color:#0f172a; }
        .dash-right-sub{ margin-top:6px; font-size:12px; color:#64748b; }

        .progress-bar{
            margin-top:12px;
            height:10px;
            background:rgba(255,255,255,0.15);
            border-radius:999px;
            overflow:hidden;
        }
        .progress-fill{
            height:100%;
            width:0%;
            background:linear-gradient(90deg, #60a5fa, #3b82f6);
            border-radius:999px;
            transition: width .6s ease;
        }

        .todo{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
        .todo-item{ display:flex; gap:8px; align-items:center; padding: 6px 0; color:#0f172a; font-weight:700; font-size:13px; }
        .todo-ic{
            width:24px;height:24px;border-radius:14px;
            background:#eef2ff;
            display:flex;align-items:center;justify-content:center; color: #4f46e5;
            font-size: 12px;
        }

        .todo-text.done {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .todo-actions {
            margin-left: auto;
            display: flex;
            gap: 12px;
        }

        .todo-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            color: #9ca3af;
            font-size: 14px;  /* Augmenté */
            padding: 8px;  /* NOUVEAU: Zone tactile agrandie */
            min-width: 36px;  /* NOUVEAU: Largeur minimale */
            min-height: 28px;  /*NOUVEAU: Hauteur minimale */
            display: flex;  /* NOUVEAU: Pour centrer l'icône */
            align-items: center;
            justify-content: center;
            border-radius: 8px;  /* NOUVEAU: Coins arrondis */
            transition: all 0.2s;  /* NOUVEAU: Animation douce */
        }


        .todo-btn:hover {
            color: #111827;
            background: #f3f4f6;
        }
        .dash-chart-wrap{ position:relative; height:260px; }
        #dash-chart{ width:100%; height:100%; display:block; }
        .dash-tooltip{
            position:absolute;
            background:#0b1220;
            color:#fff;
            padding:10px 12px;
            border-radius:12px;
            font-size:12px;
            line-height:1.25;
            box-shadow:0 10px 24px rgba(0,0,0,.25);
            pointer-events:none;
            transform:translate(-50%, -110%);
            white-space:nowrap;
        }
        .dash-tooltip .small{ color:#cbd5e1; font-size:11px; display:block; margin-top:4px; }

        .dash-layout{
            display:flex;
            gap:16px;
            align-items:flex-start;
        }

        .dash-main{
            flex:1;
            min-width:0; /* important: misoroka overflow */
        }

        .dash-right{
            flex:0 0 340px;     /* largeur fixe droite */
            width:340px;
        }

            /* Rehefa mobile/tablet: ampilatsaho ambany */
        @media (max-width: 992px){
            .dash-layout{ flex-direction:column; }
            .dash-right{ width:100%; flex-basis:auto; }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(17, 24, 39, 0.2);
            }
            50% {
                box-shadow: 0 4px 16px rgba(17, 24, 39, 0.4);
            }
        }

        .btn-icon-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .btn-icon-pulse:hover {
            animation: none;
        }

        /* photo de profil Avatar*/
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 999px;
            object-fit: cover;
            display: block;
        }

        .user-chiphover .user-avatar {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(17, 24, 39, 0.3);
            transition: all 0.2s;
        }

        /* Logo image ao anatin'ny app-mark sy sidebar-logo */
        .app-mark img,
        .sidebar-logo img {
            width: 100%;
            height: 100%;
            border-radius: 999px;
            object-fit: cover;
            display: block;
        }

        .app-markhover,
        .sidebar-logohover {
            transform: scale(1.05);
            transition: all 0.2s;
        }

        /* NOTIFICATIONS */
        /* Badge rouge */
        .notif-badge {
            position: absolute;
            top: -4px;           /* ← Juste en haut du bouton */
            right: -4px;         /* ← Juste à droite du bouton */
            background: #dc2626;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 999px;
            min-width: 16px;
            height: 16px;
            line-height: 12px;
            text-align: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.25);
            border: 2px solid white;  /* Cadre blanc pour bien le voir */
        }


        /* Dropdown */
        .notif-dropdown {
            position: absolute;
            top: 50px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 12px 36px rgba(0,0,0,0.2);
            z-index: 9999;
            max-height: 400px;
            overflow: hidden;
        }

        .notif-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        .notif-header button {
            background: none;
            border: none;
            color: #2563eb;
            font-size: 12px;
            cursor: pointer;
        }

        .notif-list {
            max-height: 340px;
            overflow-y: auto;
        }

        .notif-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notif-item:hover {
            background: #ffffff;
        }

        .notif-item.error { border-left: 4px solid #dc2626; }
        .notif-item.warning { border-left: 4px solid #f59e0b; }
        .notif-item.success { border-left: 4px solid #16a34a; }

        .notif-titre {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .notif-message {
            font-size: 12px;
            color: #6b7280;
        }

        /* Bouton trois points */
        .btn-dots {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-dots:hover {
            background: #f3f4f6;
            color: #111827;
        }

        /* Dropdown menu période */
        .periode-dropdown {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 6px;
            min-width: 200px;
            z-index: 9999 !important;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .periode-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            color: #374151;
        }

        .periode-option:hover {
            background: #ffffff;
            color: #111827;
        }

        .periode-option span {
            font-weight: 500;
        }

        .periode-option i {
            font-size: 14px;
        }

        /* Responsive pour les onglets/tabs */
        
        /* Tabs responsive - éviter débordement horizontal */
        @media (max-width: 768px) {
            .tabs {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 4px;
                padding: 0 4px 6px 4px;
                scroll-snap-type: x mandatory;
                max-width: 100vw;
            }

            .tabs::-webkit-scrollbar {
                height: 2px;
            }

            .tabs::-webkit-scrollbar-thumb {
                background: #d1d5db;
                border-radius: 2px;
            }

            .tab {
                font-size: 11px !important;
                padding: 6px 10px !important;
                min-width: auto !important;
                flex: 0 0 auto;
                white-space: nowrap;
                scroll-snap-align: start;
                max-width: 140px;
            }
            .periode-dropdown {
                right: -10px;
                min-width: 180px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            }
        }

        @media (max-width: 480px) {
            .tab {
                font-size: 10px !important;
                padding: 5px 8px !important;
                max-width: 110px;
            }
            .periode-dropdown {
                right: -5px;
                min-width: 160px;
                max-width: 200px;
            }
        }

        @media (max-width: 480px) {
            #actions-urgentes-container {
                margin-bottom: 12px !important;
            }
            
            #actions-urgentes-container > div {
                padding: 12px !important;
            }
        }

        /* ✅ MOBILE GLOBAL (< 480px) - Redmi et autres Android */
        @media (max-width: 480px) {
            html, body {
                overflow-x: hidden;
                max-width: 100vw;
                width: 100%;
            }

            .sidebar {
                width: 0;
                overflow: hidden;
            }

            .sidebar.open {
                width: 200px;
            }

            .main-wrapper {
                margin-left: 0;
                padding: 4px !important;  /* 8px → 4px */
                width: 100%;
                max-width: 100vw;
                box-sizing: border-box;
            }

            .container {
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
                width: 100%;
                max-width: 100%;
                margin: 0;
            }

            .header {
                padding: 12px 8px 8px 8px !important;
            }

            .header h1 {
                font-size: 16px !important;
            }

            .header p {
                font-size: 11px !important;
            }

            .content {
                padding: 6px !important;  /* 10px → 6px */
                width: 100%;
                box-sizing: border-box;
            }

            .form-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px;
                }

            /* Responsive pour tablettes et petits écrans landscape */
            @media (max-width: 900px) {
                .form-grid {
                    grid-template-columns: 1fr 1fr;
                }
            }

            /* Responsive pour mobiles portrait */
            @media (max-width: 600px) {
                .form-grid {
                    grid-template-columns: 1fr;
                }
            }


            .form-section {
                padding: 8px !important;
                border-radius: 10px;
                margin-bottom: 10px;
            }

            .form-section h3 {
                font-size: 13px !important;
                margin-bottom: 8px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 7px 8px !important;
                font-size: 12px !important;
            }

            .btn,
            .btn-primary,
            .btn-success,
            .btn-pdf,
            .btn-info {
                padding: 6px 10px !important;
                font-size: 11px !important;
                white-space: nowrap;
            }

            .action-buttons {
                flex-direction: column;
                gap: 6px;
                width: 100%;
            }

            .action-buttons button {
                width: 100%;
                justify-content: center;
            }

            /* Dashboard */
            .dash-top {
                flex-direction: column;
                gap: 10px;
            }

            .dash-top h2 {
                font-size: 18px !important;
            }

            .dash-actions {
                flex-wrap: wrap;
                gap: 6px;
            }

            .dash-cards {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px;
            }

            .dash-card {
                padding: 10px !important;
            }

            .dash-card-kpi {
                font-size: 16px !important;
            }

            .dash-card-label {
                font-size: 11px !important;
            }

            .dash-layout {
                flex-direction: column;
                gap: 10px;
            }

            .dash-right {
                width: 100% !important;
                margin-top: 10px;
            }

            .dash-chart-wrap {
                height: 180px !important;
            }

            .dash-mini {
                grid-template-columns: 1fr !important;
            }

            /* Tables */
            table {
                font-size: 11px !important;
                width: 100%;
                display: table !important; /* Force table layout */
                border-collapse: collapse;
                table-layout: auto;
            }

            .tab-content {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }

            thead, tbody, tfoot {
                display: table-header-group;
                width: auto;
            }

            tr {
                display: table-row;
            }

            th, td {
                display: table-cell !important;
                padding: 8px 6px !important;
                white-space: nowrap;
                vertical-align: middle;
            }

            /* Fix alignment for specific columns on mobile */
            th[style*="text-align:right"], 
            td[style*="text-align:right"] {
                text-align: right !important;
            }

            /* Stats cards */
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }

            .stat-card {
                padding: 10px !important;
            }

            /* Search box */
            .search-box {
                flex-direction: column;
                gap: 6px;
            }

            .search-box input,
            .search-box select {
                width: 100%;
            }

            /* Logo */
            .logo-upload {
                padding: 8px !important;
                border-radius: 10px;
            }

            .logo-preview {
                max-width: 100px !important;
                max-height: 50px !important;
            }

            /* Modals */
            .modal {
                width: 95vw !important;
                max-width: 95vw !important;
                max-height: 85vh;
                margin: 0 auto;
            }

            .modal-body {
                padding: 10px !important;
            }

            /* Compact buttons */
            .btn-compact {
                padding: 4px 6px !important;
                font-size: 10px !important;
                gap: 2px;
            }

            .btn-compact i {
                font-size: 11px !important;
            }

            .btn-icon {
                width: 28px !important;
                height: 28px !important;
                font-size: 12px !important;
            }

            /* User avatar */
            .user-avatar {
                width: 28px !important;
                height: 28px !important;
                font-size: 12px !important;
            }

            /* Pagination */
            .pagination-wrapper {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 6px !important;
            }

            .pagination-controls {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 4px;
            }

            .pagination-btn {
                width: 28px !important;
                height: 28px !important;
                font-size: 11px !important;
            }

            .pagination-info {
                font-size: 10px !important;
            }

            .page-size-selector {
                width: 100%;
                flex-wrap: wrap;
                gap: 6px;
            }

            .page-size-selector select {
                max-width: 100px;
                font-size: 11px !important;
                padding: 4px 6px !important;
            }

            /* Suggestions box */
            #suggestions-box {
                max-height: 150px !important;
                font-size: 11px !important;
            }

            .suggestion-item {
                padding: 6px !important;
            }

            /* Scan section */
            #scan-progress {
                margin-top: 10px;
            }

            #scan-preview img {
                max-height: 200px !important;
            }
        }

        /* ✅ TABLETTES (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .sidebar.open {
                width: 200px;
            }

            .main-wrapper {
                margin-left: 60px;
                padding: 12px;
            }

            .dash-cards {
                grid-template-columns: repeat(3, 1fr);
            }

            .dash-layout {
                flex-direction: column;
            }

            .dash-right {
                width: 100%;
                margin-top: 12px;
            }

            .tabs {
                flex-wrap: wrap;
                padding: 0 8px 8px;
            }

            .tab {
                min-width: 70px;
                flex: 0 0 auto;
            }
        }

        /* Responsive Dashboard header */
        @media (max-width: 820px) {
            #dashboard-tab .dash-top {
                flex-direction: column;
                gap: 10px;
                padding-top: 0 !important;
            }
            
            #dashboard-tab .dash-top h2 {
                font-size: 20px !important;
            }
            
            .dash-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                padding-top: 0 !important;
            }
            
            .user-chip {
                order: -1;
            }
        }

        /* PAGINATION */
        .pagination-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding: 8px 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }

        .pagination-info {
            font-size: 12px;
            color: #6b7280;
        }

        .pagination-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .pagination-btn {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #111827;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .page-size-selector select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 12px;
        }
        .pagination-btn:hover:not(:disabled) {
            background: #111827;
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #111827;
            color: white;
            font-weight: 600;
        }

        /* Mobile: pagination en colonne pour éviter le dépassement */
        @media (max-width: 480px) {
            .pagination-wrapper {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .pagination-controls {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .pagination-info {
                font-size: 11px;
            }

            .page-size-selector {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
                gap: 6px;
            }

            .page-size-selector select {
                max-width: 120px;
            }
        }

        /* Style select type calcul */
        #marge-type {
            font-weight: 600;
            background: #ffffff;
            border: 1px solid #d1d5db;
            padding: 9px 11px;
            border-radius: 10px;
            cursor: pointer;
        }

        #marge-type:focus {
            outline: none;
            border-color: #111827;
            background: white;
            box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.1);
        }

        #marge-help {
            font-style: italic;
        }

    
        /* Fix for grid on large screens */
        @media (min-width: 1200px) {
            .form-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }
        
        /* Specific fix for "Ajouter un article" in Vente */
        #vente-tab .form-section:nth-child(2) .form-grid {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }

        /* Soften the cards and sections */
        .form-section {
            background-color: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03) !important;
        }
        
        .stat-card {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
        }

        .container {
            background: #f8fafc !important;
        }

        .content {
            background: #f1f5f9 !important;
        }

        /* Input focus improvement */
        .form-group input:focus, .form-group select:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Sidebar toggle visibility */
        .sidebar-toggle {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            color: #1e293b !important;
        }
    
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(248,250,252,0.9);
            border-radius: 24px;
            box-shadow: 0 18px 45px rgba(15,23,42,0.18);
            overflow: hidden;
            width: 100%;
        }

        /* Responsive container */
        @media (max-width: 820px) {
            .container {
                border-radius: 16px;
                width: calc(100% - 8px);
                margin: 0 4px;
            }
            
            .main-wrapper {
                padding: 8px !important;
            }
        }

        /* ========== RESPONSIVE VENTE FORM ========== */

        /* Classes spécifiques pour contrôle colonnes */
        .vente-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr !important;
            gap: 10px;
        }

        .vente-grid-couts {
            display: grid;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 10px;
        }

        /* Tablettes et petits paysage (jusqu'à 900px) */
        @media (max-width: 900px) {
            /* Détails coûts passent en 1 colonne */
            .vente-grid-couts {
                grid-template-columns: 1fr !important;
            }
            
            /* Garde 2 colonnes pour stock/quantité */
            .vente-grid-2 {
                grid-template-columns: 1fr 1fr !important;
            }
        }

        /* iPhone X landscape et similaires (jusqu'à 820px) */
        @media (max-width: 820px) {
            /* Tout passe en 1 colonne */
            .vente-grid-2 {
                grid-template-columns: 1fr !important;
            }
            
            .vente-grid-couts {
                grid-template-columns: 1fr !important;
            }
            
            /* Forcer form-grid normal en 1 colonne */
            #vente-tab .form-section .form-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Améliorer lisibilité mobile */
            #vente-tab .form-group input,
            #vente-tab .form-group select,
            #vente-tab .form-group textarea {
                font-size: 14px;
                padding: 11px 12px;
                min-height: 42px;
            }
            
            #vente-tab .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }
        }

        /* Mobiles portrait (jusqu'à 600px) */
        @media (max-width: 600px) {
            /* Sécurité: tout en 1 colonne */
            #vente-tab .form-grid,
            .vente-grid-2,
            .vente-grid-couts {
                grid-template-columns: 1fr !important;
            }
            
            /* Inputs plus grands pour touch */
            #vente-tab .form-group input,
            #vente-tab .form-group select {
                font-size: 16px; /* Évite zoom automatique iOS */
                padding: 12px;
                min-height: 44px;
            }
        }

        /* ========== RESPONSIVE TABS & HEADER ========== */

        /* Tablettes et petits paysages (jusqu'à 900px) */
        @media (max-width: 900px) {
            .header h1 {
                font-size: 20px !important;
            }
            
            .header p {
                font-size: 12px !important;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 16px 10px 16px;
                gap: 4px;
                scrollbar-width: thin;
            }
            
            .tab {
                font-size: 12px !important;
                padding: 7px 12px !important;
                white-space: nowrap;
                flex-shrink: 0;
            }
        }

        /* iPhone X landscape et similaires (jusqu'à 820px) */
        @media (max-width: 820px) {
            /* Header plus compact */
            .header {
                padding: 14px 16px 8px 16px !important;
            }
            
            .header h1 {
                font-size: 18px !important;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            /* Logo app plus petit */
            .app-mark {
                width: 28px !important;
                height: 28px !important;
                font-size: 16px !important;
                margin-right: 6px !important;
            }
            
            .header p {
                font-size: 11px !important;
                display: none; /* Cache le sous-titre */
            }
            
            /* Tabs scrollables */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 12px 8px 12px !important;
                gap: 3px;
                display: flex;
                flex-wrap: nowrap;
            }
            
            .tab {
                font-size: 11px !important;
                padding: 6px 10px !important;
                white-space: nowrap;
                flex: 0 0 auto;
                min-width: fit-content;
            }
            
            /* Scrollbar styling */
            .tabs::-webkit-scrollbar {
                height: 3px;
            }
            
            .tabs::-webkit-scrollbar-track {
                background: #e5e7eb;
                border-radius: 3px;
            }
            
            .tabs::-webkit-scrollbar-thumb {
                background: #9ca3af;
                border-radius: 3px;
            }
        }

        /* Mobiles portrait (jusqu'à 600px) */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 16px !important;
            }
            
            .app-mark {
                width: 24px !important;
                height: 24px !important;
                font-size: 14px !important;
            }
            
            .tabs {
                padding: 0 8px 6px 8px !important;
            }
            
            .tab {
                font-size: 10px !important;
                padding: 5px 8px !important;
            }
        }

        /* Styles responsive pour to-do list mobile */
        @media (max-width: 640px) {
            .todo-actions {
                gap: 16px;  /* Encore plus d'espace sur mobile */
            }
            
            .todo-btn {
                min-width: 40px;  /* 40×40px pour mobile */
                min-height: 40px;
                padding: 10px;
                font-size: 15px;
            }
            
            .todo-item {
                padding: 10px 0;  /* Plus d'espace vertical */
            }
        }

        /* =====================================================
        RECHERCHE INTELLIGENTE - Badge et Highlight
        ===================================================== */

        /* Badge compteur de résultats */
        .result-badge {
            background: #111827;
            color: #fff;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 10px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Highlight des résultats de recherche */
        mark {
            background: #fef08a;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 700;
        }

        /* Filtres rapides */
        .quick-filters {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid;
        }

        .filter-chip:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* ========== MODAL SÉLECTION FORMAT IMPRESSION ========== */
        .format-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }

        .format-modal-overlay.active {
            display: flex;
        }

        .format-modal {
            background: white;
            border-radius: 20px;
            padding: 35px;
            width: 550px;
            max-width: 90vw;
            box-shadow: 0 24px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .format-modal h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .format-modal > p {
            color: #6b7280;
            margin-bottom: 25px;
            font-size: 14px;
        }

        .format-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 25px;
        }

        .format-card {
            border: 3px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }

        .format-card:hover {
            border-color: #3b82f6;
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(59,130,246,0.25);
        }

        .format-card.selected {
            border-color: #3b82f6;
            background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: 0 8px 20px rgba(59,130,246,0.3);
        }

        .format-card.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: #3b82f6;
            color: white;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .format-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #3b82f6;
        }

        .format-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #111827;
        }

        .format-desc {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.5;
        }

        .format-size {
            display: inline-block;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #4b5563;
            margin-top: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        /* Responsive mobile */
        @media (max-width: 600px) {
            .format-modal {
                padding: 25px;
                width: 95vw;
            }
            
            .format-options {
                grid-template-columns: 1fr;
            }
            
            .format-icon {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo" id="sidebar-logo-mark" onclick="ouvrirUploadAppLogo()" style="cursor:pointer; position:relative; overflow:hidden;">
            M
        </div>

        <button class="sidebar-toggle" onclick="toggleSidebar(this)">
            <i class="fa-solid fa-chevron-right"></i>
        </button>

        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <button class="sidebar-link active" onclick="sidebarShowTab('dashboard', this)">
                    <i class="fa-solid fa-chart-line"></i>
                    <span class="sidebar-text">Dashboard</span>
                </button>
            </li>

            <li class="sidebar-item">
                <button class="sidebar-link" onclick="sidebarShowTab('demande-prix', this)">
                    <i class="fa-solid fa-scale-balanced"></i>
                    <span class="sidebar-text">Demande Prix</span>
                </button>
            </li>

            <li class="sidebar-item">
                <button class="sidebar-link" onclick="sidebarShowTab('achat', this)">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span class="sidebar-text">Achat</span>
                </button>
            </li>
            <li class="sidebar-item">
                <button class="sidebar-link" onclick="sidebarShowTab('vente', this)">
                    <i class="fa-solid fa-cash-register"></i>
                    <span class="sidebar-text">Vente</span>
                </button>
            </li>
            <li class="sidebar-item">
                <button class="sidebar-link" onclick="sidebarShowTab('stock', this)">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    <span class="sidebar-text">Stock</span>
                </button>
            </li>
            <li class="sidebar-item">
                <button class="sidebar-link" onclick="sidebarShowTab('historique', this)">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span class="sidebar-text">Historique</span>
                </button>
            </li>
            <li class="sidebar-item">
                <button class="sidebar-link" onclick="sidebarShowTab('config', this)">
                    <i class="fa-solid fa-gear"></i>
                    <span class="sidebar-text">Configuration</span>
                </button>
            </li>
        </ul>
    </aside>

    <!-- MAIN WRAPPER manomboka eto, batch manaraka no ao anatiny -->
    <div class="main-wrapper">
        <div class="container">
            <div class="header">
                <h1>
                    <span class="app-mark" id="app-logo-mark" onclick="ouvrirUploadAppLogo()" style="cursor:pointer; position:relative; overflow:hidden;">
                        M
                    </span> 
                    Gestion Achat/Vente
                </h1>

                <!-- Input invisible pour logo app -->
                <input type="file" id="app-logo-input" accept="image/*" style="display:none;">

                <p>Gestion complète avec génération PDF automatique</p>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('dashboard', this)">Dashboard</button>
                <button class="tab" onclick="showTab('demande-prix', this)">Demande Prix</button>
                <button class="tab" onclick="showTab('achat', this)">🛒 Achat</button>
                <button class="tab" onclick="showTab('vente', this)">🛍️ Vente</button>
                <button class="tab" onclick="showTab('stock', this)">📦 Stock</button>
                <button class="tab" onclick="showTab('historique', this)">📋 Historique</button>
                <button class="tab" onclick="showTab('config', this)">⚙️ Configuration</button>
            </div>
            
            <div class="content">
                <!-- TAB DASHBOARD -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="dash-top">
                        <div>
                            <h2 id="dash-title">Good morning!</h2>
                            <p id="dash-subtitle">Vue rapide de l'activité.</p>
                        </div>

                        <div class="dash-actions">
                            <button class="icon-btn" id="dash-calendar-btn" title="Calendrier" onclick="ouvrirDatePicker()">
                                <i class="fa-regular fa-calendar"></i>
                            </button>
                            <!-- ⭐ Date picker invisible -->
                            <input type="date" id="dash-date-picker" style="visibility:hidden; position:absolute; left:-9999px; top:-9999px; opacity:0; pointer-events:none;">
                            
                            <button class="icon-btn" title="Messages"><i class="fa-regular fa-comment-dots"></i></button>
                            <button class="icon-btn" id="notif-btn" title="Notifications" onclick="toggleNotifications()">
                                <i class="fa-regular fa-bell"></i>
                                <span class="notif-badge" id="notif-count" style="display:none;">0</span>
                            </button>
                            
                            <!-- DROPDOWN NOTIFICATIONS -->
                            <div id="notif-dropdown" class="notif-dropdown" style="display:none;">
                                <div class="notif-header">
                                    <span>Notifications</span>
                                    <button onclick="marquerToutLu()">✓ Tout marquer lu</button>
                                </div>
                                <div class="notif-list" id="notif-list">
                                    <!-- dynamique -->
                                </div>
                            </div>
                            <div class="user-chip" title="User" onclick="ouvrirUploadAvatar()" style="cursor:pointer;">
                                <div class="user-avatar" id="dash-user-avatar">M</div>
                                <!-- Input invisible pour photo -->
                                <input type="file" id="avatar-input" accept="image/*" style="display:none;">
                            </div>

                        </div>
                    </div>

                    <!-- DASHBOARD LAYOUT (COPY-PASTE) -->
                    <div class="dash-layout">

                    <!-- LEFT / MAIN -->
                    <div class="dash-main">

                        <!-- KPI cards -->
                        <div class="dash-cards">
                        <div class="dash-card">
                            <div class="dash-card-icon"><i class="fa-solid fa-wallet"></i></div>
                            <div class="dash-card-kpi" id="kpi-stock-value">0 Ar</div>
                            <div class="dash-card-label">Valeur stock</div>
                        </div>

                        <div class="dash-card">
                            <!-- HEADER: Icône gauche + Bouton droite -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div class="dash-card-icon" style="margin-bottom: 0;">
                                    <i class="fa-solid fa-receipt"></i>
                                </div>
                                <button class="btn-dots" onclick="toggleTransactionsMenu(event)" title="Changer période">
                                    <i class="fa-solid fa-ellipsis-vertical"></i>
                                </button>
                            </div>
                            
                            <!-- BODY: Chiffre + Label -->
                            <div class="dash-card-kpi" id="kpi-transactions-period">0</div>
                            <div class="dash-card-label">Transactions (<span id="transactions-periode-label">30j</span>)</div>
                            
                            <!-- DROPDOWN -->
                            <div class="periode-dropdown" id="transactions-dropdown" style="display: none">
                                <div class="periode-option" onclick="changerPeriodeTransactions(7)">
                                    <span>7 derniers jours</span>
                                    <i class="fa-solid fa-check" id="trans-check-7" style="display:none; color:#16a34a;"></i>
                                </div>
                                <div class="periode-option" onclick="changerPeriodeTransactions(30)">
                                    <span>30 derniers jours</span>
                                    <i class="fa-solid fa-check" id="trans-check-30" style="color:#16a34a;"></i>
                                </div>
                                <div class="periode-option" onclick="changerPeriodeTransactions(90)">
                                    <span>90 derniers jours</span>
                                    <i class="fa-solid fa-check" id="trans-check-90" style="display:none; color:#16a34a;"></i>
                                </div>
                                <div class="periode-option" onclick="changerPeriodeTransactions(365)">
                                    <span>Cette année (365j)</span>
                                    <i class="fa-solid fa-check" id="trans-check-365" style="display:none; color:#16a34a;"></i>
                                </div>
                            </div>
                        </div>


                        <div class="dash-card">
                            <div class="dash-card-icon"><i class="fa-solid fa-box-open"></i></div>
                            <div class="dash-card-kpi" id="kpi-products">0</div>
                            <div class="dash-card-label">Produits</div>
                        </div>

                        <div class="dash-mini-card" style="position: relative;">
                            <!-- Bouton menu position absolute haut droite -->
                            <button class="btn-dots" onclick="togglePeriodeMenu(event)" title="Changer période" 
                                    style="position: absolute; top: 12px; right: 12px; z-index: 10;">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                            <!-- ICÔNE (mitovy amin'ny hafa) -->
                            <div class="dash-card-icon">
                                <i class="fa-solid fa-hand-holding-dollar"></i>
                            </div>
                            <!-- Chiffre principal EN HAUT -->
                            <div class="dash-mini-kpi" id="kpi-sales-period">0 Ar</div>

                            <!-- Évolution -->
                            <div style="font-size: 11px; color: #16a34a; margin-top: 4px; font-weight: 600;" id="kpi-sales-trend">
                                <!-- ↑ +12% vs période précédente -->
                            </div>
                            
                            <!-- Label EN BAS (comme les autres) -->
                            <div class="dash-mini-title" style="margin-top: 8px;">
                                Ventes (<span id="periode-label">30j</span>)
                            </div>

                            
                            <!-- DROPDOWN MENU -->
                            <div class="periode-dropdown" id="periode-dropdown" style="display: none;">
                                <div class="periode-option" onclick="changerPeriode(7)">
                                    <span>7 derniers jours</span>
                                    <i class="fa-solid fa-check" id="check-7" style="display:none; color:#16a34a;"></i>
                                </div>
                                <div class="periode-option" onclick="changerPeriode(30)">
                                    <span>30 derniers jours</span>
                                    <i class="fa-solid fa-check" id="check-30" style="color:#16a34a;"></i>
                                </div>
                                <div class="periode-option" onclick="changerPeriode(90)">
                                    <span>90 derniers jours</span>
                                    <i class="fa-solid fa-check" id="check-90" style="display:none; color:#16a34a;"></i>
                                </div>
                                <div class="periode-option" onclick="changerPeriode(365)">
                                    <span>Cette année (365j)</span>
                                    <i class="fa-solid fa-check" id="check-365" style="display:none; color:#16a34a;"></i>
                                </div>
                            </div>
                        </div>


                        </div>

                        <!-- Revenue panel -->
                        <div class="dash-panel">
                        <div class="dash-panel-head">
                            <div>
                            <div class="dash-panel-title">Revenue</div>
                            <div class="dash-panel-sub">Last 7 days vs prior week</div>
                            </div>
                        </div>

                        <div class="dash-chart-wrap">
                            <svg id="dash-chart" viewBox="0 0 700 260" preserveAspectRatio="none"></svg>
                            <div id="dash-tooltip" class="dash-tooltip" style="display:none"></div>
                        </div>
                        </div>

                        <!-- Mini cards row -->
                        <div class="dash-mini">
                        <div class="dash-mini-card">
                            <div class="dash-mini-title">New clients</div>
                            <div class="dash-mini-kpi" id="kpi-clients-30d">0</div>
                        </div>
                        </div>

                    </div>
                    <!-- /dash-main -->

                    <!-- RIGHT COLUMN -->
                    <aside class="dash-right">

                        <!-- Stock status card -->
                        <div class="dash-right-card dash-right-dark">
                        <div class="dash-right-title">Stock status</div>
                        <div class="dash-right-sub" id="dash-stock-status">In progress</div>

                        <div class="progress-bar">
                            <div class="progress-fill" id="dash-stock-progress"></div>
                        </div>

                        <button class="btn btn-primary"
                                style="width:100%;justify-content:center;margin-top:12px"
                                onclick="sidebarShowTab('stock', document.querySelector('.sidebar-link[onclick*=&quot;stock&quot;]'))">
                            View stock
                        </button>
                        </div>

                        <!-- To-do list card -->
                        <div class="dash-right-card">
                            <div class="dash-right-title">Your to-do list</div>
                            <div class="dash-right-sub" style="margin-bottom: 8px; font-size: 12px; color:#6b7280;">
                                Planifie et suis tes tâches du jour.
                            </div>

                            <!-- Formulaire ajout tâche -->
                            <div style="display:flex; gap:8px; margin-bottom: 10px;">
                                <input type="text" id="todo-input" placeholder="Nouvelle tâche..."
                                    style="flex:1; padding:7px 10px; border-radius:8px; border:1px solid #d1d5db; font-size:12px;">
                                <button class="btn-compact btn-compact-success" onclick="ajouterTache()">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>

                            <!-- Liste tâches -->
                            <div class="todo" id="todo-list">
                                <!-- Remplie par JS -->
                            </div>
                        </div>


                    </aside>
                    <!-- /dash-right -->

                    </div>
                    <!-- /dash-layout -->

                </div>

                    <!-- TAB DEMANDE PRIX -->
                    <div id="demande-prix-tab" class="tab-content">
                        
                        <!-- Section: Créer nouvelle demande -->
                        <div class="form-section" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b;">
                            <h3>📋 Nouvelle Demande de Prix</h3>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Produit</label>
                                    <input type="text" id="dp-produit" placeholder="Nom du produit">
                                </div>
                                <div class="form-group">
                                    <label>Quantité</label>
                                    <input type="number" id="dp-quantite" min="1" value="1">
                                </div>
                                <div class="form-group">
                                    <label>Unité</label>
                                    <select id="dp-unite">
                                        <option value="Pièce">Pièce</option>
                                        <option value="Pqt">Paquet</option>
                                        <option value="Boite">Boîte</option>
                                        <option value="Carton">Carton</option>
                                        <option value="Kg">Kg</option>
                                        <option value="Litre">Litre</option>
                                        <option value="Metre">Mètre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display:flex; justify-content:flex-end; margin-top:12px;">
                                <button class="btn btn-primary" onclick="creerDemandePrix()">
                                    <i class="fa-solid fa-plus"></i> Créer Demande
                                </button>
                            </div>
                        </div>

                        <!-- Section: Liste demandes -->
                        <div id="dp-liste-section" style="display:none;">
                            <div class="section-title">Demandes en Cours</div>
                            <div class="table-container">
                                <table id="dp-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Produit</th>
                                                <th style="text-align:right;">Quantité</th>
                                                <th style="text-align:right;">Offres</th>
                                                <th style="text-align:right;">Prix Min</th>
                                                <th>Statut</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                    <tbody id="dp-tbody"></tbody>
                                </table>
                            </div>
                                    
                            <!-- Zone filtre & budget -->
                            <div style="margin-top:16px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;">
                                
                                <!-- Filtre demandes -->
                                <div style="display:flex; gap:8px; align-items:center; font-size:13px;">
                                    <span style="font-weight:600; color:#374151;">Afficher :</span>
                                    <select id="dp-filter-statut" onchange="afficherDemandesPrix()" style="padding:6px 10px; border-radius:999px; border:1px solid #d1d5db; font-size:12px; background: #f8fafc;">
                                        <option value="tous">Toutes</option>
                                        <option value="en_attente">En attente</option>
                                        <option value="validé">Validées</option>
                                    </select>
                                </div>

                                <!-- Budget sélection -->
                                <div id="dp-budget-wrap" style="font-size:13px;">
                                    <span style="font-weight:600; color:#374151;">Total articles sélectionnés :</span>
                                    <span id="dp-budget-total" style="font-weight:800; color:#16a34a; margin-left:8px;">0 Ar</span>
                                </div>
                            </div>

                            <!-- Récap des articles sélectionnés -->
                            <div id="dp-selected-wrap" style="margin-top:14px;">
                                <div class="section-title">Articles sélectionnés par fournisseur</div>
                                <div class="table-container">
                                    <table id="dp-selected-table">
                                        <thead>
                                            <tr>
                                                <th>Produit</th>
                                                <th>Quantité</th>
                                                <th>Fournisseur</th>
                                                <th style="text-align:right;">Prix U</th>
                                                <th style="text-align:right;">Total</th>
                                                <th>Statut</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dp-selected-tbody"></tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                    </div>

                <!-- TAB ACHAT -->
                <div id="achat-tab" class="tab-content">
                    <!-- Option 1: Scanner facture -->
                    <div class="form-section" style="background: linear-gradient(135deg, #e0f2fe 0%, #bfdbfe 100%); border: 2px solid #3b82f6;">
                        <h3>📸 Scanner une facture</h3>
                        <div style="text-align: center;">
                            <input type="file" id="facture-scan" accept="image/*,application/pdf" style="display: none" onchange="scannerFacture()">
                            <button class="btn btn-primary" onclick="document.getElementById('facture-scan').click()" style="font-size: 1.1em; padding: 15px 30px;">
                                📷 Scanner ou Uploader une facture
                            </button>
                            <p style="margin-top: 10px; color: #1e40af; font-size: 0.9em;">
                                Prenez une photo ou uploadez une facture pour extraction automatique
                            </p>
                            <div id="scan-progress" style="display: none; margin-top: 15px;">
                                <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <p id="scan-title" style="margin: 0; color: #3b82f6; font-weight: 600;">Analyse en cours...</p>
                                    <div style="width: 100%; background: #e5e7eb; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden;">
                                        <div id="scan-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); transition: width 0.3s;"></div>
                                    </div>
                                    <p id="scan-status" style="margin: 10px 0 0 0; font-size: 0.85em; color: #6b7280;"></p>
                                </div>
                            </div>
                            <div id="scan-preview" style="margin-top: 15px; display: none;">
                                <img id="scan-image" style="max-width: 100%; max-height: 300px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0; font-weight: 600; color: #6b7280;">
                        - OU -
                    </div>
                    
                    <!-- Option 2: Saisie manuelle -->
                    <div class="form-section">
                        <h3>✏️ Saisie manuelle</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>📅 Date</label>
                                <input type="date" id="achat-date">
                            </div>
                            <div class="form-group">
                                <label>🏢 Fournisseur</label>
                                <input type="text" id="achat-fournisseur" placeholder="Nom du fournisseur">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Ajouter un article</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Produit</label>
                                <input type="text" id="achat-produit" placeholder="Description produit">
                            </div>
                            <div class="form-group">
                                <label>Quantité</label>
                                <input type="number" id="achat-quantite" min="1">
                            </div>
                            <div class="form-group">
                                <label>Prix unitaire (Ar)</label>
                                <input type="number" id="achat-prix" min="0">
                            </div>
                            <div class="form-group">
                                <label>Unité</label>
                                <select id="achat-unite">
                                    <option value="Pièce">Pièce</option>
                                    <option value="Pqt">Paquet</option>
                                    <option value="Boite">Boîte</option>
                                    <option value="Carton">Carton</option>
                                    <option value="Lot">Lot</option>
                                    <option value="Kg">Kg</option>
                                    <option value="Litre">Litre</option>
                                    <option value="Mètre">Mètre</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ✅ BOUTON EN BAS À DROITE -->
                        <!-- BOUTON VISIBLE MAIS DOUX -->
                        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
                            <button onclick="ajouterArticleAchat()" 
                                    style="background: #f3f4f6; 
                                        color: #111827; 
                                        border: 2px solid #e5e7eb; 
                                        padding: 10px 18px; 
                                        border-radius: 10px; 
                                        font-size: 13px; 
                                        font-weight: 600; 
                                        cursor: pointer; 
                                        display: flex; 
                                        align-items: center; 
                                        gap: 6px;
                                        transition: all 0.2s;"
                                    onmouseover="this.style.background='#111827'; this.style.color='#fff'; this.style.borderColor='#111827';"
                                    onmouseout="this.style.background='#f3f4f6'; this.style.color='#111827'; this.style.borderColor='#e5e7eb';">
                                <i class="fa-solid fa-plus"></i> Ajouter l'article
                            </button>
                        </div>


                    </div>

                    
                    <div id="achat-articles-section" style="display:none;">
                        <div class="section-title">📋 Articles</div>
                        <div class="table-container">
                            <table id="achat-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantité</th>
                                        <th>Unité</th>
                                        <th>Prix U</th>
                                        <th>Montant</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="achat-tbody"></tbody>
                                <tfoot>
                                    <tr style="background: #fff3cd; font-weight: bold;">
                                        <td colspan="4" style="text-align: right;">TOTAL</td>
                                        <td id="achat-total">0 Ar</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="validerAchat()">✅ Valider l'achat</button>
                        </div>
                    </div>
                </div>

                <!-- TAB VENTE -->
                <div id="vente-tab" class="tab-content">
                    <!-- SECTION 1: Enregistrer une vente -->
                    <div class="form-section">
                        <h3>Enregistrer une vente</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>📅 Date</label>
                                <input type="date" id="vente-date" onchange="genererNumeroVente()">
                            </div>
                            <div class="form-group">
                                <label>👤 Client</label>
                                <input type="text" id="vente-client" placeholder="Nom du client">
                            </div>
                            <div class="form-group">
                                <label>📍 Adresse</label>
                                <input type="text" id="vente-adresse" placeholder="Adresse">
                            </div>
                            <div class="form-group">
                                <label>Délai de paiement (jours)</label>
                                <input type="number" id="vente-delai" min="0" max="365" value="30" placeholder="30">
                                <small style="display:block; margin-top:4px; color:#6b7280; font-size:11px;">
                                    Nombre de jours pour payer la facture
                                </small>
                            </div>
                            <div class="form-group">
                                <label>🔄 Numéro</label>
                                <input type="text" id="vente-numero" readonly style="background: #f0f0f0;">
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: Ajouter un article -->
                    <div class="form-section">
                        <h3>Ajouter un article</h3>
                        
                        <!-- GROUPE 1: Produit (full width) -->
                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <div class="form-group">
                                <label>Produit</label>
                                <div style="position: relative;">
                                    <input type="text" 
                                        id="vente-search" 
                                        placeholder="🔍 Taper pour rechercher..." 
                                        autocomplete="off"
                                        oninput="rechercherProduitDynamique()"
                                        onfocus="afficherSuggestions()"
                                        onblur="cacherSuggestions()">
                                    <div id="suggestions-box" style="display:none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; width: 100%; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 4px;"></div>
                                </div>
                                <input type="hidden" id="vente-produit-selected">
                            </div>
                        </div>
                        
                        <!-- GROUPE 2: Stock & Quantité (2 colonnes) -->
                        <div class="form-grid vente-grid-2">
                            <div class="form-group">
                                <label>Stock disponible</label>
                                <input type="text" id="vente-stock-dispo" readonly>
                            </div>
                            <div class="form-group">
                                <label>Quantité</label>
                                <input type="number" id="vente-quantite" min="1" oninput="updateVenteCostAndMargeUI()">
                            </div>
                        </div>
                        
                        <!-- GROUPE 3: Prix unitaire vente (full width) -->
                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <div class="form-group">
                                <label>Prix unitaire (Ar)</label>
                                <input type="number" id="vente-prix" min="0" oninput="updateVenteCostAndMargeUI()">
                            </div>
                        </div>
                        
                        <!-- GROUPE 4: Détails coûts (3 colonnes sur grand écran, responsive) -->
                        <div class="form-grid vente-grid-couts">
                            <div class="form-group">
                                <label>Prix d'achat unitaire (revient)</label>
                                <input type="text" id="vente-pa-unit" readonly>
                            </div>
                            <div class="form-group">
                                <label>Revient total</label>
                                <input type="text" id="vente-revient-total" readonly>
                            </div>
                            <div class="form-group">
                                <label>Marge totale</label>
                                <input type="text" id="vente-marge-total" readonly>
                            </div>
                        </div>
                        
                        <!-- GROUPE 5: Calcul marge (2 colonnes) -->
                        <div class="form-grid vente-grid-2">
                            <div class="form-group">
                                <label>Type de calcul</label>
                                <select id="marge-type" onchange="changerTypeCalcul()">
                                    <option value="markup">Markup (% sur coût d'achat)</option>
                                    <option value="marge">Marge (% sur prix de vente)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="marge-label">Markup (%)</label>
                                <input type="number" id="vente-marge-pct" min="0" max="200" value="30" oninput="suggestPrixVenteFromMarge()">
                                <small id="marge-help" style="display:block; margin-top:4px; color:#6b7280; font-size:11px;">
                                    Ex: 50% → Prix vente = Prix achat × 1.50
                                </small>
                            </div>
                        </div>
                        
                        <!-- ✅ BOUTON EN BAS À DROITE -->
                        <!-- BOUTON VISIBLE MAIS DOUX -->
                        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
                            <button onclick="ajouterArticleVente()" 
                                    style="background: #f3f4f6; 
                                        color: #111827; 
                                        border: 2px solid #e5e7eb; 
                                        padding: 10px 18px; 
                                        border-radius: 10px; 
                                        font-size: 13px; 
                                        font-weight: 600; 
                                        cursor: pointer; 
                                        display: flex; 
                                        align-items: center; 
                                        gap: 6px;
                                        transition: all 0.2s;"
                                    onmouseover="this.style.background='#111827'; this.style.color='#fff'; this.style.borderColor='#111827';"
                                    onmouseout="this.style.background='#f3f4f6'; this.style.color='#111827'; this.style.borderColor='#e5e7eb';">
                                <i class="fa-solid fa-plus"></i> Ajouter l'article
                            </button>
                        </div>

                    </div>

                    <!-- SECTION 3: Liste articles -->
                    <div id="vente-articles-section" style="display:none;">
                        <div class="section-title">📋 Articles</div>
                        <div class="table-container">
                            <table id="vente-table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantité</th>
                                        <th>Unité</th>
                                        <th>Prix U</th>
                                        <th>Montant</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="vente-tbody"></tbody>
                                <tfoot>
                                    <tr style="background: #fff3cd; font-weight: bold;">
                                        <td colspan="4" style="text-align: right;">TOTAL</td>
                                        <td id="vente-total">0 Ar</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>                        
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="validerVente()">✅ Valider la vente</button>
                            <button class="btn btn-pdf" onclick="genererPDFVente('proforma')">📄 Proforma PDF</button>
                            <button class="btn btn-pdf" onclick="genererPDFVente('facture')">📄 Facture PDF</button>
                            <button class="btn btn-info" onclick="genererPDFVente('bon')">📄 Bon de livraison PDF</button>
                        </div>
                    </div>
                </div>
                <!-- FIN TAB VENTE -->


                <!-- TAB STOCK -->
                <div id="stock-tab" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="stat-produits">0</h3>
                            <p>Produits</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="stat-valeur">0 Ar</h3>
                            <p>Valeur totale</p>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="search-stock" placeholder="🔍 Rechercher produit..." onkeyup="rechercherStock()">
                    </div>
                    
                    <div class="table-container">
                        <table>
                                        <thead>
                                            <tr>
                                                <th>Produit</th>
                                                <th style="text-align:right;">Quantité</th>
                                                <th>Unité</th>
                                                <th style="text-align:right;">Prix Moyen</th>
                                                <th style="text-align:right;">Valeur</th>
                                                <th>Statut</th>
                                            </tr>
                                        </thead>
                            <tbody id="stock-tbody"></tbody>
                        </table>
                    </div>
                    <div id="stock-pagination"></div>
                </div>
                
                <!-- TAB HISTORIQUE -->
                <div id="historique-tab" class="tab-content">
                    <div class="search-box">
                        <input type="text" id="search-historique" 
                            placeholder="🔍 Rechercher par date, client, produit, n°..." 
                            onkeyup="rechercherHistoriqueDebounced()">

                        <select id="filter-type" onchange="filtrerHistorique()">
                            <option value="tous">Tous</option>
                            <option value="achat">Achats</option>
                            <option value="vente">Ventes</option>
                        </select>

                        <button class="btn btn-info" onclick="exporterResultatsRecherche()" title="Exporter les résultats">
                            <i class="fa-solid fa-download"></i> Exporter
                        </button>
                    </div>

                    <!-- NOUVEAU: Filtres rapides -->
                    <div class="quick-filters">
                        <button class="filter-chip" onclick="appliquerFiltreRapide('impayé')" 
                                style="background:#fee2e2; color:#991b1b; border-color:#dc2626;">
                            💳 Impayés
                        </button>
                        <button class="filter-chip" onclick="appliquerFiltreRapide('payé')" 
                                style="background:#dcfce7; color:#166534; border-color:#16a34a;">
                            ✓ Payés
                        </button>
                        <button class="filter-chip" onclick="appliquerFiltreRapide('aujourdhui')" 
                                style="background:#eff6ff; color:#1e40af; border-color:#3b82f6;">
                            📅 Aujourd'hui
                        </button>
                        <button class="filter-chip" onclick="appliquerFiltreRapide('semaine')" 
                                style="background:#f5f3ff; color:#6b21a8; border-color:#9333ea;">
                            📊 Cette semaine
                        </button>
                        <button class="filter-chip" onclick="effacerFiltres()" 
                                style="background:#f3f4f6; color:#374151; border-color:#d1d5db;">
                            🔄 Tout effacer
                        </button>
                    </div>

                    
                    <div class="table-container">
                        <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>N°</th>
                                                <th>Tiers</th>
                                                <th style="text-align:right;">Total</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                            <tbody id="historique-tbody"></tbody>
                        </table>
                    </div>
                    <div id="historique-pagination"></div>
                </div>
                
                <!-- TAB CONFIGURATION -->
                <div id="config-tab" class="tab-content">
                    <div class="form-section">
                        <h3>Informations Entreprise</h3>
                        <div class="logo-upload" onclick="document.getElementById('logo-input').click()">
                            <input type="file" id="logo-input" accept="image/*" style="display:none" onchange="chargerLogo()">
                            <img id="logo-preview" class="logo-preview" style="display:none">
                            <p id="logo-text">📁 Logo</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nom entreprise</label>
                                <input type="text" id="config-nom">
                            </div>
                            <div class="form-group">
                                <label>Activité</label>
                                <input type="text" id="config-activite">
                            </div>
                            <div class="form-group">
                                <label>Adresse</label>
                                <input type="text" id="config-adresse">
                            </div>
                            <div class="form-group">
                                <label>NIF</label>
                                <input type="text" id="config-nif">
                            </div>
                            <div class="form-group">
                                <label>STAT</label>
                                <input type="text" id="config-stat">
                            </div>
                            <div class="form-group">
                                <label>RC</label>
                                <input type="text" id="config-rc">
                            </div>
                            <div class="form-group">
                                <label>Responsable</label>
                                <input type="text" id="config-responsable">
                            </div>
                            <div class="form-group">
                                <label>Compte bancaire</label>
                                <input type="text" id="config-banque">
                            </div>
                            <div class="form-group">
                                <label>Mode paiement</label>
                                <input type="text" id="config-paiement">
                            </div>
                            <div class="form-group">
                                <label>Alerte échéance (jours avant)</label>
                                <input type="number" id="config-alerte" min="1" max="90" value="7">
                            </div>
                        </div>
                        
                        <!-- ✅ Message Important Backup -->
                        <div style="background:#fef3c7; border-left:4px solid #f59e0b; padding:12px 16px; border-radius:8px; margin:16px 0;">
                            <strong>⚠️ Important:</strong> Vos données sont stockées localement (localStorage). 
                            Faites un <strong>Backup régulier</strong> pour éviter toute perte de données.
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="sauvegarderConfig()">💾 Sauvegarder Config</button>
                            <button class="btn btn-primary" onclick="exporterDonneesAuto()">📥 Backup Complet</button>
                            <button class="btn btn-info" onclick="document.getElementById('import-file').click()">📤 Importer Backup</button>
                            <button class="btn btn-pdf" onclick="confirmerResetComplet()" style="background: #dc2626;">
                                🗑️ Réinitialiser tout
                            </button>
                            <input type="file" id="import-file" accept=".json" style="display:none" onchange="importerDonnees()">
                        </div>
                    </div>
                </div>

                <!-- zone invisible pour génération PDF -->
                <div id="pdf-preview-container"></div>

            </div> <!-- .content -->
        </div> <!-- .container -->
    </div> <!-- .main-wrapper -->
    <div id="achat-modal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Détail achat</h3>
                <button class="modal-close" onclick="fermerAchatModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="achat-modal-info" class="modal-info"></p>
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Qté</th>
                            <th>Unité</th>
                            <th>Prix U</th>
                            <th>Montant</th>
                        </tr>
                    </thead>
                    <tbody id="achat-modal-tbody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align:right;font-weight:600;">Total</td>
                            <td id="achat-modal-total"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- ✅ MODAL COMPARAISON PRIX - ASIO ETO -->
    <div id="comparaison-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width:900px;">
            <div class="modal-header">
                <h3>⚖️ Comparaison Prix - <span id="comp-produit"></span></h3>
                <button class="modal-close" onclick="fermerComparaisonModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="comp-info" class="modal-info"></p>

                <!-- ✅ Message read-only si validé -->
                <div id="comp-readonly-msg" style="display:none; background:#dcfce7; padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid #16a34a;">
                    <strong>✅ Achat déjà validé</strong><br>
                    <small style="color:#166534;">Stock mis à jour. Consultez l'<a href="#" onclick="sidebarShowTab('historique'); return false;" style="color:#16a34a;">historique</a>.</small>
                </div>

                
                <!-- Ajouter offre -->
                <div id="comp-form-ajout" style="background: #f8fafc; padding:16px; border-radius:8px; margin-bottom:16px;">
                    <!-- Ligne 1: Fournisseur + Prix + Délai -->
                    <div class="responsive-form-grid grid-3-cols">
                        <div class="form-group" style="margin:0;">
                            <label>Fournisseur</label>
                            <input type="text" id="comp-fournisseur" placeholder="Nom fournisseur">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label>Prix Unitaire (Ar)</label>
                            <input type="number" id="comp-prix" min="0" placeholder="0">
                        </div>
                        <div class="form-group" style="margin:0;">
                            <label>Délai (jours)</label>
                            <input type="number" id="comp-delai" min="1" value="3">
                        </div>
                    </div>
                    
                    <!-- Ligne 2: Note + Bouton -->
                    <div class="responsive-form-grid grid-2-cols-btn" style="align-items:end;">
                        <div class="form-group" style="margin:0;">
                            <label>Note (optionnel)</label>
                            <input type="text" id="comp-note" placeholder="Ex: Qualité supérieure, livraison rapide...">
                        </div>
                        <button class="btn btn-primary" onclick="ajouterOffrePrix()" style="height:38px; padding:0 20px;">
                            <i class="fa-solid fa-plus"></i> Ajouter
                        </button>
                    </div>
                </div>
                
                <!-- Tableau comparatif -->
                <div class="table-container" style="margin-top:0; border-radius:8px;">
                    <table class="modal-table" style="min-width:100%; width:max-content;">
                        <thead>
                            <tr>
                                <th style="width:60px; text-align:center;">✓</th>
                                <th style="width:25%;">Fournisseur</th>
                                <th style="width:15%;">Prix U</th>
                                <th style="width:15%;">Total</th>
                                <th style="width:10%;">Délai</th>
                                <th style="width:20%;">Note</th>
                                <th style="width:15%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="comp-tbody"></tbody>
                    </table>
                </div>


                <div style="margin-top:12px; padding:10px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px; font-size:12px; color:#92400e;">
                    <strong>💡 Info:</strong> Choisissez le fournisseur selon vos critères: <strong>prix, qualité, délai, fiabilité</strong>. 
                    Le badge "Prix le plus bas" est indicatif uniquement.
                </div>
                <div style="margin-top:16px; text-align:right;">
                    <button class="btn btn-success" onclick="validerMeilleureOffre()">
                        <i class="fa-solid fa-check"></i> Valider Offre Choisie
                    </button>
                </div>

            </div>
        </div>
    </div>
    
    <!-- MODAL SÉLECTION FORMAT IMPRESSION -->
    <div id="format-modal-overlay" class="format-modal-overlay">
        <div class="format-modal">
            <h2>
                <i class="fa-solid fa-print"></i>
                Choisir le format d'impression
            </h2>
            <p>Sélectionnez le format qui correspond à votre imprimante</p>
            
            <div class="format-options">
                <!-- Option Ticket Thermique -->
                <div class="format-card" onclick="selectFormat('ticket')">
                    <div class="format-icon">🧾</div>
                    <div class="format-name">Ticket Thermique</div>
                    <div class="format-desc">
                        Format compact pour imprimantes de caisse
                    </div>
                    <div class="format-size">80mm de largeur</div>
                </div>
                
                <!-- Option A4 -->
                <div class="format-card" onclick="selectFormat('a4')">
                    <div class="format-icon">📄</div>
                    <div class="format-name">Format A4</div>
                    <div class="format-desc">
                        Facture professionnelle standard
                    </div>
                    <div class="format-size">210 × 297 mm</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeFormatModal()">
                    <i class="fa-solid fa-xmark"></i> Annuler
                </button>
                <button class="btn btn-primary" id="confirm-format-btn" onclick="confirmFormat()" disabled>
                    <i class="fa-solid fa-check"></i> Générer PDF
                </button>
            </div>
        </div>
    </div>
    <!-- CONTENEURS PDF CACHÉS -->
    <!-- Format A4 -->
    <div id="pdf-preview-a4" style="position:fixed; top:-10000px; left:-10000px; width:210mm; background:white; padding:15mm; font-family:Arial,sans-serif;">
        <!-- Sera rempli dynamiquement par JavaScript -->
    </div>

    <!-- Format Ticket -->
    <div id="pdf-preview-ticket" style="position:fixed; top:-10000px; left:-10000px; width:80mm; background:white; padding:5mm; font-family:'Courier New',monospace; font-size:10px;">
        <!-- Sera rempli dynamiquement par JavaScript -->
    </div>
    <script>
        /* ====== SIDEBAR ====== */
        function toggleSidebar(btn){
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('open');

            const icon = btn.querySelector('i');
            if(sb.classList.contains('open')){
                // misokatra: tonga dia mitodika miankavanana (">")
                icon.className = 'fa-solid fa-chevron-left';
            }else{
                // mikatona: mitodika miankavia ("<")
                icon.className = 'fa-solid fa-chevron-right';
            }
        }

        function sidebarShowTab(tabName, btn){
            showTab(tabName);
            document.querySelectorAll('.sidebar-link').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        /* ====== LOGIQUE ORIGINELLE ====== */
 
        let selectedFormat = null; // 'ticket' ou 'a4'
        let currentInvoiceType = null; // 'proforma', 'facture', ou 'bon'
        let currentInvoiceData = null; // Données de la facture en cours
        let stock = {};
        let historique = [];
        let articlesAchat = [];
        let articlesVente = [];
        let config = {
            nom: '',
            activite: '',
            adresse: '',
            nif: '',
            stat: '',
            rc: '',
            responsable: '',
            banque: '',
            paiement: '',
            logo: '',
            alerteEcheance: 7
        };
        let factureAchatDraft = null; // {name, mime, dataUrl, dateUpload}
        let demandesPrix = []; 
        let articlesDP = [];
        // PAGINATION
        let stockPage = 1;
        let stockPerPage = 10;
        let historiquePage = 1;
        let historiquePerPage = 10;
        //✅ FILTRES
        let stockSearchQuery = '';
        let historiqueSearchQuery = '';
        let historiqueTypeFilter = 'tous';
 


        // Window onload
        window.onload = async function() {
            await chargerDonnees();
            updateDashboard();
            drawRevenueChart();
            updateNotificationBadge();
            
            // NOUVEAU : Initialiser les KPI de période
            updateKPITransactionsPeriode();
            updateKPIVentesPeriode();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('achat-date').value = today;
            document.getElementById('vente-date').value = today;
            genererNumeroVente();
            masquerDatePicker();
        };



        function openDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('gestion-av-db', 2); // ✅ Version 2!
                
                req.onupgradeneeded = (e) => {
                    const db = req.result;
                    
                    // Store taloha (factures PDF)
                    if(!db.objectStoreNames.contains('factures')) {
                        db.createObjectStore('factures');
                    }
                    
                    // ✅ VAOVAO - Stores pour données principales
                    if(!db.objectStoreNames.contains('stock')) {
                        db.createObjectStore('stock');
                    }
                    if(!db.objectStoreNames.contains('historique')) {
                        db.createObjectStore('historique');
                    }
                    if(!db.objectStoreNames.contains('config')) {
                        db.createObjectStore('config');
                    }
                    if(!db.objectStoreNames.contains('demandesPrix')) {
                        db.createObjectStore('demandesPrix');
                    }
                };
                
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        // ✅ Save any data to IndexedDB
        async function idbSave(storeName, key, value) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readwrite');
                tx.objectStore(storeName).put(value, key);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        // ✅ Load any data from IndexedDB
        async function idbLoad(storeName, key) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, 'readonly');
                const req = tx.objectStore(storeName).get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function idbPutFacture(key, blob) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('factures', 'readwrite');
                tx.objectStore('factures').put(blob, key);
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }

        async function idbGetFacture(key) {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const tx = db.transaction('factures', 'readonly');
                const req = tx.objectStore('factures').get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function withErrorHandling(asyncFn, successMsg = null) {
            return async function(...args) {
                try {
                    const result = await asyncFn.apply(this, args);
                    if (successMsg) console.log('✅', successMsg);
                    return result;
                } catch (error) {
                    console.error('❌ Erreur:', error);
                    alert('❌ Erreur: ' + (error.message || 'Opération échouée'));
                    return null;
                }
            };
        }

        // Wrappers "safe"
        const idbPutFactureSafe = withErrorHandling(idbPutFacture);
        const ouvrirFactureHistoriqueSafe = withErrorHandling(ouvrirFactureHistorique);
        function showTab(tabName, el) {
            // Tabs ambony
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (el) {
                el.classList.add('active');
            } else {
                const topBtn = document.querySelector(`.tab[onclick*="${tabName}"]`);
                if (topBtn) topBtn.classList.add('active');
            }

            // Sidebar
            document.querySelectorAll('.sidebar-link').forEach(b => b.classList.remove('active'));
            const sideBtn = document.querySelector(`.sidebar-link[onclick*="${tabName}"]`);
            if (sideBtn) sideBtn.classList.add('active');

            // FORCE: afenina daholo
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
                c.style.display = 'none';
            });

            // Ampiseho ilay voafidy
            const target = document.getElementById(tabName + '-tab');
            if (target) {
                target.classList.add('active');
                target.style.display = 'block';
            }

            if (tabName === 'stock') afficherStock();
            if (tabName === 'historique') afficherHistorique();
            if(tabName === 'demande-prix') afficherDemandesPrix();
            if (tabName === 'dashboard') {
                updateDashboard();
                updateKPITransactionsPeriode(); 
                updateKPIVentesPeriode();
                requestAnimationFrame(() => drawRevenueChart());
            }


        }

        //----  -DASHBOARD -------//

        function parseISODate(d){ return new Date(d + "T00:00:00"); }
        function fmtAr(n){ return (Math.round(n)||0).toLocaleString() + " Ar"; }

        function sumStockValue() {
            return Object.values(stock || {}).reduce((s, it) => s + (it.quantite * it.prixMoyen), 0);
        }

        function countProducts() {
            return Object.keys(stock || {}).length;
        }

        function ventesByDay(lastDays) {
            const map = new Map();
            for (let i = lastDays - 1; i >= 0; i--) {
                const dt = new Date(); dt.setDate(dt.getDate() - i);
                const key = dt.toISOString().slice(0,10);
                map.set(key, 0);
            }

            (historique || []).forEach(h => {
                if (h.type !== 'vente') return;
                if (!map.has(h.date)) return;
                map.set(h.date, map.get(h.date) + (h.total || 0));
            });

            return [...map.entries()].map(([date, total]) => ({ date, total }));
        }

        function ventesSumDays(lastDays){
            return ventesByDay(lastDays).reduce((s, x) => s + x.total, 0);
        }

        function countTransactionsDays(lastDays){
            const min = new Date(); min.setDate(min.getDate() - (lastDays-1));
            return (historique||[]).filter(h => parseISODate(h.date) >= new Date(min.toISOString().slice(0,10)+"T00:00:00")).length;
        }

        function lowStockCount(threshold=5){
            return Object.values(stock||{}).filter(it => (it.quantite||0) > 0 && (it.quantite||0) <= threshold).length;
        }

        function ruptureCount(){
            return Object.values(stock||{}).filter(it => (it.quantite||0) <= 0).length;
        }

        function drawLineChart(svgId, data) {
            const svg = document.getElementById(svgId);
            if (!svg) return;
            svg.innerHTML = "";

            const W = 700, H = 260;
            const padX = 35, padY = 24;
            const innerW = W - padX*2, innerH = H - padY*2;

            const max = Math.max(1, ...data.map(d => d.value || d.total || 0));
            const pts = data.map((d, i) => {
                const x = padX + (i * innerW / Math.max(1, data.length-1));
                const y = padY + (innerH - ((d.value || d.total || 0) / max) * innerH);
                return [x,y];
            });

            // grid lines
            for (let i=0;i<4;i++){
                const y = padY + (i*innerH/3);
                svg.insertAdjacentHTML("beforeend",
                `<line x1="${padX}" y1="${y}" x2="${W-padX}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`
                );
            }

            const poly = pts.map(p => p.join(",")).join(" ");
            svg.insertAdjacentHTML("beforeend",
                `<polyline fill="none" stroke="#111827" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="${poly}"/>`
            );

            // dots
            pts.forEach((p, idx) => {
                svg.insertAdjacentHTML("beforeend",
                `<circle cx="${p[0]}" cy="${p[1]}" r="5" fill="#111827"/>`
                );
            });
        }

        
        //---- FIN -DASHBOARD -------//
        
    /**
     * Normalise un nom de produit pour garantir la cohérence
     * - Supprime espaces début/fin
     * - Remplace espaces multiples par un seul
     * - Capitalise première lettre de chaque mot
     */
    function normaliserNomProduit(nom) {
        if (!nom || typeof nom !== 'string') return '';

        // Étape 1: Supprimer espaces début/fin
        nom = nom.trim();

        // Étape 2: Remplacer espaces multiples par un seul espace
        nom = nom.replace(/\s+/g, ' ');

        // Étape 3 (optionnel): Capitaliser première lettre de chaque mot
        // Décommentez si vous voulez "Riz Blanc Premium" au lieu de "riz blanc premium"
        // nom = nom.split(' ').map(mot => 
        //     mot.charAt(0).toUpperCase() + mot.slice(1).toLowerCase()
        // ).join(' ');
        nom = nom.toLowerCase();
        return nom;
    }

    /**
     * Fonction de migration: Normalise tous les produits du stock existant
     * À exécuter UNE SEULE FOIS après avoir ajouté normaliserNomProduit
     */
    function migrerStockExistant() {
        const nouveauStock = {};
        let nbFusions = 0;

        Object.keys(stock).forEach(nomProduit => {
            const nomNormalise = normaliserNomProduit(nomProduit);

            if (nouveauStock[nomNormalise]) {
                // Fusion détectée!
                nbFusions++;
                console.log(`🔄 Fusion: "${nomProduit}" → "${nomNormalise}"`);

                // Fusionner les lots si le produit existe déjà
                const lotsExistants = nouveauStock[nomNormalise].lots || [];
                const nouveauxLots = stock[nomProduit].lots || [];
                nouveauStock[nomNormalise].lots = [...lotsExistants, ...nouveauxLots];
            } else {
                // Créer nouvelle entrée
                nouveauStock[nomNormalise] = stock[nomProduit];
            }
        });

        stock = nouveauStock;
        sauvegarderDonnees();

        const message = `
    ╔═══════════════════════════════════════════════════════════════╗
    ║              MIGRATION TERMINÉE AVEC SUCCÈS                   ║
    ╚═══════════════════════════════════════════════════════════════╝

    ${Object.keys(stock).length} produits normalisés
    ${nbFusions} fusion(s) effectuée(s)

    Tous vos produits sont maintenant uniformisés!
        `;

        console.log(message);
        alert(`Migration terminée!\n${Object.keys(stock).length} produits normalisés\n${nbFusions} fusion(s) effectuée(s)`);
    }


    function genererNumero(type) {
            const date = new Date();
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const count = historique.filter(h => h.type === type && h.date.startsWith(y + '-' + m)).length + 1;
            const prefix = type === 'achat' ? 'PRO' : 'VEN';
            document.getElementById(type + '-numero').value = `${prefix}-${y}${m}-${String(count).padStart(4, '0')}`;
        }

        function ajouterArticleAchat() {
            const produit = normaliserNomProduit(document.getElementById('achat-produit').value);
            const quantite = parseFloat(document.getElementById('achat-quantite').value);
            const prix = parseFloat(document.getElementById('achat-prix').value);
            const unite = document.getElementById('achat-unite').value;
            
            if(!produit || !quantite || !prix) {
                alert('Remplissez tous les champs');
                return;
            }
            
            articlesAchat.push({
                produit: produit,
                quantite: quantite,
                prix: prix,
                unite: unite,
                total: quantite * prix
            });
            
            document.getElementById('achat-produit').value = '';
            document.getElementById('achat-quantite').value = '';
            document.getElementById('achat-prix').value = '';
            document.getElementById('achat-unite').selectedIndex = 0;

            afficherArticlesAchat();
        }
        
        function afficherArticlesAchat() {
            const tbody = document.getElementById('achat-tbody');
            tbody.innerHTML = '';
            let total = 0;
            
            articlesAchat.forEach((a, i) => {
                total += a.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${a.produit}</td>
                        <td>${a.quantite}</td>
                        <td>${a.unite}</td>
                        <td>${a.prix.toLocaleString()} Ar</td>
                        <td>${a.total.toLocaleString()} Ar</td>
                        <td><button class="btn btn-pdf" onclick="supprimerArticleAchat(${i})">🗑️</button></td>
                    </tr>
                `;
            });
            
            document.getElementById('achat-total').textContent = total.toLocaleString() + ' Ar';
            document.getElementById('achat-articles-section').style.display = articlesAchat.length > 0 ? 'block' : 'none';
        }
        
        function supprimerArticleAchat(i) {
            articlesAchat.splice(i, 1);
            afficherArticlesAchat();
        }

        // Numéro automatique VENTE uniquement
        function genererNumeroVente() {
            const dateInput = document.getElementById('vente-date').value;
            if(!dateInput) return;
            
            const date = new Date(dateInput);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const count = historique.filter(h => h.type === 'vente' && h.date.startsWith(y + '-' + m)).length + 1;
            document.getElementById('vente-numero').value = `VEN-${y}${m}-${String(count).padStart(4, '0')}`;
        }
        
        // Validation ACHAT (page propre + pieces)
        function validerAchat() {
            if (!articlesAchat.length) {
                alert('Aucun article');
                return;
            }

            const date = document.getElementById('achat-date').value;
            const fournisseur = document.getElementById('achat-fournisseur').value;

            if (!date || !fournisseur) {
                alert('Remplissez tous les champs');
                return;
            }

            // pieces: metadata ihany (fileKey ao IndexedDB)
            const pieces = factureAchatDraft ? [factureAchatDraft] : [];

            // --- Mise à jour stock (lots) ---
            articlesAchat.forEach(a => {
                if (!stock[a.produit]) {
                stock[a.produit] = { unite: a.unite, lots: [] };
                }
                if (!stock[a.produit].lots) stock[a.produit].lots = [];

                stock[a.produit].unite = a.unite;
                stock[a.produit].lots.push({
                qte: Number(a.quantite),
                prix: Number(a.prix),
                date: date
                });
            });

            // --- Historique ---
            historique.push({
                type: 'achat',
                date: date,
                tiers: fournisseur,
                articles: [...articlesAchat],
                total: articlesAchat.reduce((s, a) => s + a.total, 0),
                pieces: pieces
            });

            // --- Sauvegarde ---
            sauvegarderDonnees();
            updateDashboard();

            // --- Page propre ---
            resetAchatForm();   // clear articles + fournisseur + table
            resetScanUI();      // clear scan preview + input + draft

            alert('Achat validé et stock mis à jour');
            mettreAJourSelect();
            updateStockValueUI({ objectif: 500000 });
        }

        function resetAchatForm() {
            articlesAchat = [];
            document.getElementById('achat-fournisseur').value = '';
            afficherArticlesAchat();
        }

        function resetScanUI() {
            factureAchatDraft = null;

            document.getElementById('facture-scan').value = '';
            document.getElementById('scan-image').src = '';
            document.getElementById('scan-preview').style.display = 'none';

            document.getElementById('scan-progress-bar').style.width = '0%';
            document.getElementById('scan-status').textContent = '';
            document.getElementById('scan-progress').style.display = 'none';

            const t = document.getElementById('scan-title');
            if (t) t.textContent = 'Analyse en cours...';
        }

        function mettreAJourSelect() {
            const select = document.getElementById('vente-produit');
            if(!select) return; // cas où select n'existe pas (tu n'en as pas besoin ici)
            select.innerHTML = '<option value="">-- Sélectionner --</option>';
            Object.keys(stock).sort().forEach(p => {
                if(stock[p].quantite > 0) {
                    select.innerHTML += `<option value="${p}">${p}</option>`;
                }
            });
        }
        
        let suggestionsTimeout;

        function rechercherProduitDynamique() {
            clearTimeout(suggestionsTimeout);
            suggestionsTimeout = setTimeout(() => {
                const search = normaliserNomProduit(document.getElementById('vente-search').value).toLowerCase();
                const suggestionsBox = document.getElementById('suggestions-box');

                if(search.length < 2) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                const produits = Object.keys(stock || {})
                    .filter(p => getStockQty(p) > 0 && p.toLowerCase().includes(search))
                    .slice(0, 20);

                if(produits.length === 0) {
                    suggestionsBox.innerHTML = '<div style="padding: 10px; color: #999;">Aucun produit trouvé</div>';
                    suggestionsBox.style.display = 'block';
                    return;
                }

                suggestionsBox.innerHTML = produits.map(p => `
                <div class="suggestion-item"
                    onmousedown="selectionnerProduit('${p.replace(/'/g, "\\'")}')"
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                    <strong>${p}</strong>
                    <span style="color:#666; font-size:0.85em;">
                        Stock: ${getStockQty(p)} ${(stock[p] && stock[p].unite) ? stock[p].unite : 'Pièce'}
                    </span>
                </div>
                `).join('');

                suggestionsBox.style.display = 'block';
            }, 300);
        }


        function selectionnerProduit(produit) {
        produit = normaliserNomProduit(produit);
            document.getElementById('vente-search').value = produit;
            document.getElementById('vente-produit-selected').value = produit;
            document.getElementById('suggestions-box').style.display = 'none';
            chargerProduitVenteAutocomplete();
        }

        function afficherSuggestions() {
            const search = document.getElementById('vente-search').value;
            if(search.length >= 2) {
                rechercherProduitDynamique();
            }
        }

        function cacherSuggestions() {
            setTimeout(() => {
                document.getElementById('suggestions-box').style.display = 'none';
            }, 200);
        }

        function chargerProduitVenteAutocomplete() {
            const p = document.getElementById('vente-produit-selected').value;
            if(p && stock[p]) {
                document.getElementById('vente-stock-dispo').value = getStockQty(p) + ' ' + (stock[p].unite || '');
            } else {
                document.getElementById('vente-stock-dispo').value = '';
            }

            // Ampiana: manavao revient/marge affiché ao Vente
            if(typeof updateVenteCostAndMargeUI === 'function') updateVenteCostAndMargeUI();

            // Raha mampiasa “marge % cible” ka tianao hanolotra PV automatique:
            if(typeof suggestPrixVenteFromMarge === 'function') suggestPrixVenteFromMarge();
        }


        function getLots(p){
            return (stock[p] && Array.isArray(stock[p].lots)) ? stock[p].lots : [];
            }

            function getStockQty(p){
            return getLots(p).reduce((s,l)=> s + (Number(l.qte)||0), 0);
            }

            function getStockValue(p){
            return getLots(p).reduce((s,l)=> s + (Number(l.qte)||0) * (Number(l.prix)||0), 0);
            }

            function getAvgBuyPrice(p){
            const q = getStockQty(p);
            if(q <= 0) return 0;
            return getStockValue(p) / q;
            }

            // Consomme FIFO sur une copie (ou sur le vrai lots) et retourne le coût exact
            function consumeLotsFIFO(lots, qteDemandee){
            let q = Number(qteDemandee || 0);
            let cogs = 0;

            for(const lot of lots){
                if(q <= 0) break;
                const dispo = Number(lot.qte || 0);
                if(dispo <= 0) continue;

                const take = Math.min(dispo, q);
                cogs += take * Number(lot.prix || 0);
                lot.qte = dispo - take;
                q -= take;
            }

            return { ok: q === 0, cogs };
            }

            // Preview “exact” pour ce que tu vas ajouter, en tenant compte des articles déjà ajoutés dans la vente
            function previewCogsForCurrentSale(produit, qtyToAdd){
            const lotsCopy = getLots(produit).map(l => ({...l})); // copie
            const already = articlesVente
                .filter(a => a.produit === produit)
                .reduce((s,a)=> s + (Number(a.quantite)||0), 0);

            const r1 = consumeLotsFIFO(lotsCopy, already);
            const r2 = consumeLotsFIFO(lotsCopy, qtyToAdd);

            return { ok: r1.ok && r2.ok, cogs: r2.cogs };
            }


        function ajouterArticleVente() {
            const produit = normaliserNomProduit(document.getElementById('vente-produit-selected').value);
            const quantite = parseFloat(document.getElementById('vente-quantite').value);
            const prix = parseFloat(document.getElementById('vente-prix').value);

            if(!produit || !quantite || !prix) {
                alert('Remplissez tous les champs');
                return;
            }

            const dispo = getStockQty(produit);
            if(!stock[produit] || dispo < quantite) {
                alert('Stock insuffisant');
                return;
            }

            // coût exact FIFO (preview) pour CE que tu ajoutes maintenant
            const r = previewCogsForCurrentSale(produit, quantite);
            if(!r.ok) {
                alert('Stock insuffisant');
                return;
            }

            const totalVente = quantite * prix;
            const margeTot = totalVente - r.cogs;
            const margeUnit = margeTot / quantite;

            articlesVente.push({
                produit: produit,
                quantite: quantite,
                prix: prix,
                unite: stock[produit].unite,
                total: totalVente,
                cogs: r.cogs,
                margeTot: margeTot,
                margeUnit: margeUnit
            });

            // vider champs (rehefa tsindrina ➕)
            document.getElementById('vente-search').value = '';
            document.getElementById('vente-produit-selected').value = '';
            document.getElementById('vente-stock-dispo').value = '';
            document.getElementById('vente-quantite').value = '';
            document.getElementById('vente-prix').value = '';
            afficherArticlesVente();
        }


        function afficherArticlesVente() {
            const tbody = document.getElementById('vente-tbody');
            tbody.innerHTML = '';
            let total = 0;
            
            articlesVente.forEach((a, i) => {
                total += a.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${a.produit}</td>
                        <td>${a.quantite}</td>
                        <td>${a.unite}</td>
                        <td>${a.prix.toLocaleString()} Ar</td>
                        <td>${a.total.toLocaleString()} Ar</td>
                        <td><button class="btn btn-pdf" onclick="supprimerArticleVente(${i})">🗑️</button></td>
                    </tr>
                `;
            });
            
            document.getElementById('vente-total').textContent = total.toLocaleString() + ' Ar';
            document.getElementById('vente-articles-section').style.display = articlesVente.length > 0 ? 'block' : 'none';
        }

        function supprimerArticleVente(i) {
            articlesVente.splice(i, 1);
            afficherArticlesVente();
        }

        function updateVenteCostAndMargeUI(){
            const p = document.getElementById('vente-produit-selected').value;
            const q = parseFloat(document.getElementById('vente-quantite').value) || 0;
            const pv = parseFloat(document.getElementById('vente-prix').value) || 0;

            if(!p || !stock[p] || q <= 0){
                document.getElementById('vente-pa-unit').value = '';
                document.getElementById('vente-revient-total').value = '';
                document.getElementById('vente-marge-total').value = '';
                return;
            }

            const r = previewCogsForCurrentSale(p, q);
            if(!r.ok){
                document.getElementById('vente-pa-unit').value = '';
                document.getElementById('vente-revient-total').value = 'Stock insuffisant';
                document.getElementById('vente-marge-total').value = '';
                return;
            }

            const revientTotal = r.cogs;
            const paUnit = revientTotal / q;
            const margeTot = (pv * q) - revientTotal;

            document.getElementById('vente-pa-unit').value = paUnit.toLocaleString() + ' Ar';
            document.getElementById('vente-revient-total').value = revientTotal.toLocaleString() + ' Ar';
            document.getElementById('vente-marge-total').value = margeTot.toLocaleString() + ' Ar';
        }

        // ✅ NOUVELLE FONCTION: Changer type calcul
        function changerTypeCalcul() {
            const type = document.getElementById('marge-type').value;
            const label = document.getElementById('marge-label');
            const help = document.getElementById('marge-help');
            const input = document.getElementById('vente-marge-pct');
            
            if (type === 'markup') {
                // MARKUP mode
                label.textContent = 'Markup (%)';
                help.textContent = 'Ex: 50% → Prix vente = Prix achat × 1.50';
                input.max = 200; // Pas de limite pratique
            } else {
                // MARGE mode
                label.textContent = 'Marge (%)';
                help.textContent = 'Ex: 50% → Marge = 50% du prix de vente';
                input.max = 95; // Max 95% pour éviter division par 0
            }
            
            // Re-calculer prix
            suggestPrixVenteFromMarge();
        }

        function suggestPrixVenteFromMarge() {
            const p = document.getElementById('vente-produit-selected').value;
            const q = parseFloat(document.getElementById('vente-quantite').value) || 0;
            const pct = parseFloat(document.getElementById('vente-marge-pct').value) || 0;
            const type = document.getElementById('marge-type').value;
            
            if(!p || !stock[p] || q <= 0) return;
            
            const r = previewCogsForCurrentSale(p, q);
            if(!r.ok) return;
            
            const paUnit = r.cogs / q; // Prix achat unitaire
            let pvUnit;
            
            if (type === 'markup') {
                // ✅ MODE MARKUP: PV = PA × (1 + markup%)
                const markup = pct / 100; // Ex: 50% = 0.50
                pvUnit = paUnit * (1 + markup);
            } else {
                // ✅ MODE MARGE: PV = PA / (1 - marge%)
                const m = Math.min(Math.max(pct, 0), 95) / 100; // Clamp 0-95%
                pvUnit = paUnit / (1 - m);
            }
            
            document.getElementById('vente-prix').value = Math.ceil(pvUnit);
            updateVenteCostAndMargeUI();
        }

        function validerVente() {
            if(!articlesVente.length) {
                alert('Aucun article');
                return;
            }
            
            const date = document.getElementById('vente-date').value;
            const client = document.getElementById('vente-client').value;
            const adresse = document.getElementById('vente-adresse').value;
            const numero = document.getElementById('vente-numero').value;
            // ✅ DEBUG - Vérifier la valeur
            
            const delaiInput = document.getElementById('vente-delai');
            const delaiPaiement = delaiInput && delaiInput.value !== '' 
            ? parseInt(delaiInput.value, 10) 
            : 30;
            
            
            if(!date || !client || !adresse || !numero) {
                alert('Remplissez tous les champs');
                return;
            }
            
            // Vérification et consommation FIFO
            articlesVente.forEach(a => {
                const lots = getLots(a.produit);
                const r = consumeLotsFIFO(lots, a.quantite);
                if(!r.ok){
                    alert('Stock insuffisant (lots) – vente annulée');
                    return;
                }
                // esory lots lany (qte <= 0)
                stock[a.produit].lots = lots.filter(l => (Number(l.qte)||0) > 0);
            });

            // ✅ VAOVAO - Calcul total
            const totalVente = articlesVente.reduce((s, a) => s + a.total, 0);
            
            const dateLimiteCalculee = calculerDateLimite(date, delaiPaiement);
            
            
            historique.push({
                type: 'vente',
                date: date,
                numero: numero,
                tiers: client,
                adresse: adresse,
                articles: [...articlesVente],
                total: totalVente,
                
                // ✅ GESTION PAIEMENT - Avec délai dynamique:
                statutPaiement: 'impayé',
                dateLimite: dateLimiteCalculee,
                montantPaye: 0,
                paiements: [],
                datePayement: null,
                moyenPaiement: null
            });
            
            sauvegarderDonnees();
            alert('✅ Vente enregistrée');
            updateNotificationBadge();

            // Page propre
            articlesVente = [];
            afficherArticlesVente();
            document.getElementById('vente-client').value = '';
            document.getElementById('vente-adresse').value = '';
            document.getElementById('vente-delai').value = '30'; // ✅ Reset à 30
            genererNumeroVente();
            afficherStock();
            updateDashboard();
            afficherHistorique();
            updateStockValueUI({ objectif: 500000 });
        }



        function afficherStock() {
            const tbody = document.getElementById('stock-tbody');
            tbody.innerHTML = '';
            let nbProduits = 0;
            let valeurTotale = 0;
            
            // Collect all stock items
            const allItems = [];
            Object.keys(stock).sort().forEach(p => {
                const s = stock[p];
                const qte = getStockQty(p);
                if(qte <= 0) return;
                
                const valeur = getStockValue(p);
                
                allItems.push({
                    produit: p,
                    qte: qte,
                    unite: s.unite || '',
                    valeur: valeur
                });
            });

            // ✅ FILTRE INTELLIGENT - RECHERCHE
            let filteredItems = allItems;
            if(stockSearchQuery && stockSearchQuery.trim() !== '') {
                const query = stockSearchQuery.toLowerCase().trim();
                filteredItems = allItems.filter(item => {
                    // Recherche dans produit, quantité, unité
                    return item.produit.toLowerCase().includes(query) ||
                        item.qte.toString().includes(query) ||
                        (item.unite && item.unite.toLowerCase().includes(query));
                });
            }

            // Stats avec items filtrés
            nbProduits = filteredItems.length;
            valeurTotale = filteredItems.reduce((sum, item) => sum + item.valeur, 0);
            
            // Pagination avec items filtrés
            const totalItems = filteredItems.length;
            const startIdx = (stockPage - 1) * stockPerPage;
            const endIdx = startIdx + stockPerPage;
            const pageItems = filteredItems.slice(startIdx, endIdx);

            
            // Display paginated items
            pageItems.forEach(item => {
                const prixMoy = getAvgBuyPrice(item.produit);
                const lots = getLots(item.produit);
                const nbLots = lots.length;
                
                let badgeClass = 'stock-high';
                if(item.qte < 5) badgeClass = 'stock-low';
                else if(item.qte < 20) badgeClass = 'stock-medium';
                
                tbody.innerHTML += `
                <tr>
                    <td>${item.produit}</td>
                    <td style="text-align:right;">${item.qte}</td>
                    <td>${item.unite}</td>
                    <td style="text-align:right;">
                        <div style="font-weight:600;">${prixMoy.toLocaleString()} Ar</div>
                        <small style="color:#666; font-size:11px;">(${nbLots} lot${nbLots>1?'s':''})</small>
                        <button onclick="showLotDetails('${item.produit.replace(/'/g, "\\'")}', event)" class="btn-mini" style="margin-top:4px;">📦 Détails FIFO</button>
                    </td>
                    <td style="text-align:right;">${item.valeur.toLocaleString()} Ar</td>
                    <td><span class="stock-badge ${badgeClass}">${item.qte < 5 ? 'Faible' : (item.qte < 20 ? 'Moyen' : 'Bon')}</span></td>
                </tr>
                `;
            });
            
            updateDashStockCard();
            document.getElementById('stat-produits').textContent = nbProduits;
            document.getElementById('stat-valeur').textContent = valeurTotale.toLocaleString() + ' Ar';
            
            // Create pagination
            createPagination('stock-pagination', stockPage, totalItems, stockPerPage, goToStockPage, changeStockPerPage);

            // ✅ OPTIMISÉ - Tsy misy log, direct attach
            const container = document.getElementById('stock-pagination');
            if(container) {
                const totalPages = Math.max(1, Math.ceil(totalItems / stockPerPage));
                
                // Clear old listeners (avoid accumulation)
                const oldContainer = container.cloneNode(true);
                container.parentNode.replaceChild(oldContainer, container);
                
                // Get new container after replacement
                const freshContainer = document.getElementById('stock-pagination');
                
                // Fix buttons
                freshContainer.querySelectorAll('.pagination-btn').forEach((btn) => {
                    const hasLeftDouble = btn.querySelector('.fa-angles-left');
                    const hasLeft = btn.querySelector('.fa-chevron-left');
                    const hasRight = btn.querySelector('.fa-chevron-right');
                    const hasRightDouble = btn.querySelector('.fa-angles-right');
                    
                    if(hasLeftDouble) {
                        btn.onclick = () => goToStockPage(1);
                    } else if(hasLeft) {
                        btn.onclick = () => goToStockPage(Math.max(1, stockPage - 1));
                    } else if(hasRight) {
                        btn.onclick = () => goToStockPage(Math.min(totalPages, stockPage + 1));
                    } else if(hasRightDouble) {
                        btn.onclick = () => goToStockPage(totalPages);
                    } else {
                        const pageNum = parseInt(btn.textContent);
                        if(!isNaN(pageNum)) {
                            btn.onclick = () => goToStockPage(pageNum);
                        }
                    }
                });
                
                // Fix dropdown
                const sel = freshContainer.querySelector('select');
                if(sel) sel.onchange = (e) => changeStockPerPage(e.target.value);
            }

        }

        function goToStockPage(page) {
            
            stockPage = page;
            
            afficherStock();
        }

        function changeStockPerPage(perPage) {
            
            stockPerPage = parseInt(perPage, 10);
            stockPage = 1;
            
            afficherStock();
        }

        function showLotDetails(produit, event) {
            if(event) event.stopPropagation();
            
            const lots = getLots(produit);
            const qteTotal = getStockQty(produit);
            const valeurTotal = getStockValue(produit);
            const prixMoy = getAvgBuyPrice(produit);
            
            if(lots.length === 0) {
                alert('Aucun lot disponible pour ce produit');
                return;
            }
            
            // Créer le modal content
            let html = `
                <div style="padding:20px;">
                    <h3 style="margin-bottom:15px; color:#111827;">📦 Détails Lots FIFO - ${produit}</h3>
                    
                    <div style="background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:15px;">
                        <strong>Quantité totale:</strong> ${qteTotal}<br>
                        <strong>Valeur totale:</strong> ${valeurTotal.toLocaleString()} Ar<br>
                        <strong>Prix unitaire moyen:</strong> ${prixMoy.toLocaleString()} Ar
                    </div>
                    
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#111827; color:white;">
                                <th style="padding:10px; text-align:left;">#</th>
                                <th style="padding:10px; text-align:right;">Quantité</th>
                                <th style="padding:10px; text-align:right;">Prix unitaire</th>
                                <th style="padding:10px; text-align:right;">Valeur</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            lots.forEach((lot, i) => {
                const val = Number(lot.qte || 0) * Number(lot.prix || 0);
                html += `
                    <tr style="border-bottom:1px solid #e5e7eb;">
                        <td style="padding:10px;">Lot ${i + 1}</td>
                        <td style="padding:10px; text-align:right;">${Number(lot.qte || 0).toLocaleString()}</td>
                        <td style="padding:10px; text-align:right;">${Number(lot.prix || 0).toLocaleString()} Ar</td>
                        <td style="padding:10px; text-align:right; font-weight:600;">${val.toLocaleString()} Ar</td>
                    </tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top:20px; padding:10px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px;">
                        <strong>ℹ️ Info:</strong> Les lots sont consommés dans l'ordre FIFO (Premier Entré, Premier Sorti) lors des ventes.
                    </div>
                    
                    <button onclick="closeLotModal()" style="margin-top:20px; background:#111827; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; width:100%;">Fermer</button>
                </div>
            `;
            
            // Afficher dans un modal
            const modal = document.createElement('div');
            modal.id = 'lot-details-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            `;
            modalContent.innerHTML = html;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Fermer si click en dehors
            modal.addEventListener('click', function(e) {
                if(e.target === modal) {
                    closeLotModal();
                }
            });
        }

        function closeLotModal() {
            const modal = document.getElementById('lot-details-modal');
            if(modal) {
                modal.remove();
            }
        }



        function rechercherStock() {
            stockSearchQuery = document.getElementById('search-stock').value.toLowerCase();
            stockPage = 1;               // miverina amin’ny page 1
            afficherStock();
        }

        function normaliserDate(dateStr) {
            if (!dateStr) return '';
            
            const d = new Date(dateStr + 'T00:00:00');
            if (isNaN(d.getTime())) return dateStr.toLowerCase();
            
            const jour = d.getDate();
            const mois = d.getMonth() + 1;
            const annee = d.getFullYear();
            
            const moisNoms = ['janv', 'févr', 'mars', 'avr', 'mai', 'juin', 
                            'juil', 'août', 'sept', 'oct', 'nov', 'déc'];
            const moisNomsComplets = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                                    'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
            
            const moisCourt = moisNoms[mois - 1];
            const moisComplet = moisNomsComplets[mois - 1];
            
            return [
                dateStr,
                `${jour}/${mois}/${annee}`,
                `${String(jour).padStart(2,'0')}/${String(mois).padStart(2,'0')}/${annee}`,
                `${jour} ${moisCourt}`,
                `${jour} ${moisCourt} ${annee}`,
                `${jour} ${moisComplet}`,
                `${jour} ${moisComplet} ${annee}`,
                String(jour),
                String(mois),
                String(annee),
                moisCourt,
                moisComplet
            ].join(' ').toLowerCase();
        }

        // ============================================================================
        // FONCTION AMÉLIORÉE: afficherHistorique() avec recherche intelligente
        // ============================================================================
        function afficherHistorique() {
            const tbody = document.getElementById('historique-tbody');
            tbody.innerHTML = '';

            let allItems = historique.slice().reverse();

            // RECHERCHE ULTRA INTELLIGENTE
            if (historiqueSearchQuery) {
                allItems = allItems.filter(h => {
                    const query = historiqueSearchQuery.toLowerCase().trim();

                    // 1. Champs de base
                    const searchBase = [
                        h.type || '',
                        h.numero || '',
                        h.tiers || '',
                        h.total.toString(),
                        h.adresse || '',
                        h.notes || ''
                    ].join(' ').toLowerCase();

                    // 2. Recherche dans les PRODUITS
                    let searchProduits = '';
                    if (h.articles && h.articles.length > 0) {
                        searchProduits = h.articles.map(a => 
                            (a.produit || '') + ' ' + 
                            (a.quantite || '') + ' ' + 
                            (a.unite || '') + ' ' + 
                            (a.prix || '')
                        ).join(' ').toLowerCase();
                    }

                    // 3. Recherche dans le STATUT DE PAIEMENT - CORRIGÉ!
                    let searchStatut = '';
                    if (h.type === 'vente') {
                        const resteAPayer = h.total - (h.montantPaye || 0);

                        // Utiliser des mots-clés UNIQUES pour éviter les collisions
                        if (h.statutPaiement === 'payé' || resteAPayer === 0) {
                            // PAYÉ: mots-clés qui ne contiennent pas "impayé"
                            searchStatut = 'statut_payé statut_paye reglé regle soldé solde complet termine';
                        } else if (h.statutPaiement === 'partiel' && resteAPayer > 0) {
                            // PARTIEL: mots-clés uniques
                            searchStatut = 'statut_partiel partiellement partielle acompte';
                        } else {
                            // IMPAYÉ: mots-clés avec préfixes
                            searchStatut = 'statut_impayé statut_impaye non_payé non_paye en_attente attente dû restant';
                        }

                        // Ajouter le moyen de paiement
                        if (h.moyenPaiement) {
                            searchStatut += ' ' + h.moyenPaiement.toLowerCase();
                        }
                    }

                    // 4. Recherche dans les DATES
                    const searchDate = normaliserDate(h.date);

                    // 5. COMBINER toutes les recherches
                    const allSearchableText = searchBase + ' ' + searchProduits + ' ' + searchStatut + ' ' + searchDate;

                    // LOGIQUE DE RECHERCHE AMÉLIORÉE
                    // Si la requête est exactement "payé" ou "paye", chercher uniquement les payés
                    if (query === 'payé' || query === 'paye' || query === 'payée' || query === 'payee') {
                        return allSearchableText.includes('statut_payé') || allSearchableText.includes('statut_paye');
                    }

                    // Si la requête est exactement "impayé" ou "impaye", chercher uniquement les impayés
                    if (query === 'impayé' || query === 'impaye' || query === 'impayée' || query === 'impayee') {
                        return allSearchableText.includes('statut_impayé') || allSearchableText.includes('statut_impaye');
                    }

                    // Si la requête est "partiel", chercher uniquement les partiels
                    if (query === 'partiel' || query === 'partielle' || query === 'partiellement') {
                        return allSearchableText.includes('statut_partiel');
                    }

                    // Pour toutes les autres recherches, recherche normale
                    return allSearchableText.includes(query);
                });
            }

            // Filtre type
            if (historiqueTypeFilter !== 'tous') {
                allItems = allItems.filter(h => h.type === historiqueTypeFilter);
            }

            const totalItems = allItems.length;

            // Pagination
            const startIdx = (historiquePage - 1) * historiquePerPage;
            const endIdx = startIdx + historiquePerPage;
            const pageItems = allItems.slice(startIdx, endIdx);

            // Aucun résultat
            if (pageItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#6b7280;"><i class="fa-solid fa-search" style="font-size:40px; margin-bottom:10px; opacity:0.3;"></i><p style="margin:0; font-weight:600;">Aucun résultat trouvé</p><p style="margin:5px 0 0 0; font-size:12px;">Essayez avec d\'autres mots-clés</p></td></tr>';
                return;
            }

            // Afficher les résultats
            pageItems.forEach((h, i) => {
                const originalIdx = historique.findIndex(item => item === h);

                // Badge statut paiement
                let badgePaiement = '';
                if (h.type === 'vente') {
                    const resteAPayer = h.total - (h.montantPaye || 0);
                    if (h.statutPaiement === 'payé' || resteAPayer === 0) {
                        badgePaiement = '<span style="background:#dcfce7; color:#166534; padding:4px 10px; border-radius:6px; font-size:11px; margin-left:8px; font-weight:700; border:1px solid #16a34a;">✓ Payé</span>';
                    } else if (h.statutPaiement === 'partiel' && resteAPayer > 0) {
                        badgePaiement = '<span style="background:#fef3c7; color:#92400e; padding:4px 10px; border-radius:6px; font-size:11px; margin-left:8px; font-weight:700; border:1px solid #f59e0b;">Partiel</span>';
                    } else {
                        badgePaiement = '<span style="background:#fee2e2; color:#991b1b; padding:4px 10px; border-radius:6px; font-size:11px; margin-left:8px; font-weight:700; border:1px solid #dc2626;">Impayé</span>';
                    }
                }

                const typeIcon = h.type === 'achat' ? '<i class="fa-solid fa-cart-shopping"></i> Achat' : '<i class="fa-solid fa-receipt"></i> Vente';
                const typeColor = h.type === 'achat' ? '#dc2626' : '#16a34a';

                const btnVente = h.type === 'vente' ? `
                    <button class="btn-compact" onclick="genererPDFDepuisHistorique(historique[${originalIdx}],'facture')" title="Facture">
                        <i class="fa-solid fa-file-invoice"></i>
                    </button>
                    <button class="btn-compact" onclick="genererPDFDepuisHistorique(historique[${originalIdx}],'proforma')" title="Proforma">
                        <i class="fa-solid fa-file-lines"></i>
                    </button>
                    <button class="btn-compact" onclick="genererPDFDepuisHistorique(historique[${originalIdx}],'bon')" title="BL">
                        <i class="fa-solid fa-truck-fast"></i>
                    </button>
                ` : '';

                const row = document.createElement('tr');
                row.onclick = function() { ouvrirDetailVente(originalIdx); };
                row.style.cursor = 'pointer';
                row.onmouseover = function() { this.style.backgroundColor = '#f3f4f6'; };
                row.onmouseout = function() { this.style.backgroundColor = ''; };

                row.innerHTML = `
                    <td>${h.date}</td>
                    <td><strong style="color:${typeColor}">${typeIcon}${badgePaiement}</strong></td>
                    <td>${h.numero || '-'}</td>
                    <td>${h.tiers}</td>
                    <td style="font-weight:600; text-align:right">${h.total.toLocaleString()} Ar</td>
                    <td onclick="event.stopPropagation()">
                        <div style="display:flex; gap:4px; flex-wrap:wrap; align-items:center;">
                            ${btnVente}
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Pagination
            createPagination('historique-pagination', historiquePage, totalItems, historiquePerPage, goToHistoriquePage, changeHistoriquePerPage);
        }


        function goToHistoriquePage(page) {
            historiquePage = page;
            afficherHistorique();
        }

        function changeHistoriquePerPage(perPage) {
            historiquePerPage = parseInt(perPage, 10);
            historiquePage = 1;
            afficherHistorique();
        }

        function rechercherHistorique() {
            historiqueSearchQuery = document.getElementById('search-historique').value.toLowerCase();
            historiquePage = 1;
            afficherHistorique();
        }

        // ========== FONCTION MANQUANTE : Debounce ==========
        let searchTimeout;
        function rechercherHistoriqueDebounced() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                rechercherHistorique();
            }, 300);
        }

        function filtrerHistorique() {
            historiqueTypeFilter = document.getElementById('filter-type').value;
            historiquePage = 1;
            afficherHistorique();
        }

        // ==========  Filtres rapides ==========
        function appliquerFiltreRapide(type) {
            const searchInput = document.getElementById('search-historique');

            switch(type) {
                case 'impayé':
                    historiqueTypeFilter = 'vente';
                    document.getElementById('filter-type').value = 'vente';
                    historiqueSearchQuery = 'impayé';
                    searchInput.value = 'impayé';
                    break;
                case 'payé':
                    historiqueTypeFilter = 'vente';
                    document.getElementById('filter-type').value = 'vente';
                    historiqueSearchQuery = 'payé';
                    searchInput.value = 'payé';
                    break;
                case 'aujourdhui':
                    const today = new Date().toISOString().slice(0, 10);
                    historiqueSearchQuery = today;
                    searchInput.value = today;
                    break;
                case 'semaine':
                    const week = new Date();
                    week.setDate(week.getDate() - 7);
                    historiqueSearchQuery = week.toISOString().slice(0, 7);
                    searchInput.value = historiqueSearchQuery;
                    break;
            }

            rechercherHistorique();
        }

        function effacerFiltres() {
            historiqueSearchQuery = '';
            historiqueTypeFilter = 'tous';
            document.getElementById('search-historique').value = '';
            document.getElementById('filter-type').value = 'tous';
            historiquePage = 1;
            afficherHistorique();
        }

        // ========== FONCTION POUR OUVRIR LE MODAL AVEC DÉTAILS ==========
        function ouvrirDetailVente(idx) {
            const h = historique[idx];

            if (h.type === 'achat') {
                // Modal Achat existant
                document.getElementById('achat-modal-info').textContent = `Date: ${h.date} | Fournisseur: ${h.tiers}`;
                const tbody = document.getElementById('achat-modal-tbody');
                tbody.innerHTML = '';

                h.articles.forEach(a => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${a.produit}</td>
                            <td>${a.quantite}</td>
                            <td>${a.unite}</td>
                            <td>${a.prix.toLocaleString()} Ar</td>
                            <td>${a.total.toLocaleString()} Ar</td>
                        </tr>
                    `;
                });

                document.getElementById('achat-modal-total').textContent = h.total.toLocaleString() + ' Ar';
                document.getElementById('achat-modal').style.display = 'flex';

            } else if (h.type === 'vente') {
                // Modal Vente avec paiement
                ouvrirModalVente(idx);
            }
        }

        function ouvrirModalVente(idx) {
            const h = historique[idx];

            const modalHTML = `
                <div class="modal-overlay" id="vente-modal" style="display:flex;">
                    <div class="modal" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3>💰 Détail Vente - ${h.numero}</h3>
                            <button class="modal-close" onclick="fermerModalVente()">×</button>
                        </div>
                        <div class="modal-body">
                            <p class="modal-info">Date: ${h.date} | Client: ${h.tiers} | Adresse: ${h.adresse || 'N/A'}</p>

                            <table class="modal-table">
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Qté</th>
                                        <th>Unit</th>
                                        <th>P.U</th>
                                        <th>Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${h.articles.map(a => `
                                        <tr>
                                            <td>${a.produit}</td>
                                            <td>${a.quantite}</td>
                                            <td>${a.unite}</td>
                                            <td>${a.prix.toLocaleString()} Ar</td>
                                            <td>${a.total.toLocaleString()} Ar</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" style="text-align:right;font-weight:600">Total</td>
                                        <td>${h.total.toLocaleString()} Ar</td>
                                    </tr>
                                </tfoot>
                            </table>

                            ${h.statutPaiement !== 'payé' ? `
                                <div style="background:#fef3c7; padding:12px; border-radius:8px; margin-top:16px; border-left:4px solid #f59e0b;">
                                    <strong>💳 Informations paiement</strong><br>
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                                        <div>Montant total: <strong>${h.total.toLocaleString()} Ar</strong></div>
                                        <div>Échéance: <strong>${h.dateLimite || 'N/A'}</strong></div>
                                        <div>Déjà payé: <strong style="color:#16a34a;">${(h.montantPaye || 0).toLocaleString()} Ar</strong></div>
                                        <div>Reste: <strong style="color:#dc2626;">${(h.total - (h.montantPaye || 0)).toLocaleString()} Ar</strong></div>
                                    </div>
                                    <p style="margin-top:10px; font-size:12px; color:#92400e;">Aucun paiement enregistré.</p>

                                    <button class="btn btn-success" onclick="marquerPaye(${idx}); fermerModalVente();" style="margin-top:12px; width:100%;">
                                        ✓ Enregistrer un paiement
                                    </button>
                                </div>
                            ` : `
                                <div style="background:#dcfce7; padding:12px; border-radius:8px; margin-top:16px; border-left:4px solid #16a34a;">
                                    <strong style="color:#166534;">✓ Vente payée</strong><br>
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px; color:#166534;">
                                        <div>Date paiement: <strong>${h.datePayement || 'N/A'}</strong></div>
                                        <div>Mode: <strong>${h.moyenPaiement || 'N/A'}</strong></div>
                                        <div>Montant: <strong>${(h.montantPaye || 0).toLocaleString()} Ar</strong></div>
                                    </div>
                                </div>
                            `}

                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:16px;">
                                <button class="btn btn-pdf" onclick="genererPDFDepuisHistorique(historique[${idx}],'facture')">
                                    📄 Facture
                                </button>
                                <button class="btn btn-info" onclick="genererPDFDepuisHistorique(historique[${idx}],'bon')">
                                    🚚 Bon livraison
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Supprimer ancien modal s'il existe
            const oldModal = document.getElementById('vente-modal');
            if (oldModal) oldModal.remove();

            // Insérer le nouveau modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function fermerModalVente() {
            const modal = document.getElementById('vente-modal');
            if (modal) modal.remove();
        }

        function fermerAchatModal() {
            document.getElementById('achat-modal').style.display = 'none';
        }
        // ========== GESTION PAIEMENT - Marquer Payé ==========
        function marquerPaye(idx) {
            const h = historique[idx];

            if(h.type !== 'vente') {
                alert('Erreur: Ce n\'est pas une vente');
                return;
            }

            if(h.statutPaiement === 'payé') {
                alert('Cette vente est déjà marquée comme payée');
                return;
            }

            // Confirmation
            const montant = h.total - (h.montantPaye || 0);
            const confirmer = confirm(
                `Marquer cette vente comme payée?\n\n` +
                `Numéro: ${h.numero}\n` +
                `Client: ${h.tiers}\n` +
                `Montant: ${montant.toLocaleString()} Ar\n` +
                `Date: ${h.date}`
            );

            if(!confirmer) return;

            // Créer modal pour choix mode paiement
            const modalHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: #111827;">Mode de paiement</h3>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Choisissez le mode de paiement:</label>
                        <select id="moyen-paiement-select" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px;">
                            <option value="Espèces">Espèces</option>
                            <option value="Chèque">Chèque</option>
                            <option value="Virement bancaire">Virement bancaire</option>
                            <option value="Mobile Money">Mobile Money (Mvola, Orange Money...)</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>

                    <div id="autre-moyen-wrap" style="display: none; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Précisez:</label>
                        <input type="text" id="autre-moyen-input" placeholder="Ex: Carte bancaire..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px;">
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="confirmerPaiement(${idx})" class="btn btn-success" style="flex: 1;">✓ Confirmer</button>
                        <button onclick="annulerModalPaiement()" class="btn" style="flex: 1;">Annuler</button>
                    </div>
                </div>
            `;

            // Créer le modal
            const modal = document.createElement('div');
            modal.id = 'modal-paiement';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; border-radius: 15px; max-width: 400px; width: 90%;';
            modalContent.innerHTML = modalHTML;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Afficher input si "Autre" sélectionné
            const selectEl = document.getElementById('moyen-paiement-select');
            const autreWrap = document.getElementById('autre-moyen-wrap');
            selectEl.addEventListener('change', function() {
                autreWrap.style.display = this.value === 'Autre' ? 'block' : 'none';
            });
        }

        function confirmerPaiement(idx) {
            const selectEl = document.getElementById('moyen-paiement-select');
            let moyen = selectEl.value;

            if(moyen === 'Autre') {
                const autreInput = document.getElementById('autre-moyen-input');
                moyen = autreInput.value.trim();
                if(!moyen) {
                    alert('Veuillez préciser le mode de paiement');
                    return;
                }
            }

            const h = historique[idx];

            // Mise à jour
            h.statutPaiement = 'payé';
            h.datePayement = new Date().toISOString().split('T')[0];
            h.montantPaye = h.total;
            h.moyenPaiement = moyen;

            // Sauvegarde
            sauvegarderDonnees();
            afficherHistorique();
            updateDashboard();
            updateNotificationBadge();

            // Fermer modal
            annulerModalPaiement();

            alert(`✓ Vente marquée comme payée par ${moyen}!`);
        }

        function annulerModalPaiement() {
            const modal = document.getElementById('modal-paiement');
            if(modal) modal.remove();
        }

        function annulerPaiement(idx) {
            const h = historique[idx];

            if(h.type !== 'vente') return;

            const confirmer = confirm(
                `Annuler le paiement de cette vente?\n\n` +
                `Numéro: ${h.numero}\n` +
                `Client: ${h.tiers}`
            );

            if(!confirmer) return;

            h.statutPaiement = 'impayé';
            h.datePayement = null;
            h.montantPaye = 0;
            h.moyenPaiement = null;

            sauvegarderDonnees();
            afficherHistorique();
            updateDashboard();
            updateNotificationBadge();

            alert('✓ Paiement annulé');
        }

        function voirDetail(h) {
            let msg = `Type: ${h.type}\nDate: ${h.date}\nTiers: ${h.tiers}\nTotal: ${h.total.toLocaleString()} Ar\n`;
            h.articles.forEach(a => {
                msg += `- ${a.produit} ${a.quantite} ${a.unite} x ${a.prix.toLocaleString()} = ${a.total.toLocaleString()} Ar\n`;
            });

            // "preuve" amin'ny IndexedDB: mijery fileKey
            if (h.pieces && h.pieces.length && h.pieces[0].fileKey) {
                const p = h.pieces[0];
                const ok = confirm(msg + `\nFacture: ${p.name}\n\nOuvrir la facture maintenant ?`);
                if (ok) ouvrirFactureHistorique(h);
                return;
            }

            alert(msg);
        }

        // ========== FONCTIONS MODAL SÉLECTION FORMAT Facture BL Proforma ==========

        // Ouvrir le modal de sélection
        function openFormatModal(invoiceType, invoiceData) {
            currentInvoiceType = invoiceType;
            currentInvoiceData = invoiceData;
            selectedFormat = null;
            
            // Réinitialiser les cartes
            document.querySelectorAll('.format-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Désactiver le bouton de confirmation
            document.getElementById('confirm-format-btn').disabled = true;
            
            // Afficher le modal
            document.getElementById('format-modal-overlay').classList.add('active');
        }

        // Fermer le modal
        function closeFormatModal() {
            document.getElementById('format-modal-overlay').classList.remove('active');
            selectedFormat = null;
            currentInvoiceType = null;
            currentInvoiceData = null;
        }

        // Sélectionner un format
        function selectFormat(format) {
            selectedFormat = format;
            
            // Retirer la classe selected de toutes les cartes
            document.querySelectorAll('.format-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Ajouter la classe selected à la carte cliquée
            event.currentTarget.classList.add('selected');
            
            // Activer le bouton de confirmation
            document.getElementById('confirm-format-btn').disabled = false;
        }

        // Confirmer et générer le PDF
        function confirmFormat() {
            if (!selectedFormat || !currentInvoiceType || !currentInvoiceData) {
                alert('Erreur : format ou données manquantes');
                return;
            }
            
            // Fermer le modal
            closeFormatModal();
            
            // Générer le PDF avec le format choisi
            if (selectedFormat === 'ticket') {
                genererPDFTicket(currentInvoiceType, currentInvoiceData);
            } else if (selectedFormat === 'a4') {
                genererPDFA4(currentInvoiceType, currentInvoiceData);
            }
        }

        // Fermer le modal si on clique en dehors
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('format-modal-overlay');
            if (e.target === overlay) {
                closeFormatModal();
            }
        });

        // ========== GÉNÉRATION PDF FORMAT A4 ==========

        function genererPDFA4(type, data) {
            const container = document.getElementById('pdf-preview-a4');
            
            // Déterminer le titre selon le type
            let titre = 'FACTURE';
            if (type === 'proforma') titre = 'FACTURE PROFORMA';
            if (type === 'bon') titre = 'BON DE LIVRAISON';
            
            // Calculer la date d'échéance
            const dateFacture = new Date(data.date);
            const delaiJours = parseInt(data.delai) || 30;
            const dateEcheance = new Date(dateFacture);
            dateEcheance.setDate(dateEcheance.getDate() + delaiJours);
            
            // Construire le HTML pour A4
            let html = `
                <div style="font-family: Arial, sans-serif; font-size: 12px; color: #1e293b;">
                    
                    <!-- En-tête avec logo et infos client -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                        
                        <!-- Partie gauche : Logo + infos fournisseur -->
                        <div style="flex: 1;">
                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
                                ${appLogoData ? `<img src="${appLogoData}" style="width: 150px; height: auto; margin-bottom: 15px;">` : `<div style="font-size: 24px; font-weight: 700; color: #111827; margin-bottom: 15px;">${nomEntreprise}</div>`}
                                
                                <div style="font-size: 10px; line-height: 1.8; color: #334155;">
                                    <p style="margin: 3px 0;"><strong style="font-weight: 600; color: #1e293b; min-width: 100px; display: inline-block;">Entreprise :</strong> ${nomEntreprise}</p>
                                    <p style="margin: 3px 0;"><strong style="font-weight: 600; color: #1e293b; min-width: 100px; display: inline-block;">Adresse :</strong> ${adresseEntreprise}</p>
                                    <p style="margin: 3px 0;"><strong style="font-weight: 600; color: #1e293b; min-width: 100px; display: inline-block;">Téléphone :</strong> ${telEntreprise}</p>
                                    <p style="margin: 3px 0;"><strong style="font-weight: 600; color: #1e293b; min-width: 100px; display: inline-block;">Email :</strong> ${emailEntreprise}</p>
                                    ${nifEntreprise ? `<p style="margin: 3px 0;"><strong style="font-weight: 600; color: #1e293b; min-width: 100px; display: inline-block;">NIF :</strong> ${nifEntreprise}</p>` : ''}
                                    ${statEntreprise ? `<p style="margin: 3px 0;"><strong style="font-weight: 600; color: #1e293b; min-width: 100px; display: inline-block;">STAT :</strong> ${statEntreprise}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Partie droite : Infos client -->
                        <div style="flex: 1; margin-left: 20px;">
                            <div style="background: linear-gradient(145deg, #ffffff 0%, #f0f4ff 100%); padding: 25px; border-radius: 16px; box-shadow: 0 8px 20px rgba(59,130,246,0.25); border: 3px solid #3b82f6;">
                                <p style="margin: 8px 0; font-size: 13px; color: #1e293b; text-align: right;">
                                    <strong style="font-weight: 800; color: #3b82f6; min-width: 100px; display: inline-block; text-align: right;">CLIENT :</strong> ${data.client}
                                </p>
                                <p style="margin: 8px 0; font-size: 13px; color: #1e293b; text-align: right;">
                                    <strong style="font-weight: 800; color: #3b82f6; min-width: 100px; display: inline-block; text-align: right;">ADRESSE :</strong> ${data.adresse}
                                </p>
                                
                                <div style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); padding: 12px 15px; border-radius: 10px; border-left: 5px solid #3b82f6; margin-top: 15px;">
                                    <p style="margin: 0; font-size: 15px; font-weight: 900; color: #3730a3; text-transform: uppercase; letter-spacing: 0.5px;">
                                        ${titre} N° ${data.numero}
                                    </p>
                                    <p style="margin: 4px 0 0 0; font-size: 10px; color: #6366f1; font-weight: 600;">
                                        Date : ${formatDate(data.date)}
                                    </p>
                                    ${type !== 'bon' ? `<p style="margin: 4px 0 0 0; font-size: 10px; color: #6366f1; font-weight: 600;">
                                        Échéance : ${formatDate(dateEcheance.toISOString().split('T')[0])}
                                    </p>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tableau des articles -->
                    <table style="width: 100%; border-collapse: collapse; margin: 25px 0;">
                        <thead>
                            <tr>
                                <th style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; text-align: left; font-size: 11px; font-weight: 600; text-transform: uppercase;">Description</th>
                                <th style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; text-align: center; font-size: 11px; font-weight: 600; text-transform: uppercase;">Qté</th>
                                <th style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; text-align: center; font-size: 11px; font-weight: 600; text-transform: uppercase;">Unité</th>
                                <th style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; text-align: right; font-size: 11px; font-weight: 600; text-transform: uppercase;">P.U.</th>
                                <th style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; text-align: right; font-size: 11px; font-weight: 600; text-transform: uppercase;">Montant</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Ajouter les lignes d'articles
            data.articles.forEach((article, index) => {
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f8fafc';
                html += `
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 10px; background: ${bgColor}; font-size: 11px;">${article.produit}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; background: ${bgColor}; font-size: 11px;">${article.quantite}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: center; background: ${bgColor}; font-size: 11px;">${article.unite}</td>
                        <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: right; background: ${bgColor}; font-size: 11px;">${formatNumber(article.prix)} Ar</td>
                        <td style="border: 1px solid #e5e7eb; padding: 10px; text-align: right; background: ${bgColor}; font-size: 11px; font-weight: 600;">${formatNumber(article.quantite * article.prix)} Ar</td>
                    </tr>
                `;
            });
            
            // Ligne de total
            html += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; padding: 12px; text-align: right; font-size: 13px; font-weight: 700; color: #92400e;">TOTAL</td>
                                <td style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; padding: 12px; text-align: right; font-size: 14px; font-weight: 700; color: #92400e;">${formatNumber(data.total)} Ar</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <!-- Pied de page -->
                    <div style="margin-top: 35px; font-size: 12px; line-height: 1.8; color: #334155;">
                        ${type !== 'bon' ? `
                        <p style="margin: 12px 0;"><strong style="color: #1e293b; font-weight: 600;">Délai de paiement :</strong> ${data.delai} jours</p>
                        <p style="margin: 12px 0;"><strong style="color: #1e293b; font-weight: 600;">Mode de paiement :</strong> Virement bancaire / Chèque / Espèces</p>
                        ` : ''}
                        <p style="margin: 12px 0;"><strong style="color: #1e293b; font-weight: 600;">Merci de votre confiance !</strong></p>
                    </div>
                    
                    <div style="margin-top: 60px; text-align: right; font-weight: 700; color: #1e293b; font-size: 13px;">
                        Signature
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Générer le PDF avec html2canvas + jsPDF
            setTimeout(() => {
                html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`${titre.replace(/ /g, '_')}_${data.numero}_${data.client}.pdf`);
                });
            }, 100);
        }

        async function ouvrirFactureHistorique(h) {
            const p = h.pieces?.[0];
            if (!p?.fileKey) {
                alert("Tsy misy facture voatahiry amin'ity opération ity.");
                return;
            }

            // Sokafy avy hatrany (tsy mbola miandry await) => tsy voablock matetika
            const win = window.open('about:blank', '_blank');
            if (!win) {
                alert("Bloqué ny popup. Alefaso (Allow popups) dia andramo indray.");
                return;
            }
            win.document.title = "Chargement facture...";

            try {
                const blob = await idbGetFacture(p.fileKey);
                if (!blob) {
                    win.close();
                    alert("Tsy hita intsony ilay facture (IndexedDB).");
                    return;
                }

                const url = URL.createObjectURL(blob);
                win.location.href = url;

                // cleanup aoriana kely
                setTimeout(() => URL.revokeObjectURL(url), 60_000);
            } catch (e) {
                console.error(e);
                win.close();
                alert("Erreur rehefa manokatra facture.");
            }
        }



        function sauvegarderConfig() {
            config.nom = document.getElementById('config-nom').value;
            config.activite = document.getElementById('config-activite').value;
            config.adresse = document.getElementById('config-adresse').value;
            config.nif = document.getElementById('config-nif').value;
            config.stat = document.getElementById('config-stat').value;
            config.rc = document.getElementById('config-rc').value;
            config.responsable = document.getElementById('config-responsable').value;
            config.banque = document.getElementById('config-banque').value;
            config.paiement = document.getElementById('config-paiement').value;
            config.alerteEcheance = parseInt(document.getElementById('config-alerte').value) || 7;
            sauvegarderDonnees();
            alert('Configuration enregistrée');
        }

        function chargerLogo() {
            const input = document.getElementById('logo-input');
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                config.logo = e.target.result;
                document.getElementById('logo-preview').src = config.logo;
                document.getElementById('logo-preview').style.display = 'block';
                document.getElementById('logo-text').textContent = 'Logo chargé';
                sauvegarderDonnees();
            };
            reader.readAsDataURL(file);
        }

        // ========== AVATAR UPLOAD ==========
        function ouvrirUploadAvatar() {
            const input = document.getElementById('avatar-input');
            if (input) input.click();
        }

        

        // ========== AVATAR UPLOAD ==========
        function appliquerAvatarUI(dataUrl) {
            const avatarEl = document.getElementById('dash-user-avatar');
            if (!avatarEl) return;
            
            avatarEl.innerHTML = ''; // Esory ilay "M"
            const img = document.createElement('img');
            img.src = dataUrl;
            avatarEl.appendChild(img);
        }

        // Event listener - tsy misy ao anatin'ny fonction hafa
        window.addEventListener('DOMContentLoaded', function() {
            const avatarInput = document.getElementById('avatar-input');
            if (avatarInput) {
                avatarInput.addEventListener('change', function() {
                    const file = this.files && this.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const dataUrl = e.target.result;
                        
                        // Sauvegarde ao config
                        config.avatar = dataUrl;
                        sauvegarderDonnees();
                        
                        // Affichage avy hatrany
                        appliquerAvatarUI(dataUrl);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        // Event listener app logo
        window.addEventListener('DOMContentLoaded', function() {
            const appLogoInput = document.getElementById('app-logo-input');
            if (appLogoInput) {
                appLogoInput.addEventListener('change', function() {
                    const file = this.files && this.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const dataUrl = e.target.result;
                        
                        // Sauvegarde
                        config.appLogo = dataUrl;
                        sauvegarderDonnees();
                        
                        // Affichage
                        appliquerAppLogoUI(dataUrl);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        // ========== APP LOGO UPLOAD ==========
        function appliquerAppLogoUI(dataUrl) {
            // Header logo
            const headerLogo = document.getElementById('app-logo-mark');
            if (headerLogo) {
                headerLogo.innerHTML = '';
                const img = document.createElement('img');
                img.src = dataUrl;
                headerLogo.appendChild(img);
            }
            
            // Sidebar logo
            const sidebarLogo = document.getElementById('sidebar-logo-mark');
            if (sidebarLogo) {
                sidebarLogo.innerHTML = '';
                const img = document.createElement('img');
                img.src = dataUrl;
                sidebarLogo.appendChild(img);
            }
        }
        function nettoyerHistoriquePieces(histo) {
            return (histo || []).map(h => {
                if (!h || !h.pieces) return h;
                const pieces = h.pieces.map(p => {
                    if (!p) return p;
                    const cp = { ...p };
                    // ESORY IREO "base64" taloha
                    delete cp.dataUrl;
                    return cp;
                });
                return { ...h, pieces };
            });
        }


        async function sauvegarderDonnees() {
            try {
                // ✅ Save to IndexedDB instead of LocalStorage
                await idbSave('stock', 'data', stock);
                await idbSave('historique', 'data', historique);
                await idbSave('config', 'data', config);
                await idbSave('demandesPrix', 'data', demandesPrix);
                
                console.log('✅ Données sauvegardées dans IndexedDB');
            } catch(e) {
                console.error('❌ Erreur sauvegarde:', e);
            }
        }

        async function chargerDonnees() {
            try {
                // ✅ Load from IndexedDB
                const s = await idbLoad('stock', 'data');
                const h = await idbLoad('historique', 'data');
                const c = await idbLoad('config', 'data');
                const dpData = await idbLoad('demandesPrix', 'data');

                stock = s || {};
                historique = h || [];
                config = c || {};
                demandesPrix = dpData || [];

                // ✅ MIGRATION - Si vide, essayer LocalStorage (backward compatibility)
                if(Object.keys(stock).length === 0) {
                    const lsStock = localStorage.getItem('stock-data');
                    const lsHisto = localStorage.getItem('historique-data');
                    const lsConfig = localStorage.getItem('config-data');
                    const lsDP = localStorage.getItem('demandes-prix-data');
                    
                    if(lsStock || lsHisto || lsConfig || lsDP) {
                        console.log('🔄 Migration LocalStorage → IndexedDB...');
                        
                        stock = lsStock ? JSON.parse(lsStock) : {};
                        historique = lsHisto ? JSON.parse(lsHisto) : [];
                        config = lsConfig ? JSON.parse(lsConfig) : {};
                        demandesPrix = lsDP ? JSON.parse(lsDP) : [];
                        
                        // Save to IndexedDB
                        await idbSave('stock', 'data', stock);
                        await idbSave('historique', 'data', historique);
                        await idbSave('config', 'data', config);
                        await idbSave('demandesPrix', 'data', demandesPrix);
                        
                        // Clear LocalStorage
                        localStorage.removeItem('stock-data');
                        localStorage.removeItem('historique-data');
                        localStorage.removeItem('config-data');
                        localStorage.removeItem('demandes-prix-data');
                        
                        console.log('✅ Migration réussie!');
                    }
                }

                // --- NORMALISATION STOCK (lots) ---
                Object.keys(stock).forEach(p => {
                    const item = stock[p] || {};
                    stock[p] = item;

                    // 1) Raha ancien format: { quantite, prixMoyen } -> avadika ho lots
                    if(!Array.isArray(item.lots)) item.lots = [];
                    if(item.lots.length === 0 && (item.quantite != null || item.prixMoyen != null)) {
                        const q = Number(item.quantite || 0);
                        const pr = Number(item.prixMoyen || 0);
                        if(q > 0) item.lots.push({ qte: q, prix: pr, date: item.date || new Date().toISOString().slice(0,10) });
                    }

                    // 2) Raha lots efa misy fa clé tsy mitovy: quantite/prixMoyen -> qte/prix
                    item.lots = item.lots.map(l => ({
                        ...l,
                        qte: Number(l.qte ?? l.quantite ?? 0),
                        prix: Number(l.prix ?? l.prixAchat ?? l.prixMoyen ?? 0)
                    })).filter(l => Number(l.qte) > 0);

                    // 3) Unit default
                    if(!item.unite) item.unite = 'Pièce';
                });

                // --- CONFIG UI ---
                document.getElementById('config-nom').value = config.nom || '';
                document.getElementById('config-activite').value = config.activite || '';
                document.getElementById('config-adresse').value = config.adresse || '';
                document.getElementById('config-nif').value = config.nif || '';
                document.getElementById('config-stat').value = config.stat || '';
                document.getElementById('config-rc').value = config.rc || '';
                document.getElementById('config-responsable').value = config.responsable || '';
                document.getElementById('config-banque').value = config.banque || '';
                document.getElementById('config-paiement').value = config.paiement || '';
                document.getElementById('config-alerte').value = config.alerteEcheance || 7;

                afficherStock();
                afficherHistorique();
                afficherDemandesPrix();
                updateDashboard();
                updateDashStockCard();
                requestAnimationFrame(() => drawRevenueChart());
                updateStockValueUI({ objectif: 500000 });

                // --- CONFIG IMAGES ---
                if (config.logo) {
                    document.getElementById('logo-preview').src = config.logo;
                    document.getElementById('logo-preview').style.display = 'block';
                    document.getElementById('logo-text').textContent = 'Logo chargé';
                }

                // ⭐ AVATAR USER
                if (config.avatar) {
                    appliquerAvatarUI(config.avatar);
                }

                // ⭐ APP LOGO
                if (config.appLogo) {
                    appliquerAppLogoUI(config.appLogo);
                }

                console.log('✅ Données chargées depuis IndexedDB');

            } catch(e) {
                console.error('❌ Erreur chargement IndexedDB:', e);
                // Fallback: essayer LocalStorage
                console.log('🔄 Fallback LocalStorage...');
                chargerDepuisLocalStorageFallback();
            }
        }

        // ✅ Fallback function (au cas où IndexedDB fail)
        function chargerDepuisLocalStorageFallback() {
            const s = localStorage.getItem('stock-data');
            const h = localStorage.getItem('historique-data');
            const c = localStorage.getItem('config-data');
            const dpData = localStorage.getItem('demandes-prix-data');

            stock = s ? JSON.parse(s) : {};
            historique = h ? JSON.parse(h) : [];
            config = c ? JSON.parse(c) : {};
            demandesPrix = dpData ? JSON.parse(dpData) : [];

            console.log('✅ Chargé depuis LocalStorage (fallback)');
        }

        async function migrerDepuisLocalStorage() {
            const saved = localStorage.getItem('gestion-achat-vente');
            if(!saved) return;
            
            try {
                const data = JSON.parse(saved);
                
                // Save to IndexedDB
                if(data.stock) await idbSave('stock', 'data', data.stock);
                if(data.historique) await idbSave('historique', 'data', data.historique);
                if(data.config) await idbSave('config', 'data', data.config);
                if(data.demandesPrix) await idbSave('demandesPrix', 'data', data.demandesPrix);
                
                console.log('✅ Migration LocalStorage → IndexedDB réussie!');
                
                // Clear LocalStorage après migration
                localStorage.removeItem('gestion-achat-vente');
            } catch(e) {
                console.error('❌ Erreur migration:', e);
            }
        }

        // ✅ AFFICHER CARD "PAIEMENTS URGENTS"
        // ========================================
        // ✅ PAIEMENTS URGENTS - GLOBAL SCOPE
        // ========================================

        function afficherCardPaiementsUrgents() {
            const histData = typeof historique !== 'undefined' && Array.isArray(historique) ? historique : JSON.parse(localStorage.getItem('historique-data') || '[]');
            const today = new Date().toISOString().slice(0, 10);
            
            const facturesAujourdhui = histData.filter(h => 
                h.type === 'vente' && 
                h.statutPaiement && 
                h.statutPaiement !== 'payé' && 
                h.statutPaiement !== 'pay\u00E9' && 
                h.dateLimite === today
            );
            
            const facturesRetard = histData.filter(h => 
                h.type === 'vente' && 
                h.statutPaiement && 
                h.statutPaiement !== 'payé' && 
                h.statutPaiement !== 'pay\u00E9' && 
                h.dateLimite && 
                h.dateLimite < today
            );

            let container = document.getElementById('card-paiements-urgents');
            if(!container) {
                container = document.createElement('div');
                container.id = 'card-paiements-urgents';
                container.className = 'dash-right-card';
                const dashRight = document.querySelector('.dash-right');
                if(!dashRight) {
                    console.error('.dash-right INTROUVABLE!');
                    return;
                }
                dashRight.insertBefore(container, dashRight.firstChild);
            }

            const totalEnRetard = facturesRetard.length;
            const totalAujourdhui = facturesAujourdhui.length;
            const montantTotal = [...facturesRetard, ...facturesAujourdhui]
                .reduce((sum, h) => sum + (h.total - (h.montantPaye || 0)), 0);

            if(totalEnRetard === 0 && totalAujourdhui === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            
            container.innerHTML = `
                <div class="dash-right-title" style="display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-exclamation-circle" style="color: #6b7280; font-size: 16px;"></i>
                    Paiements urgents
                </div>
                <div class="dash-right-sub" style="margin-top: 4px; font-size: 12px; color: #64748b;">
                    ${totalEnRetard > 0 ? `${totalEnRetard} en retard` : ''}${totalEnRetard > 0 && totalAujourdhui > 0 ? ' • ' : ''}${totalAujourdhui > 0 ? `${totalAujourdhui} aujourd'hui` : ''}
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #fee2e2; border-radius: 10px; border-left: 3px solid #dc2626;">
                    <div style="font-size: 10px; color: #991b1b; font-weight: 600; margin-bottom: 3px;">MONTANT TOTAL</div>
                    <div style="font-size: 16px; font-weight: 800; color: #dc2626; line-height: 1;">${montantTotal.toLocaleString()} Ar</div>
                </div>
                <button class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 10px; padding: 8px; font-size: 12px;" 
                        onclick="ouvrirModalPaiementsUrgents()">
                    <i class="fa-solid fa-eye"></i> Voir détails
                </button>
            `;
        }

        // ✅ MODAL PAIEMENTS URGENTS - TSY OVAINA
        function ouvrirModalPaiementsUrgents() {
            const histData = typeof historique !== 'undefined' && Array.isArray(historique) ? historique : JSON.parse(localStorage.getItem('historique-data') || '[]');
            const today = new Date().toISOString().slice(0, 10);

            const facturesAujourdhui = histData.filter(h => 
                h.type === 'vente' && 
                h.statutPaiement && 
                h.statutPaiement !== 'payé' && 
                h.statutPaiement !== 'pay\u00E9' && 
                h.dateLimite === today
            );

            const facturesRetard = histData.filter(h => 
                h.type === 'vente' && 
                h.statutPaiement && 
                h.statutPaiement !== 'payé' && 
                h.statutPaiement !== 'pay\u00E9' && 
                h.dateLimite && 
                h.dateLimite < today
            );

            const montantRetard = facturesRetard.reduce((sum, h) => sum + (h.total - (h.montantPaye || 0)), 0);
            const montantAujourdhui = facturesAujourdhui.reduce((sum, h) => sum + (h.total - (h.montantPaye || 0)), 0);

            // Créer liste HTML
            const listeRetard = facturesRetard.map((h, idx) => {
                const reste = h.total - (h.montantPaye || 0);
                const originalIdx = historique.findIndex(item => item === h);
                return `
                    <div style="padding: 10px; background: #fef2f2; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #dc2626; cursor: pointer;"
                        onclick="fermerModalPaiementsUrgents(); sidebarShowTab('historique'); setTimeout(() => { const row = document.querySelectorAll('#historique-tbody tr')[${originalIdx}]; if(row) { row.style.background='#fef3c7'; row.scrollIntoView({behavior:'smooth', block:'center'}); setTimeout(() => row.style.background='', 2000); } }, 100);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: 700; color: #991b1b; font-size: 13px;">${h.numero}</span>
                            <span style="color: #dc2626; font-weight: 900; font-size: 14px;">${reste.toLocaleString()} Ar</span>
                        </div>
                        <div style="font-size: 11px; color: #64748b;">
                            <strong>${h.tiers}</strong> • Échéance: ${h.dateLimite}
                        </div>
                    </div>
                `;
            }).join('');

            const listeAujourdhui = facturesAujourdhui.map((h, idx) => {
                const reste = h.total - (h.montantPaye || 0);
                const originalIdx = historique.findIndex(item => item === h);
                return `
                    <div style="padding: 10px; background: #fef3c7; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #f59e0b; cursor: pointer;"
                        onclick="fermerModalPaiementsUrgents(); sidebarShowTab('historique'); setTimeout(() => { const row = document.querySelectorAll('#historique-tbody tr')[${originalIdx}]; if(row) { row.style.background='#fef3c7'; row.scrollIntoView({behavior:'smooth', block:'center'}); setTimeout(() => row.style.background='', 2000); } }, 100);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: 700; color: #92400e; font-size: 13px;">${h.numero}</span>
                            <span style="color: #b45309; font-weight: 900; font-size: 14px;">${reste.toLocaleString()} Ar</span>
                        </div>
                        <div style="font-size: 11px; color: #64748b;">
                            <strong>${h.tiers}</strong> • <strong style="color: #f59e0b;">Échéance AUJOURD'HUI</strong>
                        </div>
                    </div>
                `;
            }).join('');

            // HTML Modal
            const modalHTML = `
                <div style="padding: 24px; max-width: 600px; width: 90vw; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 16px 0; color: #111827; font-size: 20px;">
                        💰 Paiements urgents - Détails
                    </h3>
                    
                    <!-- Breakdown montant -->
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 12px;">
                        ${montantRetard > 0 ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="color: #dc2626;">⚠️ En retard (${facturesRetard.length})</span>
                                <span style="color: #dc2626; font-weight: 700;">${montantRetard.toLocaleString()} Ar</span>
                            </div>
                        ` : ''}
                        ${montantAujourdhui > 0 ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="color: #f59e0b;">⏰ Aujourd'hui (${facturesAujourdhui.length})</span>
                                <span style="color: #f59e0b; font-weight: 700;">${montantAujourdhui.toLocaleString()} Ar</span>
                            </div>
                        ` : ''}
                        <div style="border-top: 2px solid #d1d5db; margin: 8px 0; padding-top: 8px; display: flex; justify-content: space-between;">
                            <span style="font-weight: 700; color: #111827;">TOTAL</span>
                            <span style="font-weight: 900; color: #dc2626; font-size: 15px;">${(montantRetard + montantAujourdhui).toLocaleString()} Ar</span>
                        </div>
                    </div>
                    
                    <!-- Liste factures en retard -->
                    ${facturesRetard.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 11px; font-weight: 700; color: #991b1b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                                ⚠️ Factures en retard (${facturesRetard.length})
                            </div>
                            ${listeRetard}
                        </div>
                    ` : ''}
                    
                    <!-- Liste factures aujourd'hui -->
                    ${facturesAujourdhui.length > 0 ? `
                        <div>
                            <div style="font-size: 11px; font-weight: 700; color: #92400e; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                                ⏰ Échéance aujourd'hui (${facturesAujourdhui.length})
                            </div>
                            ${listeAujourdhui}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 16px; padding: 10px; background: #e0f2fe; border-radius: 6px; border-left: 3px solid #0284c7; font-size: 11px; color: #075985;">
                        💡 <strong>Astuce:</strong> Cliquez sur une facture pour la voir dans l'historique
                    </div>
                    
                    <button onclick="fermerModalPaiementsUrgents()" 
                            style="width: 100%; margin-top: 16px; background: #111827; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                        Fermer
                    </button>
                </div>
            `;

            // Créer modal
            const modal = document.createElement('div');
            modal.id = 'modal-paiements-urgents';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
            modalContent.innerHTML = modalHTML;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Fermer si click dehors
            modal.addEventListener('click', (e) => {
                if(e.target === modal) fermerModalPaiementsUrgents();
            });
        }

        function fermerModalPaiementsUrgents() {
            const modal = document.getElementById('modal-paiements-urgents');
            if(modal) modal.remove();
        }


        // ✅ AFFICHER CARD "DEMANDES DE PRIX" - VERSION CORRIGÉE
        function afficherCardDemandesPrix() {
            // ✅ CHARGER LES DONNÉES
            const dpData = (typeof demandesPrix !== 'undefined' && Array.isArray(demandesPrix))
                ? demandesPrix
                : JSON.parse(localStorage.getItem('demandes-prix-data') || '[]');
            
            // ✅ FILTRE CORRIGÉ - avec underscore!
            const demandesEnAttente = dpData.filter(d => d.statut === 'en_attente');
            
            let container = document.getElementById('card-demandes-prix');
            if(!container) {
                container = document.createElement('div');
                container.id = 'card-demandes-prix';
                container.className = 'dash-right-card';
                
                const dashRight = document.querySelector('.dash-right');
                if(!dashRight) return;
                
                // Insérer APRÈS Stock status
                const stockCard = dashRight.querySelector('.dash-right-dark');
                if(stockCard && stockCard.nextSibling) {
                    dashRight.insertBefore(container, stockCard.nextSibling);
                } else {
                    dashRight.appendChild(container);
                }
            }
            
            if(demandesEnAttente.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = `
                <div class="dash-right-title" style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 18px;">📋</span>
                    Demandes de prix
                </div>
                <div class="dash-right-sub" style="margin-top: 6px; font-size: 12px; color: #64748b;">
                    ${demandesEnAttente.length} en attente de validation
                </div>
                
                <div style="margin-top: 12px; max-height: 150px; overflow-y: auto;">
                    ${demandesEnAttente.slice(0, 5).map(d => {
                        const nbOffres = d.fournisseurs ? d.fournisseurs.length : 0;
                        return `
                        <div style="padding: 8px 10px; background: #ffffff; border-radius: 8px; margin-bottom: 6px; border-left: 3px solid #f59e0b;">
                            <div style="font-size: 11px; font-weight: 700; color: #111827;">
                                ${d.produit}
                            </div>
                            <div style="font-size: 10px; color: #64748b; margin-top: 2px;">
                                ${d.quantite} ${d.unite} • ${nbOffres} offre${nbOffres > 1 ? 's' : ''}
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
                
                <button class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 12px;" onclick="sidebarShowTab('demande-prix', document.querySelector('.sidebar-link[onclick*=\\'demande-prix\\']'))">
                    <i class="fa-solid fa-scale-balanced"></i> Comparer offres
                </button>
            `;
        }

        function updateDashboard() {

            const stockData = (typeof stock !== 'undefined' && stock)
                ? stock
                : JSON.parse(localStorage.getItem('stock-data') || '{}');

            const histData = (typeof historique !== 'undefined' && Array.isArray(historique))
                ? historique
                : JSON.parse(localStorage.getItem('historique-data') || '[]');

            const cfg = (typeof config !== 'undefined' && config)
                ? config
                : JSON.parse(localStorage.getItem('config-data') || '{}');

            // Helpers date
            const today = new Date();
            const diffDays = (dateStr) => {
                if(!dateStr) return 999;
                const d = new Date(String(dateStr) + 'T00:00:00');
                return Math.floor((today - d) / (1000 * 60 * 60 * 24));
            };
            // ✅ AFFICHER LES CARDS URGENTES (colonne droite)
            afficherCardPaiementsUrgents();
            
            afficherCardDemandesPrix();


            // 1) GREETING + AVATAR
            const name = String(cfg.responsable || cfg.nom || '').trim();
            const titleEl = document.getElementById('dash-title');
            if(titleEl) {
                titleEl.textContent = name ? `Miarahaba, ${name}!` : 'Good morning!';
            }
            
            const avatarEl = document.getElementById('dash-user-avatar');
            if(avatarEl && !avatarEl.querySelector('img')) {
                // Raha tsy misy <img> ao dia aseho initiale ihany
                const initial = name ? name.charAt(0).toUpperCase() : 'M';
                avatarEl.textContent = initial;
            }

            // 2) VALEUR STOCK (somme lot.qte * lot.prix)
            const stockValue = Object.values(stockData).reduce((sum, item) => {
                const lots = Array.isArray(item?.lots) ? item.lots : [];
                const v = lots.reduce((s, l) => s + (Number(l.qte||0) * Number(l.prix||0)), 0);
                return sum + v;
            }, 0);

            const stockValueEl = document.getElementById('kpi-stock-value');
            if(stockValueEl) {
                stockValueEl.textContent = stockValue.toLocaleString('fr-FR') + ' Ar';
            }

            // 3) PRODUITS (isa)
            const productsCount = Object.keys(stockData).length;
            const productsEl = document.getElementById('kpi-products');
            if(productsEl) {
                productsEl.textContent = String(productsCount);
            }

            // 4) TRANSACTIONS 30j (achat + vente)
            const tx30 = histData.filter(h => diffDays(h.date) >= 0 && diffDays(h.date) <= 30).length;
            const txEl = document.getElementById('kpi-transactions-30d');
            if(txEl) {
                txEl.textContent = String(tx30);
            }

            // 5) VENTES 7j (somme total type vente)
            const sales7 = histData
                .filter(h => h.type === 'vente' && diffDays(h.date) >= 0 && diffDays(h.date) <= 7)
                .reduce((sum, h) => sum + Number(h.total || 0), 0);

            const sales7El = document.getElementById('kpi-sales-7d');
            if(sales7El) {
                sales7El.textContent = sales7.toLocaleString('fr-FR') + ' Ar';
            }

            // 6) NEW CLIENTS 30j (clients vaovao)
            const clients30El = document.getElementById('kpi-clients-30d');
            if(clients30El) {
                const recentVentes = histData.filter(h => 
                    h.type === 'vente' && diffDays(h.date) >= 0 && diffDays(h.date) <= 30
                );
                const uniqueClients = new Set(recentVentes.map(v => v.tiers || v.client).filter(Boolean));
                clients30El.textContent = String(uniqueClients.size);
            }

            // 8) STOCK STATUS + PROGRESS BAR
            const items = Object.values(stockData);
            const totalProducts = items.length;
            
            if(totalProducts > 0) {
                const rupture = items.filter(it => {
                    const qte = Array.isArray(it?.lots) 
                        ? it.lots.reduce((s, l) => s + Number(l.qte||0), 0)
                        : Number(it.quantite || 0);
                    return qte <= 0;
                }).length;
                
                const low = items.filter(it => {
                    const qte = Array.isArray(it?.lots) 
                        ? it.lots.reduce((s, l) => s + Number(l.qte||0), 0)
                        : Number(it.quantite || 0);
                    return qte > 0 && qte <= 5;
                }).length;
                
                const ok = totalProducts - rupture - low;
                const pct = Math.round((ok / totalProducts) * 100);
                
                const statusEl = document.getElementById('dash-stock-status');
                const progressEl = document.getElementById('dash-stock-progress');
                
                if(statusEl) {
                    statusEl.textContent = `${pct}% OK`;
                }
                if(progressEl) {
                    progressEl.style.width = `${pct}%`;
                }
                // Mise à jour des KPI de période
                updateKPITransactionsPeriode();
                updateKPIVentesPeriode();
            }

            // 9) CHART VENTES 7 JOURS
            const chartEl = document.getElementById('dash-chart');
            if(chartEl && typeof drawLineChart === 'function') {
                // Prepare data: array of {date, value}
                const last7Days = [];
                for(let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    
                    const dayVentes = histData
                        .filter(h => h.type === 'vente' && h.date === dateStr)
                        .reduce((sum, h) => sum + Number(h.total || 0), 0);
                    
                    last7Days.push({date: dateStr, value: dayVentes});
                }
                
                drawLineChart('dash-chart', last7Days);
            }
        }

        function ouvrirDatePicker() {
            const datePicker = document.getElementById('dash-date-picker');
            
            if (!datePicker) {
                console.error('❌ Date picker introuvable');
                return;
            }
            
            // Valeur par défaut = aujourd'hui
            if (!datePicker.value) {
                datePicker.value = new Date().toISOString().split('T')[0];
            }
            
            // ✅ Retirer ancien onchange pour éviter les doublons
            datePicker.onchange = null;
            
            // Écouter changement UNE SEULE FOIS
            datePicker.onchange = function() {
                const dateValue = this.value;
                
                if (!dateValue) {
                    console.warn('⚠️ Aucune date sélectionnée');
                    masquerDatePicker();
                    return;
                }
                
                try {
                    const selectedDate = new Date(dateValue + 'T00:00:00');
                    
                    // Vérifier date valide
                    if (isNaN(selectedDate.getTime())) {
                        throw new Error('Date invalide');
                    }
                    
                    // Message de confirmation
                    alert(`📅 ${selectedDate.toLocaleDateString('fr-FR', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    })}`);
                    
                    // Mettre à jour dashboard
                    updateDashboard();
                    if (typeof drawRevenueChart === 'function') {
                        drawRevenueChart();
                    }
                    
                } catch (err) {
                    console.error('❌ Erreur date:', err);
                    alert('❌ Date invalide');
                }
                
                // ✅ Masquer le picker après sélection
                masquerDatePicker();
            };
            
            // ✅ Afficher temporairement (iOS/iPhone compatible)
            afficherDatePicker();
            
            // Focus + ouverture
            setTimeout(() => {
                datePicker.focus();
                
                // Essayer showPicker() (Chrome/Android)
                if (typeof datePicker.showPicker === 'function') {
                    try {
                        datePicker.showPicker();
                    } catch (err) {
                        // iOS: click() en fallback
                        datePicker.click();
                    }
                } else {
                    // iOS Safari
                    datePicker.click();
                }
            }, 50);
        }

        function afficherDatePicker() {
            const datePicker = document.getElementById('dash-date-picker');
            if (!datePicker) return;
            
            datePicker.style.visibility = 'visible';
            datePicker.style.position = 'fixed';
            datePicker.style.top = '50%';
            datePicker.style.left = '50%';
            datePicker.style.transform = 'translate(-50%, -50%)';
            datePicker.style.zIndex = '9999';
            datePicker.style.opacity = '1';
            datePicker.style.pointerEvents = 'auto';
            datePicker.style.width = 'auto';
            datePicker.style.height = 'auto';
            datePicker.style.padding = '10px';
            datePicker.style.border = '2px solid #111827';
            datePicker.style.borderRadius = '10px';
            datePicker.style.background = 'white';
            datePicker.style.fontSize = '14px';
        }

        function masquerDatePicker() {
            const datePicker = document.getElementById('dash-date-picker');
            if (!datePicker) return;
            
            datePicker.style.visibility = 'hidden';
            datePicker.style.position = 'absolute';
            datePicker.style.left = '-9999px';
            datePicker.style.top = '-9999px';
            datePicker.style.opacity = '0';
            datePicker.style.pointerEvents = 'none';
        }

        function updateDashStockCard(){
            const statusEl = document.getElementById('dash-stock-status');
            const barEl = document.getElementById('dash-stock-progress');
            if(!statusEl || !barEl) return;

            const items = Object.values(stock || {});
            const total = items.length;

            if(total === 0){
                statusEl.textContent = 'Aucun produit';
                barEl.style.width = '0%';
                return;
            }

            const rupture = items.filter(it => Number(it.quantite || 0) <= 0).length;
            const low = items.filter(it => Number(it.quantite || 0) > 0 && Number(it.quantite || 0) <= 5).length;
            const ok = total - rupture;

            // Texte
            if(rupture > 0) statusEl.textContent = 'Rupture';
            else if(low > 0) statusEl.textContent = 'Faible';
            else statusEl.textContent = 'OK';

            // Progress = % produits mbola misy stock (quantite > 0)
            barEl.style.width = Math.round((ok / total) * 100) + '%';
        }


        function drawRevenueChart(){
            const svg = document.getElementById('dash-chart');
            const tip = document.getElementById('dash-tooltip');
            if(!svg) return;

            const days = 7;
            const today = new Date();
            const dayKey = (d) => d.toISOString().slice(0,10);

            const sumByDay = (type, startOffset, endOffset) => {
                const map = {};
                for(let i = startOffset; i >= endOffset; i--){
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    map[dayKey(d)] = 0;
                }
                (historique || []).forEach(h => {
                    if(h.type !== type) return;
                    if(map[h.date] != null) map[h.date] += Number(h.total || 0);
                });
                const keys = Object.keys(map).sort();
                return { keys, values: keys.map(k => map[k]) };
            };

            const salesPrev = sumByDay('vente', 14, 8); // ventes semaine précédente
            const salesCurr = sumByDay('vente', 7, 1);  // ventes 7 derniers jours
            const buyCurr   = sumByDay('achat', 7, 1);  // achats 7 derniers jours

            const maxV = Math.max(1, ...salesPrev.values, ...salesCurr.values, ...buyCurr.values);

            const W=700, H=260, padL=46, padR=16, padT=18, padB=34;
            const xStep = (W - padL - padR) / (days-1);
            const x = (i) => padL + i*xStep;
            const y = (v) => (H - padB) - (v/maxV) * (H - padT - padB);

            const pts = (arr) => arr.map((v,i) => ({x:x(i), y:y(v), v, i}));

            const smoothPath = (p) => {
                if(p.length < 2) return '';
                let d = `M ${p[0].x} ${p[0].y}`;
                for(let i=0; i<p.length-1; i++){
                    const p0 = p[i-1] || p[i];
                    const p1 = p[i];
                    const p2 = p[i+1];
                    const p3 = p[i+2] || p2;

                    const c1x = p1.x + (p2.x - p0.x) / 6;
                    const c1y = p1.y + (p2.y - p0.y) / 6;
                    const c2x = p2.x - (p3.x - p1.x) / 6;
                    const c2y = p2.y - (p3.y - p1.y) / 6;

                    d += ` C ${c1x} ${c1y}, ${c2x} ${c2y}, ${p2.x} ${p2.y}`;
                }
                return d;
            };

            const pSalesPrev = pts(salesPrev.values);
            const pSalesCurr = pts(salesCurr.values);
            const pBuyCurr   = pts(buyCurr.values);

            const ticks = 4;
            const tickVals = Array.from({length:ticks+1}, (_,i)=> (maxV/ticks)*i);

            const fmtX = (iso) => {
                const d = new Date(iso + 'T00:00:00');
                return d.toLocaleDateString('en-US', {month:'short', day:'numeric'});
            };

            const grid = tickVals.map(v => {
                const yy = y(v);
                return `
                <line x1="${padL}" y1="${yy}" x2="${W-padR}" y2="${yy}" stroke="#e2e8f0" stroke-width="1"/>
                <text x="${padL-10}" y="${yy+4}" text-anchor="end" font-size="11" fill="#94a3b8">${Math.round(v/1000)*5}K</text>
                `;
            }).join('');

            const xLabels = salesCurr.keys.map((k,i)=>`
                <text x="${x(i)}" y="${H-10}" text-anchor="middle" font-size="11" fill="#94a3b8">${fmtX(k)}</text>
            `).join('');

            const circles = (p, cls, color) => p.map(pt => `
                <circle class="${cls}" cx="${pt.x}" cy="${pt.y}" r="7" fill="transparent" data-i="${pt.i}"></circle>
                <circle class="${cls}-dot" cx="${pt.x}" cy="${pt.y}" r="4" fill="${color}" opacity="0"></circle>
            `).join('');

            svg.innerHTML = `
                <rect x="0" y="0" width="${W}" height="${H}" fill="transparent"></rect>
                ${grid}
                ${xLabels}

                <!-- ventes semaine précédente -->
                <path d="${smoothPath(pSalesPrev)}" fill="none" stroke="#94a3b8" stroke-width="3" stroke-linecap="round"></path>

                <!-- ventes semaine actuelle -->
                <path d="${smoothPath(pSalesCurr)}" fill="none" stroke="#0f172a" stroke-width="3" stroke-linecap="round"></path>

                <!-- achats semaine actuelle -->
                <path d="${smoothPath(pBuyCurr)}" fill="none" stroke="#16a34a" stroke-width="3" stroke-linecap="round"></path>

                ${circles(pSalesPrev, 'pt-sales-prev', '#94a3b8')}
                ${circles(pSalesCurr, 'pt-sales-curr', '#0f172a')}
                ${circles(pBuyCurr,   'pt-buy-curr',   '#16a34a')}
            `;

            const showTip = (ptIndex) => {
                const date = salesCurr.keys[ptIndex];
                const vSale = salesCurr.values[ptIndex] || 0;
                const vPrev = salesPrev.values[ptIndex] || 0;
                const vBuy  = buyCurr.values[ptIndex] || 0;

                const pt = pSalesCurr[ptIndex] || pSalesPrev[ptIndex] || pBuyCurr[ptIndex];
                if(!pt || !tip) return;

                tip.style.left = (pt.x / W * 100) + '%';
                tip.style.top  = (pt.y / H * 100) + '%';
                tip.style.display = 'block';
                tip.innerHTML = `
                <div>• ${fmtX(date)}: Ventes ${vSale.toLocaleString()} Ar</div>
                <span class="small">• Achats ${vBuy.toLocaleString()} Ar</span>
                <span class="small">• Prev week ventes ${vPrev.toLocaleString()} Ar</span>
                `;

                svg.querySelectorAll(
                '.pt-sales-curr-dot, .pt-sales-prev-dot, .pt-buy-curr-dot'
                ).forEach(e => e.setAttribute('opacity','0'));

                const d1 = svg.querySelectorAll('.pt-sales-curr-dot')[ptIndex];
                const d0 = svg.querySelectorAll('.pt-sales-prev-dot')[ptIndex];
                const d2 = svg.querySelectorAll('.pt-buy-curr-dot')[ptIndex];
                if(d1) d1.setAttribute('opacity','1');
                if(d0) d0.setAttribute('opacity','1');
                if(d2) d2.setAttribute('opacity','1');
            };

            const hideTip = () => {
                if(tip) tip.style.display = 'none';
                svg.querySelectorAll(
                '.pt-sales-curr-dot, .pt-sales-prev-dot, .pt-buy-curr-dot'
                ).forEach(e => e.setAttribute('opacity','0'));
            };

            svg.querySelectorAll('.pt-sales-curr, .pt-sales-prev, .pt-buy-curr').forEach(el => {
                el.addEventListener('mousemove', () => showTip(Number(el.dataset.i || 0)));
                el.addEventListener('mouseleave', hideTip);
            });
        }

        function exporterDonnees() {
            const data = {
                stock,
                historique,
                config,
                demandesPrix  // ✅ VAOVAO
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});  // ✅ Pretty print
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `donnees_gestion_achat_vente_${new Date().toISOString().slice(0,10)}.json`;  // ✅ Date
            a.click();
            URL.revokeObjectURL(url);
        }


        function importerDonnees() {
            const input = document.getElementById('import-file');
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try{
                    const data = JSON.parse(e.target.result);
                    stock = data.stock || {};
                    historique = data.historique || [];
                    config = data.config || config;
                    demandesPrix = data.demandesPrix || [];  // ✅ VAOVAO
                    sauvegarderDonnees();
                    chargerDonnees();  // ✅ Normalise stock + demandePrix
                    afficherDemandesPrix();  // ✅ Refresh liste
                    alert('Données importées avec succès (demandes prix incluses)');
                    input.value = '';  // ✅ Clear input
                }catch(err){
                    alert('Fichier JSON invalide');
                }
            };
            reader.readAsText(file);
        }

        function confirmerResetComplet() {
            const confirmation = confirm(
                '⚠️ ATTENTION ⚠️\n\n' +
                'Cette action va SUPPRIMER DÉFINITIVEMENT :\n' +
                '• Tout le stock\n' +
                '• Tout l\'historique des achats et ventes\n' +
                '• Toutes les factures enregistrées\n' +
                '• La configuration de l\'entreprise\n' +
                '• Toutes les demandes de prix\n\n' +  // ✅ VAOVAO
                'Cette action est IRRÉVERSIBLE !\n\n' +
                'Voulez-vous vraiment continuer ?'
            );
            
            if (!confirmation) return;
            
            // Double confirmation
            const doubleConfirm = confirm(
                '🚨 DERNIÈRE CONFIRMATION 🚨\n\n' +
                'Êtes-vous ABSOLUMENT SÛR de vouloir tout effacer ?\n\n' +
                'Appuyez sur OK pour SUPPRIMER TOUTES LES DONNÉES.'
            );
            
            if (doubleConfirm) {
                resetCompletBaseDeDonnees();
            }
        }

        async function resetCompletBaseDeDonnees() {
            try {
                // 1. Vider localStorage (TOUS)
                localStorage.removeItem('stock-data');
                localStorage.removeItem('historique-data');
                localStorage.removeItem('config-data');
                localStorage.removeItem('demandes-prix-data');  // ✅ VAOVAO

                // 2. Vider IndexedDB (factures)
                try {
                    const db = await openDb();
                    const tx = db.transaction('factures', 'readwrite');
                    const store = tx.objectStore('factures');
                    await new Promise((resolve, reject) => {
                        const req = store.clear();
                        req.onsuccess = () => resolve();
                        req.onerror = () => reject(req.error);
                    });
                } catch (e) {
                    console.warn('Erreur lors du vidage IndexedDB:', e);
                }
                
                // 3. Réinitialiser les variables globales
                stock = {};
                historique = [];
                articlesAchat = [];
                articlesVente = [];
                factureAchatDraft = null;
                demandesPrix = [];  // ✅ VAOVAO
                config = {
                    nom: '',
                    activite: '',
                    adresse: '',
                    nif: '',
                    stat: '',
                    rc: '',
                    responsable: '',
                    banque: '',
                    paiement: '',
                    logo: ''
                };
                
                // 4. Vider tous les formulaires (efa misy)
                document.getElementById('achat-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('achat-fournisseur').value = '';
                document.getElementById('vente-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('vente-client').value = '';
                document.getElementById('vente-adresse').value = '';
                document.getElementById('vente-numero').value = '';
                
                // 5. Vider config (efa misy)
                // ...
                
                // 6. Logo (efa misy)
                // ...
                
                // 7. Vider tableaux articles (efa misy)
                afficherArticlesAchat();
                afficherArticlesVente();
                
                // 8. Scan (efa misy)
                resetScanUI();
                
                // 9. Rafraîchir TOUS (VAOVAO)
                afficherStock();
                afficherHistorique();
                afficherDemandesPrix();  // ✅ VAOVAO - Vider liste demandes
                genererNumeroVente();
                updateDashboard();
                
                // 10. Message
                alert('✅ Base de données complètement réinitialisée !\n\nToutes les données supprimées (demandes prix incluses).');
                
            } catch (error) {
                console.error('Erreur lors du reset:', error);
                alert('❌ Erreur lors de la réinitialisation.\n\nVeuillez rafraîchir la page.');
            }
        }


        /* Scanner facture (sans OCR) => stockage IndexedDB */
        async function scannerFacture() {
            const input = document.getElementById('facture-scan');
            if (!input) {
                alert('❌ Champ fichier introuvable.');
                return;
            }

            const file = input.files[0];
            if (!file) return;

            // UI elements (tous protégés)
            const previewEl  = document.getElementById('scan-preview');
            const imgEl      = document.getElementById('scan-image');
            const progressEl = document.getElementById('scan-progress');
            const barEl      = document.getElementById('scan-progress-bar');
            const statusEl   = document.getElementById('scan-status');
            const titleEl    = document.getElementById('scan-title');

            // 1) Mamorona fileKey (fallback raha tsy misy crypto.randomUUID)
            const fileKey = (window.crypto && crypto.randomUUID)
                ? crypto.randomUUID()
                : ('f_' + Date.now() + '_' + Math.random().toString(16).slice(2));

            // 2) Tehirizina ho "souche" / metadata ihany (tsy misy dataUrl)
            factureAchatDraft = {
                name: file.name,
                mime: file.type || 'application/octet-stream',
                size: file.size || 0,
                dateUpload: new Date().toISOString(),
                fileKey: fileKey
            };

            // 3) Preview: sary ihany no aseho (PDF tsy aseho amin'ny <img>)
            const isImage = file.type && file.type.startsWith('image/');

            if (previewEl) {
                previewEl.style.display = isImage ? 'block' : 'none';
            }

            if (isImage && imgEl) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imgEl.src = e.target.result; // preview fotsiny
                };
                reader.readAsDataURL(file);
            } else if (imgEl) {
                imgEl.src = '';
            }

            // 4) Asehoy progress (miaro raha undefined ny éléments)
            if (progressEl) progressEl.style.display = 'block';
            if (barEl)      barEl.style.width = '20%';
            if (statusEl)   statusEl.textContent = 'Enregistrement de la facture...';
            if (titleEl)    titleEl.textContent  = 'Analyse en cours...';

            // 5) Tehirizo ao IndexedDB ilay fichier (File/Blob)
            try {
                await idbPutFacture(fileKey, file);  // IndexedDB, tsy localStorage

                if (barEl)    barEl.style.width = '100%';
                if (statusEl) statusEl.textContent = 'Facture enregistrée (pièce jointe).';
                if (titleEl)  titleEl.textContent  = 'Terminé';

                if (progressEl) {
                    setTimeout(() => {
                        progressEl.style.display = 'none';
                    }, 1200);
                }
            } catch (err) {
                console.error('Erreur enregistrement facture:', err);

                if (barEl)    barEl.style.width = '0%';
                if (statusEl) statusEl.textContent = 'Erreur: tsy voatahiry ilay facture.';
                if (titleEl)  titleEl.textContent  = 'Erreur';

                // Aza avela hisy "draft" tsy misy fichier voatahiry
                factureAchatDraft = null;

                alert('❌ Tsy voatahiry ilay facture.\nDétail: ' + (err.message || 'Erreur inconnue'));
            }
        }

        function genererPDFDepuisHistorique(h, typeDoc){
            if(h.type !== 'vente'){
                return;
            }

            // Backup état actuel
            const backupArticles = articlesVente.slice();
            const clientBackup   = document.getElementById('vente-client').value;
            const adrBackup      = document.getElementById('vente-adresse').value;
            const numBackup      = document.getElementById('vente-numero').value;

            // Ampidiro ao amin’ny “formulaire vente” vetivety ny données historique
            articlesVente = h.articles.slice();
            document.getElementById('vente-client').value  = h.tiers || '';
            document.getElementById('vente-adresse').value = h.adresse || '';
            if(h.numero){
                document.getElementById('vente-numero').value = h.numero;
            }

            // Génération PDF (typeDoc = 'facture' | 'proforma' | 'bon')
            genererPDFVente(typeDoc);

            // Averina amin’ny état taloha
            articlesVente = backupArticles;
            document.getElementById('vente-client').value  = clientBackup;
            document.getElementById('vente-adresse').value = adrBackup;
            document.getElementById('vente-numero').value  = numBackup;
        }



        function regenererPDF(idx, type) {
            const h = historique[idx];
            genererPDF({
                type: type,
                operation: h.type,
                date: h.date,
                numero: h.numero,
                tiers: h.tiers,
                adresse: h.adresse || '',
                articles: h.articles,
                total: h.total
            });
        }

        function genererPDFVente(type) {
            // Vérifier qu'il y a des articles
            if (venteListe.length === 0) {
                alert('Aucun article dans la vente');
                return;
            }
            
            // Préparer les données de la facture
            const invoiceData = {
                numero: document.getElementById('vente-numero').value,
                date: document.getElementById('vente-date').value,
                client: document.getElementById('vente-client').value,
                adresse: document.getElementById('vente-adresse').value,
                delai: document.getElementById('vente-delai').value || '30',
                articles: venteListe,
                total: calculerTotalVente()
            };
            
            // Ouvrir le modal de sélection de format
            openFormatModal(type, invoiceData);
        }
        
        function genererPDF(data) {
            const { jsPDF } = window.jspdf;
            
            const isBonLivraison = data.type === 'bon';
            let titreDoc = data.type === 'proforma' ? 'PROFORMA' : 
                        data.type === 'facture' ? 'FACTURE' : 'BON DE LIVRAISON';
            
            const dateObj = new Date(data.date + 'T00:00:00');
            const dateFormatted = dateObj.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            let total = 0;
            const rows = data.articles.map(article => {
                const amount = article.quantite * article.prix;
                total += amount;
                return `<tr><td>${article.produit}</td><td class="text-center">${article.unite}</td><td class="text-center">${article.quantite}</td><td class="text-right">${article.prix.toLocaleString()} Ar</td><td class="text-right">${amount.toLocaleString()} Ar</td></tr>`;
            }).join('');
            
            const totalWords = numberToWords(total);
            const totalInWords = '» ' + totalWords.charAt(0).toUpperCase() + totalWords.slice(1) + ' Ariary"';
            
            const logoHtml = config.logo 
                ? `<img src="${config.logo}" class="doc-logo" alt="Logo">` 
                : `<div style="width: 200px; height: 90px; background: linear-gradient(135deg, #d946ef 0%, #9333ea 100%); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; font-size: 36px;">miglio</div>`;
            
            let tableHeader, tableRows, footerContent;
            
            if (isBonLivraison) {
                tableHeader = `<thead><tr><th>Description</th><th>Unité</th><th>Quantité</th></tr></thead>`;
                tableRows = data.articles.map(article => `<tr><td>${article.produit}</td><td class="text-center">${article.unite}</td><td class="text-center">${article.quantite}</td></tr>`).join('');
                footerContent = `<p style="margin-top: 15px;">Mode de paiement : <span style="color: #6b7280; font-style: italic;">${config.paiement || ''}</span></p>
`;
            } else {
                tableHeader = `<thead><tr><th>Description</th><th>Unité</th><th>Quantité</th><th>Prix U</th><th>Montant</th></tr></thead>`;
                tableRows = rows + `<tr class="total-row"><td colspan="4" class="text-right">TOTAL</td><td class="text-right">${total.toLocaleString()} Ar</td></tr>`;
                
                // Correction: "Facture" ou "Proforma" selon type
                const typeTexte = data.type === 'facture' ? 'Facture' : 'Proforma';
                footerContent = `<p>Arrêter la présente ${typeTexte} à la somme de: <strong>${totalInWords}</strong></p><p style="margin-top: 15px;">Mode de paiement : <em style="color: #6b7280;">${config.paiement || ''}</em></p>`;

            }

            
            document.getElementById("pdf-preview-container").innerHTML = `
                <div class="doc-logo-section">
                    <div>
                        <div class="doc-logo-box">${logoHtml}</div>
                        <div class="doc-number-badge">
                            <p>${titreDoc}</p>
                            <p>N° ${data.numero}</p>
                        </div>
                        <div class="doc-supplier-info">
                            <p style="font-weight: 700; font-size: 10px; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${config.activite || ''}</p>
                            <p><strong>Adresse</strong> : ${config.adresse || ''}</p>
                            <p><strong>NIF</strong> : ${config.nif || ''}</p>
                            <p><strong>STAT</strong> : ${config.stat || ''}</p>
                            <p><strong>RC</strong> : ${config.rc || ''}</p>
                            <p style="font-weight: 700; font-size: 10px; margin-top: 8px;"><strong>Compte Bancaire N°</strong> : ${config.banque || ''}</p>
                        </div>


                    </div>
                    <div class="doc-client-box">
                        <p><strong>Antananarivo le</strong> : ${dateFormatted}</p>
                        <p><strong>${titreDoc} à</strong> : ${data.tiers || ''}</p>
                        <p><strong>Adresse</strong> : ${data.adresse || ''}</p>
                    </div>
                </div>
                <table class="doc-table">${tableHeader}<tbody>${tableRows}</tbody></table>
                <div class="doc-footer">${footerContent}<div class="signature-area">                                                        <p>Le responsable</p>
                                                            <div style="margin-top: 12px; font-style: italic; color: #6b7280; font-size: 12px;">(Signature & Cachet)</div>
                                                            <div style="margin-top: 50px; border-bottom: 2px solid #111827; width: 200px; margin-left: auto;"></div>
                                                            <div style="margin-top: 8px; font-weight: 800; color: #111827; font-size: 14px;">${config.responsable || ''}</div>
                                                        </div>

    

            `;
            
            // Exporter en PDF
            const element = document.getElementById("pdf-preview-container");
            html2canvas(element, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const pdf = new jsPDF("p", "mm", "a4");
                const imgWidth = 190;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, "PNG", 10, 10, imgWidth, imgHeight);
                pdf.save(titreDoc.replace(/ /g, '_') + '_' + data.numero + '.pdf');
            });
        }

        function numberToWords(num) {
            if(num === 0) return 'zéro';
            
            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', '', 'quatre-vingt', ''];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            
            function convertGroup(n) {
                if(n === 0) return '';
                if(n < 10) return units[n];
                if(n < 20) return teens[n - 10];
                
                if(n < 100) {
                    const ten = Math.floor(n / 10);
                    const unit = n % 10;
                    
                    // Cas spéciaux: 70-79
                    if(ten === 7) {
                        if(unit === 0) return 'soixante-dix';
                        if(unit === 1) return 'soixante et onze';
                        return 'soixante-' + teens[unit];
                    }
                    
                    // Cas spéciaux: 90-99
                    if(ten === 9) {
                        if(unit === 0) return 'quatre-vingt-dix';
                        if(unit === 1) return 'quatre-vingt-onze';
                        return 'quatre-vingt-' + teens[unit];
                    }
                    
                    // Cas standard: 20-69, 80-89
                    if(unit === 0) return tens[ten];
                    if(unit === 1 && ten < 7) return tens[ten] + ' et un';
                    if(ten === 8 && unit === 1) return 'quatre-vingt-un';
                    return tens[ten] + '-' + units[unit];
                }
                
                // Centaines
                const hundred = Math.floor(n / 100);
                const rest = n % 100;
                let result = '';
                
                if(hundred === 1) result = 'cent';
                else result = units[hundred] + ' cent';
                
                if(rest === 0 && hundred > 1) result += 's';
                if(rest > 0) result += ' ' + convertGroup(rest);
                
                return result;
            }
            
            let result = '';
            const millions = Math.floor(num / 1000000);
            const thousands = Math.floor((num % 1000000) / 1000);
            const remainder = num % 1000;
            
            // Millions
            if(millions > 0) {
                if(millions === 1) result = 'un million';
                else result = convertGroup(millions) + ' millions';
            }
            
            // Milliers
            if(thousands > 0) {
                if(result) result += ' ';
                if(thousands === 1) result += 'mille';
                else result += convertGroup(thousands) + ' mille';
            }
            
            // Reste
            if(remainder > 0) {
                if(result) result += ' ';
                result += convertGroup(remainder);
            }
            
            return result.charAt(0).toUpperCase() + result.slice(1);
        }



        function convertToWords(num) {
            if(num === 0) return 'zéro';
            
            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', '', 'quatre-vingt', ''];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            
            function convertGroup(n) {
                if(n === 0) return '';
                if(n < 10) return units[n];
                if(n < 20) return teens[n - 10];
                
                if(n < 100) {
                    const ten = Math.floor(n / 10);
                    const unit = n % 10;
                    
                    // Cas spéciaux: 70-79
                    if(ten === 7) {
                        if(unit === 0) return 'soixante-dix';
                        if(unit === 1) return 'soixante et onze';
                        return 'soixante-' + teens[unit];
                    }
                    
                    // Cas spéciaux: 90-99
                    if(ten === 9) {
                        if(unit === 0) return 'quatre-vingt-dix';
                        if(unit === 1) return 'quatre-vingt-onze';
                        return 'quatre-vingt-' + teens[unit];
                    }
                    
                    // Cas standard: 20-69, 80-89
                    if(unit === 0) return tens[ten];
                    if(unit === 1 && ten < 7) return tens[ten] + ' et un';
                    if(ten === 8 && unit === 1) return 'quatre-vingt-un';
                    return tens[ten] + '-' + units[unit];
                }
                
                // Centaines
                const hundred = Math.floor(n / 100);
                const rest = n % 100;
                let result = '';
                
                if(hundred === 1) result = 'cent';
                else result = units[hundred] + ' cent';
                
                if(rest === 0 && hundred > 1) result += 's';
                if(rest > 0) result += ' ' + convertGroup(rest);
                
                return result;
            }
            
            let result = '';
            const millions = Math.floor(num / 1000000);
            const thousands = Math.floor((num % 1000000) / 1000);
            const remainder = num % 1000;
            
            // Millions
            if(millions > 0) {
                if(millions === 1) result = 'un million';
                else result = convertGroup(millions) + ' millions';
            }
            
            // Milliers
            if(thousands > 0) {
                if(result) result += ' ';
                if(thousands === 1) result += 'mille';
                else result += convertGroup(thousands) + ' mille';
            }
            
            // Reste
            if(remainder > 0) {
                if(result) result += ' ';
                result += convertGroup(remainder);
            }
            
            return result.charAt(0).toUpperCase() + result.slice(1);
        }



        
        function convertirMontantEnLettres(num) {
            const nombres = {
                0: '', 1: 'un', 2: 'deux', 3: 'trois', 4: 'quatre', 5: 'cinq',
                6: 'six', 7: 'sept', 8: 'huit', 9: 'neuf', 10: 'dix',
                11: 'onze', 12: 'douze', 13: 'treize', 14: 'quatorze',
                15: 'quinze', 16: 'seize', 17: 'dix-sept', 18: 'dix-huit',
                19: 'dix-neuf', 20: 'vingt', 30: 'trente', 40: 'quarante',
                50: 'cinquante', 60: 'soixante', 70: 'soixante-dix',
                80: 'quatre-vingt', 90: 'quatre-vingt-dix'
            };
            
            if(num === 0) return 'Zéro';
            
            let result = '';
            const millions = Math.floor(num / 1000000);
            const milliers = Math.floor((num % 1000000) / 1000);
            const centaines = num % 1000;
            
            // Millions
            if(millions > 0) {
                result += convertirParties(millions) + ' million' + (millions > 1 ? 's' : '');
            }
            
            // Milliers
            if(milliers > 0) {
                if(result) result += ' ';
                if(milliers === 1) {
                    result += 'mille';
                } else {
                    result += convertirParties(milliers) + ' mille';
                }
            }
            
            // Centaines
            if(centaines > 0) {
                if(result) result += ' ';
                result += convertirParties(centaines);
            }
            
            return result.charAt(0).toUpperCase() + result.slice(1);
            
            function convertirParties(n) {
                if(n === 0) return '';
                if(n < 20) return nombres[n];
                if(n < 100) {
                    const diz = Math.floor(n / 10) * 10;
                    const un = n % 10;
                    if(un === 0) return nombres[diz];
                    return nombres[diz] + '-' + nombres[un];
                }
                const cent = Math.floor(n / 100);
                const reste = n % 100;
                let str = '';
                
                // Correction: tsy asiana "un" raha 100-199
                if(cent === 1) {
                    str = 'cent';
                } else {
                    str = nombres[cent] + ' cent';
                }
                
                if(reste === 0 && cent > 1) str += 's';
                if(reste > 0) str += ' ' + convertirParties(reste);
                return str;
            }

        }

        function ouvrirAchatModal(h){
            const overlay = document.getElementById('achat-modal');
            const info = document.getElementById('achat-modal-info');
            const tbody = document.getElementById('achat-modal-tbody');
            const totalEl = document.getElementById('achat-modal-total');

            info.textContent = `Date: ${h.date}  •  Fournisseur: ${h.tiers}`;
            tbody.innerHTML = '';
            let total = 0;

            h.articles.forEach(a => {
                total += a.total;
                tbody.innerHTML += `
                    <tr>
                        <td>${a.produit}</td>
                        <td>${a.quantite}</td>
                        <td>${a.unite}</td>
                        <td>${a.prix.toLocaleString()} Ar</td>
                        <td>${a.total.toLocaleString()} Ar</td>
                    </tr>
                `;
            });

            totalEl.textContent = total.toLocaleString() + ' Ar';
            overlay.style.display = 'flex';
            
            // ✅ Event listener pour click outside (version propre)
            setTimeout(() => {
                overlay.addEventListener('click', handleOutsideClick);
            }, 10);
        }

        function handleOutsideClick(e) {
            const overlay = document.getElementById('achat-modal');
            if(e.target === overlay) {
                fermerAchatModal();
                overlay.removeEventListener('click', handleOutsideClick);
            }
        }

        function fermerAchatModal(){
            const overlay = document.getElementById('achat-modal');
            overlay.style.display = 'none';
            overlay.removeEventListener('click', handleOutsideClick);
            document.getElementById('achat-modal').style.display = 'none';
        }

        // ========== GESTION PAIEMENT - Helper Functions ==========

        function calculerDateLimite(dateVente, delaiJours = 30) {
            
            // ✅ VAOVAO: Force local timezone
            const d = new Date(dateVente + "T00:00:00");
            
            d.setDate(d.getDate() + delaiJours);
            
            // ✅ VAOVAO: Extract date manually (tsy toISOString)
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const result = `${year}-${month}-${day}`;
            
            return result;
        }

        function calculerInvoicesOverdue() {
            const today = new Date().toISOString().slice(0, 10);
            return historique.filter(h => {
                // Raha tsy vente na tsy misy statut paiement, skip
                if(h.type !== 'vente') return false;
                
                // Raha ancien vente tsy manana statutPaiement, considéré payé
                if(!h.statutPaiement) return false;
                
                // Raha efa payé, skip (accepte 'payé' ET 'pay')
                if(h.statutPaiement === 'payé' || h.statutPaiement === 'pay\u00E9') return false;
                
                // Raha tsy lasa ny date limite, skip
                if(!h.dateLimite || h.dateLimite > today) return false;
                
                return true;
            }).length;
        }


        // ========== MODULE DEMANDE PRIX ==========

        let demandePrixEnCours = null; // Demande actuellement ouverte dans modal

        function creerDemandePrix() {
            const produit = document.getElementById('dp-produit').value.trim();
            const quantite = parseFloat(document.getElementById('dp-quantite').value) || 0;
            const unite = document.getElementById('dp-unite').value;
            
            if(!produit || quantite <= 0) {
                alert('Remplissez produit et quantité');
                return;
            }
            
            // Générer numéro
            const date = new Date();
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const count = demandesPrix.filter(d => d.date.startsWith(`${y}-${m}`)).length + 1;
            const numero = `DP-${y}${m}-${String(count).padStart(4, '0')}`;
            
            // Créer demande
            const demande = {
                id: numero,
                date: date.toISOString().split('T')[0],
                produit: produit,
                quantite: quantite,
                unite: unite,
                fournisseurs: [],
                statut: 'en_attente' // 'en_attente', 'validé', 'annulé'
            };
            
            demandesPrix.push(demande);
            sauvegarderDonnees();
            
            // Clear form
            document.getElementById('dp-produit').value = '';
            document.getElementById('dp-quantite').value = '1';
            
            afficherDemandesPrix();
            
            alert(`✅ Demande ${numero} créée!\n\nAjoutez maintenant les offres des fournisseurs.`);
            
            // Ouvrir directement le modal comparaison
            ouvrirComparaisonModal(demandesPrix.length - 1);
        }

        function afficherDemandesPrix() {
            const tbody = document.getElementById('dp-tbody');
            const section = document.getElementById('dp-liste-section');
            const filterEl = document.getElementById('dp-filter-statut');
            const filtre = filterEl ? filterEl.value : 'tous';

            if (!demandesPrix || !demandesPrix.length) {
                if (section) section.style.display = 'none';

                const selBody = document.getElementById('dp-selected-tbody');
                if (selBody) selBody.innerHTML = '';
                const budgetEl = document.getElementById('dp-budget-total');
                if (budgetEl) budgetEl.textContent = '0 Ar';
                return;
            }

            if (section) section.style.display = 'block';
            if (tbody) tbody.innerHTML = '';

            // Appliquer filtre
            let liste = demandesPrix.slice();
            if (filtre === 'en_attente') {
                liste = liste.filter(d => d.statut === 'en_attente');
            } else if (filtre === 'validé') {
                liste = liste.filter(d => d.statut === 'validé');
            }

            // Affichage tableau principal
            liste.slice().reverse().forEach(d => {
                const idx = demandesPrix.indexOf(d); // index global
                const nbOffres = d.fournisseurs ? d.fournisseurs.length : 0;
                const prixMin = nbOffres > 0 ? Math.min(...d.fournisseurs.map(f => Number(f.prix || 0))) : 0;

                let badge = '';
                if (d.statut === 'validé') {
                    badge = '<span style="background:#16a34a; color:white; padding:3px 8px; border-radius:8px; font-size:11px;">✓ Validé</span>';
                } else if (d.statut === 'annulé') {
                    badge = '<span style="background:#6b7280; color:white; padding:3px 8px; border-radius:8px; font-size:11px;">✗ Annulé</span>';
                } else {
                    badge = '<span style="background:#f59e0b; color:white; padding:3px 8px; border-radius:8px; font-size:11px;">⏳ En cours</span>';
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${d.id}</td>
                        <td><strong>${d.produit}</strong></td>
                        <td style="text-align:right;">${d.quantite} ${d.unite}</td>
                        <td style="text-align:right;">${nbOffres}</td>
                        <td style="text-align:right;">${prixMin > 0 ? prixMin.toLocaleString('fr-FR') + ' Ar' : '-'}</td>
                        <td>${badge}</td>
                        <td>
                            <div style="display:flex; gap:4px;">
                                <button class="btn-compact" onclick="ouvrirComparaisonModal(${idx})" title="Comparer / Voir">
                                    <i class="fa-solid fa-scale-balanced"></i>
                                </button>
                                ${d.statut === 'en_attente' ? `
                                <button class="btn-compact btn-compact-danger" onclick="supprimerDemande(${idx})" title="Supprimer">
                                    <i class="fa-solid fa-trash"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });

            calculerBudgetSelection();
            rafraichirRecapSelection();
        }

        function calculerBudgetSelection() {
            if (!Array.isArray(demandesPrix)) return 0;

            let total = 0;

            demandesPrix.forEach(d => {
                const f = d.fournisseurs && d.fournisseurs.find(x => x.selected);
                if (f && d.statut === 'en_attente') { // ✅ EN_ATTENTE IHANY
                    total += Number(d.quantite || 0) * Number(f.prix || 0);
                }
            });

            const el = document.getElementById('dp-budget-total');
            if (el) {
                el.textContent = total.toLocaleString('fr-FR') + ' Ar';
                // ✅ Label + mazava
                const wrapEl = document.getElementById('dp-budget-wrap');
                if (wrapEl) {
                    wrapEl.innerHTML = `
                        <span style="font-weight:600; color:#374151;">
                            Total à budgéter (en attente):
                        </span>
                        <span id="dp-budget-total" style="font-weight:800; color:#16a34a; margin-left:8px;">
                            ${total.toLocaleString('fr-FR')} Ar
                        </span>
                    `;
                }
            }

            return total;
        }


        function rafraichirRecapSelection() {
            const tbody = document.getElementById('dp-selected-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!Array.isArray(demandesPrix) || !demandesPrix.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#9ca3af;">Aucun article sélectionné.</td></tr>';
                return;
            }

            const lignes = [];

            demandesPrix.forEach(d => {
                const f = d.fournisseurs && d.fournisseurs.find(x => x.selected);
                if (f && d.statut === 'en_attente') { // ✅ EN_ATTENTE IHANY
                    const total = Number(d.quantite || 0) * Number(f.prix || 0);
                    lignes.push({
                        produit: d.produit,
                        quantite: d.quantite,
                        unite: d.unite,
                        fournisseur: f.nom,
                        prix: f.prix,
                        total: total,
                        statut: d.statut
                    });
                }
            });

            if (!lignes.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#9ca3af;">Aucun article sélectionné en attente.</td></tr>';
                return;
            }

            // Trier par fournisseur puis produit
            lignes.sort((a, b) => {
                const fa = a.fournisseur.localeCompare(b.fournisseur);
                if (fa !== 0) return fa;
                return a.produit.localeCompare(b.produit);
            });

            lignes.forEach(l => {
                const badgeStatut = '<span style="background:#f59e0b; color:white; padding:2px 6px; border-radius:999px; font-size:10px;">En attente</span>'; // ✅ En attente ihany

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${l.produit}</strong></td>
                        <td>${l.quantite} ${l.unite || ''}</td>
                        <td>${l.fournisseur}</td>
                        <td style="text-align:right;">${Number(l.prix || 0).toLocaleString('fr-FR')} Ar</td>
                        <td style="text-align:right; font-weight:600;">${l.total.toLocaleString('fr-FR')} Ar</td>
                        <td>${badgeStatut}</td>
                    </tr>
                `;
            });

            // ✅ TOTAL FOOT
            const total = lignes.reduce((sum, l) => sum + l.total, 0);
            tbody.innerHTML += `
                <tr style="background:#fef3c7; font-weight:600;">
                    <td colspan="4" style="text-align:right;">TOTAL À BUDGÉTER:</td>
                    <td style="text-align:right;">${total.toLocaleString('fr-FR')} Ar</td>
                    <td></td>
                </tr>
            `;
        }


        function supprimerDemande(idx) {
            const d = demandesPrix[idx];
            
            if(!confirm(`Supprimer la demande ${d.id}?`)) return;
            
            demandesPrix.splice(idx, 1);
            sauvegarderDonnees();
            afficherDemandesPrix();
        }

        function modifierDemandeValidee(idx) {
            const d = demandesPrix[idx];
            
            if(!d || d.statut !== 'validé') {
                alert('Cette demande n\'est pas validée');
                return;
            }
            
            const confirmer = confirm(
                `⚠️ MODIFIER LA DEMANDE VALIDÉE\n\n` +
                `Demande: ${d.id}\n` +
                `Produit: ${d.produit}\n` +
                `Fournisseur actuel: ${d.fournisseurChoisi}\n\n` +
                `ATTENTION:\n` +
                `• Vous pourrez modifier les prix ou ajouter des offres\n` +
                `• L'achat précédent restera dans l'historique\n` +
                `• Une nouvelle validation créera un NOUVEL achat\n\n` +
                `Continuer?`
            );
            
            if(!confirmer) return;
            
            // ✅ Réouvrir la demande (ne pas supprimer achat historique)
            d.statut = 'en_attente';
            
            // ✅ Désélectionner tous les fournisseurs pour forcer nouveau choix
            d.fournisseurs.forEach(f => f.selected = false);
            
            sauvegarderDonnees();
            afficherDemandesPrix();
            
            // Ouvrir modal
            ouvrirComparaisonModal(idx);
            
            alert(
                `✅ Demande réouverte!\n\n` +
                `Vous pouvez maintenant:\n` +
                `• Modifier les prix existants (Supprimer + Re-ajouter)\n` +
                `• Ajouter de nouveaux fournisseurs\n` +
                `• Choisir une nouvelle offre\n\n` +
                `Note: L'ancien achat reste dans l'historique.`
            );
        }

        function ouvrirComparaisonModal(idx) {
            demandePrixEnCours = idx;
            const d = demandesPrix[idx];
            
            const modal = document.getElementById('comparaison-modal');
            const produitEl = document.getElementById('comp-produit');
            const infoEl = document.getElementById('comp-info');
            const formAjout = document.getElementById('comp-form-ajout'); // Formulaire ajout
            const btnValider = modal.querySelector('.btn-success'); // Bouton valider
            const tbody = document.getElementById('comp-tbody');
            
            produitEl.textContent = d.produit;
            
            // ✅ Statut info
            let statutText = `Demande: ${d.id} • Quantité: ${d.quantite} ${d.unite} • Date: ${d.date}`;
            if (d.statut === 'validé') {
                statutText += ` • <span style="background:#16a34a;color:white;padding:4px 8px;border-radius:6px;font-size:11px;margin-left:8px;">✓ DÉJÀ VALIDÉ</span> (${d.fournisseurChoisi})`;
            } else {
                statutText += ` • <span style="background:#f59e0b;color:white;padding:4px 8px;border-radius:6px;font-size:11px;margin-left:8px;">⏳ EN ATTENTE</span>`;
            }
            infoEl.innerHTML = statutText;
            
            // ✅ READ-ONLY SI VALIDÉ
            const isValidated = d.statut === 'validé';
            const hasSelection = d.fournisseurs.some(f => f.selected);
            
            // Masquer formulaire ajout si validé
            if (formAjout) {
                formAjout.style.display = isValidated ? 'none' : 'block';
            }
            
            // ✅ BOUTON VALIDER - LOGIC CORRIGÉE
            if (btnValider) {
                if (isValidated) {
                    // Validé: cacher bouton
                    btnValider.style.display = 'none';
                } else {
                    // En attente: TOUJOURS VISIBLE
                    btnValider.style.display = 'inline-flex';
                    
                    if (hasSelection) {
                        // Voafidy: normal vert
                        btnValider.innerHTML = '<i class="fa-solid fa-check"></i> Valider Offre Choisie';
                        btnValider.style.opacity = '1';
                        btnValider.style.background = '#16a34a';
                        btnValider.style.color = 'white';
                        btnValider.disabled = false;
                    } else {
                        // Tsy voafidy: gris + warning
                        btnValider.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> Sélectionnez un fournisseur';
                        btnValider.style.opacity = '0.6';
                        btnValider.style.background = '#d1d5db';
                        btnValider.style.color = '#6b7280';
                        btnValider.disabled = true;
                    }
                }
            }

            modal.style.display = 'flex';
            afficherOffresComparaison();

            // ✅ Boutons actions: read-only si validé
            setTimeout(() => {  // Wait DOM update
                const rows = modal.querySelectorAll('#comp-tbody tr');
                rows.forEach(row => {
                    const btnChoisir = row.querySelector('.btn-compact-success');
                    const btnSupp = row.querySelector('.btn-compact-danger');
                    if (btnChoisir) {
                        btnChoisir.style.opacity = isValidated ? '0.5' : '1';
                        if (isValidated) btnChoisir.onclick = null;  // Disable
                    }
                    if (btnSupp) btnSupp.style.display = isValidated ? 'none' : 'inline-flex';
                });
            }, 50);
            
            
            // Click outside
            setTimeout(() => {
                modal.onclick = function(e) {
                    if (e.target === modal) fermerComparaisonModal();
                };
            }, 10);
        }




        function fermerComparaisonModal() {
            document.getElementById('comparaison-modal').style.display = 'none';
            demandePrixEnCours = null;
        }

        function afficherOffresComparaison() {
            if(demandePrixEnCours === null) return;
            
            const d = demandesPrix[demandePrixEnCours];
            const tbody = document.getElementById('comp-tbody');
            
            if(d.fournisseurs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">Aucune offre. Ajoutez des offres ci-dessus.</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            // Trie par prix croissant
            const sorted = [...d.fournisseurs].sort((a, b) => a.prix - b.prix);
            
            sorted.forEach((f, i) => {
                const total = f.prix * d.quantite;
                const isBest = i === 0; // Premier = meilleur prix
                const isSelected = f.selected === true; // ✅ VAOVAO - Vérifier si sélectionné
                
                // ✅ VAOVAO - Icon coché si sélectionné
                const checkIcon = isSelected 
                    ? '<i class="fa-solid fa-circle-check" style="color:#16a34a; font-size:20px;"></i>' 
                    : '<i class="fa-regular fa-circle" style="color:#d1d5db; font-size:20px;"></i>';
                
                tbody.innerHTML += `
                    <tr style="${isSelected ? 'background:#fef3c7; border-left:4px solid #f59e0b;' : (isBest ? 'background:#dcfce7;' : '')}">
                        <td style="text-align:center; vertical-align:middle; padding:10px 8px;">
                            ${checkIcon}
                        </td>
                        <td style="vertical-align:middle; padding:10px 12px;">
                            <div style="display:flex; flex-direction:column; gap:4px;">
                                <strong style="font-size:13px;">${f.nom}</strong>
                                <div style="display:flex; gap:4px; flex-wrap:wrap;">
                                    ${isBest ? '<span style="background:#16a34a; color:white; padding:2px 6px; border-radius:6px; font-size:10px;">Prix + Bas</span>' : ''}
                                    ${isSelected ? '<span style="background:#f59e0b; color:white; padding:2px 6px; border-radius:6px; font-size:10px;">✓ CHOISI</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td style="font-weight:600; text-align:right; vertical-align:middle; padding:10px 12px;">
                            ${f.prix.toLocaleString()} Ar
                        </td>
                        <td style="font-weight:600; text-align:right; vertical-align:middle; padding:10px 12px;">
                            ${total.toLocaleString()} Ar
                        </td>
                        <td style="text-align:center; vertical-align:middle; padding:10px 8px;">
                            ${f.delai} j
                        </td>
                        <td style="vertical-align:middle; padding:10px 8px; font-size:11px; color:#6b7280;">
                            ${f.note || '-'}
                        </td>
                        <td style="text-align:center; vertical-align:middle; padding:10px 8px;">
                            <div style="display:flex; gap:4px; justify-content:center; flex-wrap:nowrap;">
                                <button class="btn-compact btn-compact-success" onclick="choisirFournisseur(${i})" title="Choisir">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                                <button class="btn-compact btn-compact-danger" onclick="supprimerOffre(${i})" title="Supprimer">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;

            });
        }

        function ajouterOffrePrix() {
            if(demandePrixEnCours === null) return;
            
            const fournisseur = document.getElementById('comp-fournisseur').value.trim();
            const prix = parseFloat(document.getElementById('comp-prix').value) || 0;
            const delai = parseInt(document.getElementById('comp-delai').value) || 3;
            const note = document.getElementById('comp-note').value.trim();

            if(!fournisseur || prix <= 0) {
                alert('Remplissez fournisseur et prix');
                return;
            }
            
            const d = demandesPrix[demandePrixEnCours];
            
            // Vérifier doublon
            if(d.fournisseurs.some(f => f.nom.toLowerCase() === fournisseur.toLowerCase())) {
                alert('Ce fournisseur existe déjà. Supprimez l\'ancien avant.');
                return;
            }
            
            d.fournisseurs.push({
                nom: fournisseur,
                prix: prix,
                delai: delai,
                note: note,
                selected: false
            });
            
            sauvegarderDonnees();
            
            // Clear inputs
            document.getElementById('comp-fournisseur').value = '';
            document.getElementById('comp-prix').value = '';
            document.getElementById('comp-delai').value = '3';
            document.getElementById('comp-note').value = '';
            
            afficherOffresComparaison();
            afficherDemandesPrix();
            ouvrirComparaisonModal(demandePrixEnCours);

        }

        function supprimerOffre(idx) {
            if(demandePrixEnCours === null) return;
            
            const d = demandesPrix[demandePrixEnCours];
            
            // ✅ Mitady index original (après tri)
            const sorted = [...d.fournisseurs].sort((a, b) => a.prix - b.prix);
            const fournisseurSuppr = sorted[idx];
            const originalIdx = d.fournisseurs.findIndex(f => f === fournisseurSuppr);
            
            // ✅ Warning si c'est l'offre sélectionnée
            let message = `Supprimer l'offre de ${fournisseurSuppr.nom}?`;
            if(fournisseurSuppr.selected) {
                message = `⚠️ ATTENTION!\n\nCe fournisseur est actuellement SÉLECTIONNÉ.\n\nSupprimer quand même?`;
            }
            
            if(!confirm(message)) return;
            
            d.fournisseurs.splice(originalIdx, 1);
            sauvegarderDonnees();
            
            afficherOffresComparaison();
            afficherDemandesPrix();
        }


        function choisirFournisseur(idx) {
            if(demandePrixEnCours === null) return;
            
            const d = demandesPrix[demandePrixEnCours];
            
            // ✅ Mitady ny index original @ fournisseurs (tsy sorted)
            const sorted = [...d.fournisseurs].sort((a, b) => a.prix - b.prix);
            const fournisseurChoisi = sorted[idx];
            const originalIdx = d.fournisseurs.findIndex(f => f === fournisseurChoisi);
            
            // ✅ DESÉLECTIONNER daholo
            d.fournisseurs.forEach((fr) => {
                fr.selected = false;
            });
            
            // ✅ SÉLECTIONNER ilay tokana
            d.fournisseurs[originalIdx].selected = true;
            
            sauvegarderDonnees(); // ✅ Save immédiatement
            afficherOffresComparaison();
            afficherDemandesPrix(); // ✅ Update tableau principal
            ouvrirComparaisonModal(demandePrixEnCours);
            
            // Message plus clair
            alert(`✅ Fournisseur sélectionné: ${fournisseurChoisi.nom}\n\nPrix: ${fournisseurChoisi.prix.toLocaleString()} Ar\n\nCliquez "Valider Offre Choisie" pour créer l'achat.`);
        }


        function validerMeilleureOffre() {
            if(demandePrixEnCours === null) return;
            
            const d = demandesPrix[demandePrixEnCours];
            
            // Chercher fournisseur sélectionné
            const selected = d.fournisseurs.find(f => f.selected);
            
            if(!selected) {
                alert('Sélectionnez un fournisseur d\'abord (bouton ✓)');
                return;
            }
            
            const confirmer = confirm(
                `Valider l'achat?\n\n` +
                `Fournisseur: ${selected.nom}\n` +
                `Produit: ${d.produit}\n` +
                `Quantité: ${d.quantite} ${d.unite}\n` +
                `Prix unitaire: ${selected.prix.toLocaleString()} Ar\n` +
                `Total: ${(selected.prix * d.quantite).toLocaleString()} Ar\n\n` +
                `Ceci va créer un ACHAT automatique.`
            );
            
            if(!confirmer) return;
            
            // Créer achat automatique
            const date = new Date().toISOString().split('T')[0];
            
            // Ajouter au stock (lots FIFO)
            if(!stock[d.produit]) {
                stock[d.produit] = {unite: d.unite, lots: []};
            }
            if(!stock[d.produit].lots) {
                stock[d.produit].lots = [];
            }
            stock[d.produit].unite = d.unite;
            stock[d.produit].lots.push({
                qte: Number(d.quantite),
                prix: Number(selected.prix),
                date: date
            });
            
            // Ajouter à l'historique
            historique.push({
                type: 'achat',
                date: date,
                tiers: selected.nom,
                articles: [{
                    produit: d.produit,
                    quantite: d.quantite,
                    prix: selected.prix,
                    unite: d.unite,
                    total: d.quantite * selected.prix
                }],
                total: d.quantite * selected.prix,
                source: 'demande_prix', // ← Marqueur spécial
                demandePrixId: d.id
            });
            
            // Marquer demande comme validée
            d.statut = 'validé';
            d.fournisseurChoisi = selected.nom;
            d.dateValidation = date;
            
            sauvegarderDonnees();
            updateDashboard();
            
            fermerComparaisonModal();
            afficherDemandesPrix();
            
            alert(`✅ Achat validé et stock mis à jour!\n\nFournisseur: ${selected.nom}\nConsultez l'onglet Historique.`);
        }

        function getMontantOverdue() {
            const today = new Date().toISOString().split('T')[0];
            
            return historique
                .filter(h => 
                    h.type === 'vente' && 
                    h.statutPaiement && 
                    h.statutPaiement !== 'payé' &&
                    h.dateLimite && 
                    h.dateLimite < today
                )
                .reduce((sum, h) => sum + (h.total - (h.montantPaye || 0)), 0);
        }


        // 1) total valeur stock = somme(quantite * prixMoyen)
        function computeValeurStock(){
            if(!window.stock) return 0;
            let total = 0;
            for(const p of Object.keys(stock)){
                const it = stock[p] || {};
                const q = Number(it.quantite || 0);
                const pm = Number(it.prixMoyen || 0);
                total += q * pm;
            }
            return Math.round(total);
        }

        // 2) mise à jour KPI + barre
        function updateStockValueUI(options = {}){
            const value = computeValeurStock();

            // KPI "Valeur stock"
            const kpi = document.getElementById('kpi-stock-value');
            if(kpi) kpi.textContent = value.toLocaleString() + ' Ar';

            // Progress % (valeur / objectif)
            const objectif = Number(options.objectif ?? window.STOCK_VALUE_TARGET ?? 500000); // <-- ovay eto
            const percent = objectif > 0 ? Math.max(0, Math.min(100, Math.round((value / objectif) * 100))) : 0;

            const fill = document.getElementById('dash-stock-progress');
            const label = document.getElementById('dash-stock-status');

            if(fill) fill.style.width = percent + '%';

            if(label){
                if(value <= 0) label.textContent = 'Rupture';
                else if(percent < 35) label.textContent = 'Faible';
                else if(percent < 70) label.textContent = 'En progress';
                else label.textContent = 'OK';
            }

            // Couleur araka ny percent
            if(fill){
                if(value <= 0) fill.style.background = 'linear-gradient(90deg,#ef4444,#b91c1c)';
                else if(percent < 35) fill.style.background = 'linear-gradient(90deg,#f59e0b,#d97706)';
                else fill.style.background = 'linear-gradient(90deg,#22c55e,#16a34a)';
            }

            return { value, objectif, percent };
        }

        // ========== APP LOGO UPLOAD ==========
        function ouvrirUploadAppLogo() {
            const input = document.getElementById('app-logo-input');
            if (input) input.click();
        }

        // Listener
        document.getElementById('app-logo-input')?.addEventListener('change', function() {
            const file = this.files && this.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                
                // Sauvegarde
                config.appLogo = dataUrl;
                sauvegarderDonnees();
                
                // Affichage header + sidebar
                appliquerAppLogoUI(dataUrl);
            };
            reader.readAsDataURL(file);
        });

        // ========== NOTIFICATIONS PAIEMENTS ==========

        function getNotificationsPaiements() {
            const notifications = [];
            const today = new Date().toISOString().slice(0, 10);
            const alerteDays = config.alerteEcheance || 7;
            
            historique.forEach((h, idx) => {
                if (h.type !== 'vente') return;
                
                // 1. Factures en retard (overdue)
                if (h.statutPaiement && h.statutPaiement !== 'pay' && h.dateLimite) {
                    if (h.dateLimite < today) {
                        const reste = h.total - (h.montantPaye || 0);
                        notifications.push({
                            id: `overdue-${idx}`,
                            type: 'error',
                            icon: '🔴',
                            titre: 'Facture en retard',
                            message: `${h.numero}: ${reste.toLocaleString()} Ar`,
                            date: h.dateLimite,
                            action: () => ouvrirDetailVente(idx)
                        });
                    }
                }
                
                // 2. Échéances proches
                if (h.statutPaiement && h.statutPaiement !== 'pay' && h.dateLimite) {
                    const dateLimit = new Date(h.dateLimite + 'T00:00:00');
                    const todayDate = new Date(today + 'T00:00:00');
                    const diffDays = Math.floor((dateLimit - todayDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 0 && diffDays <= alerteDays) {
                        const reste = h.total - (h.montantPaye || 0);
                        notifications.push({
                            id: `echeance-${idx}`,
                            type: 'warning',
                            icon: '⏰',
                            titre: `Échéance dans ${diffDays}j`,
                            message: `${h.numero}: ${reste.toLocaleString()} Ar`,
                            date: h.dateLimite,
                            action: () => ouvrirDetailVente(idx)
                        });
                    }
                }
                
                // 3. Paiements reçus récemment (dernières 48h)
                if (h.statutPaiement === 'pay' && h.datePayement) {
                    const payDate = new Date(h.datePayement + 'T00:00:00');
                    const todayDate = new Date(today + 'T00:00:00');
                    const diffDays = Math.floor((todayDate - payDate) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 2) {
                        notifications.push({
                            id: `paid-${idx}`,
                            type: 'success',
                            icon: '✅',
                            titre: 'Paiement reçu',
                            message: `${h.numero}: ${h.total.toLocaleString()} Ar`,
                            date: h.datePayement,
                            action: () => ouvrirDetailVente(idx)
                        });
                    }
                }
            });
            
            return notifications;
        }

        function ouvrirDetailVente(idx) {
            const h = historique[idx];
            
            if (!h) {
                alert('Transaction introuvable');
                return;
            }
            
            // Calcul du reste à payer (uniquement pour ventes)
            const resteAPayer = h.type === 'vente' ? (h.total - (h.montantPaye || 0)) : 0;
            const estTotalementPaye = h.statutPaiement === 'pay';
            
            // Tableau des articles
            const articlesHTML = h.articles.map(a => `
                <tr>
                <td style="padding: 8px;">${a.produit}</td>
                <td style="padding: 8px; text-align: center;">${a.quantite}</td>
                <td style="padding: 8px; text-align: center;">${a.unite || 'Pce'}</td>
                <td style="padding: 8px; text-align: right;">${(a.prix || 0).toLocaleString()} Ar</td>
                <td style="padding: 8px; text-align: right; font-weight: 600;">${(a.total || 0).toLocaleString()} Ar</td>
                </tr>
            `).join('');
            
            // Section paiement (uniquement pour les ventes)
            const sectionPaiement = h.type === 'vente' ? `
                <div style="margin-top: 20px; padding: 16px; background: ${estTotalementPaye ? '#dcfce7' : '#fef3c7'}; border-radius: 12px; border-left: 4px solid ${estTotalementPaye ? '#16a34a' : '#f59e0b'};">
                <h4 style="margin: 0 0 12px 0; font-size: 15px; font-weight: 700; color: ${estTotalementPaye ? '#166534' : '#92400e'}; display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-money-bill-wave"></i>
                    Informations paiement
                </h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; margin-bottom: 12px;">
                    <div><strong>Montant total:</strong> ${h.total.toLocaleString()} Ar</div>
                    <div><strong>Échéance:</strong> ${h.dateLimite || 'Non définie'}</div>
                    <div><strong>Déjà payé:</strong> <span style="color: #16a34a; font-weight: 600;">${(h.montantPaye || 0).toLocaleString()} Ar</span></div>
                    <div><strong>Reste:</strong> <span style="font-weight: 700; color: ${resteAPayer > 0 ? '#dc2626' : '#16a34a'};">${resteAPayer.toLocaleString()} Ar</span></div>
                </div>
                
                ${h.paiements && h.paiements.length > 0 ? `
                    <details style="margin-top: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #374151; font-size: 12px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
                        📜 Historique des paiements (${h.paiements.length})
                    </summary>
                    <div style="margin-top: 10px; max-height: 200px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                            <th style="padding: 6px; text-align: left;">Date</th>
                            <th style="padding: 6px; text-align: right;">Montant</th>
                            <th style="padding: 6px; text-align: left;">Mode</th>
                            <th style="padding: 6px; text-align: left;">Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${h.paiements.map(p => `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 6px;">${p.date}</td>
                                <td style="padding: 6px; text-align: right; font-weight: 600; color: #16a34a;">${p.montant.toLocaleString()} Ar</td>
                                <td style="padding: 6px;">${p.mode}</td>
                                <td style="padding: 6px; color: #6b7280;">${p.note || '-'}</td>
                            </tr>
                            `).join('')}
                        </tbody>
                        </table>
                    </div>
                    </details>
                ` : '<p style="font-size: 12px; color: #9ca3af; margin: 8px 0;">Aucun paiement enregistré.</p>'}
                
                ${!estTotalementPaye && resteAPayer > 0 ? `
                    <button onclick="ouvrirFormulairePaiement(${idx})" style="width: 100%; margin-top: 12px; background: #16a34a; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer;">
                        <i class="fa-solid fa-plus"></i> Enregistrer un paiement
                    </button>
                    ` : `
                    <div style="text-align: center; margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                        <i class="fa-solid fa-circle-check" style="font-size: 24px; color: #16a34a;"></i>
                        <p style="margin: 8px 0 0 0; font-weight: 700; color: #166534;">✓ Facture totalement payée</p>
                    </div>
                `}
                </div>
            ` : '';
            
            // Création du modal
            const modalHTML = `
                <div class="modal-header">
                <h3>
                    ${h.type === 'achat' ? '🛒 Détail Achat' : '💰 Détail Vente'} - ${h.numero || 'N/A'}
                </h3>
                <button class="modal-close" onclick="fermerDetailVente()">×</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <p class="modal-info">
                    <strong>Date:</strong> ${h.date} &nbsp;|&nbsp;
                    <strong>${h.type === 'achat' ? 'Fournisseur' : 'Client'}:</strong> ${h.tiers}
                    ${h.adresse ? ` &nbsp;|&nbsp; <strong>Adresse:</strong> ${h.adresse}` : ''}
                </p>
                
                <table class="modal-table">
                    <thead>
                    <tr>
                        <th>Produit</th>
                        <th style="text-align: center;">Qté</th>
                        <th style="text-align: center;">Unit</th>
                        <th style="text-align: right;">P.U</th>
                        <th style="text-align: right;">Montant</th>
                    </tr>
                    </thead>
                    <tbody>
                    ${articlesHTML}
                    </tbody>
                    <tfoot>
                    <tr style="background: #fef3c7; font-weight: bold;">
                        <td colspan="4" style="text-align: right; padding: 10px;">TOTAL</td>
                        <td style="text-align: right; padding: 10px;">${h.total.toLocaleString()} Ar</td>
                    </tr>
                    </tfoot>
                </table>
                
                ${sectionPaiement}
                
                ${h.type === 'vente' ? `
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn btn-pdf" onclick="genererPDFDepuisHistorique(historique[${idx}], 'facture')" style="flex: 1;">
                        <i class="fa-solid fa-file-invoice"></i> Facture
                    </button>
                    <button class="btn btn-info" onclick="genererPDFDepuisHistorique(historique[${idx}], 'bon')" style="flex: 1;">
                        <i class="fa-solid fa-truck"></i> Bon livraison
                    </button>
                    </div>
                ` : ''}
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'detail-vente-modal';
            modal.className = 'modal-overlay';
            modal.innerHTML = `<div class="modal" style="max-width: 800px;">${modalHTML}</div>`;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) fermerDetailVente();
            });
        }

        function fermerDetailVente() {
            const modal = document.getElementById('detail-vente-modal');
            if (modal) modal.remove();
        }

        function ouvrirFormulairePaiement(idx) {
            const h = historique[idx];
            const resteAPayer = h.total - (h.montantPaye || 0);
            
            // ⬇️ AJOUTER CETTE VÉRIFICATION
            if (resteAPayer <= 0) {
                alert('⚠️ Cette facture est déjà totalement payée !');
                return;
            }
            
            fermerDetailVente(); // Fermer le modal de détail
            
            const modalHTML = `
                <div class="modal-header">
                <h3><i class="fa-solid fa-money-bill-wave"></i> Enregistrer un paiement</h3>
                <button class="modal-close" onclick="fermerFormulairePaiement()">×</button>
                </div>
                <div class="modal-body">
                <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 13px;">
                    <strong>Facture:</strong> ${h.numero} &nbsp;|&nbsp; <strong>Client:</strong> ${h.tiers}<br>
                    <strong>Reste à payer:</strong> <span style="font-size: 18px; font-weight: 800; color: #dc2626;">${resteAPayer.toLocaleString()} Ar</span>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                    <label>Date du paiement</label>
                    <input type="date" id="paiement-date" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="form-group">
                    <label>Montant (Ar)</label>
                    <input type="number" id="paiement-montant" value="${resteAPayer}" min="1" max="${resteAPayer}">
                    </div>
                    <div class="form-group">
                    <label>Mode de paiement</label>
                    <select id="paiement-mode">
                        <option value="Espèces">💵 Espèces</option>
                        <option value="Chèque">📝 Chèque</option>
                        <option value="Virement">🏦 Virement bancaire</option>
                        <option value="Mobile Money">📱 Mobile Money</option>
                        <option value="Carte bancaire">💳 Carte bancaire</option>
                    </select>
                    </div>
                    <div class="form-group">
                    <label>Note / Référence (optionnel)</label>
                    <input type="text" id="paiement-note" placeholder="Ex: Chèque n° 12345">
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="validerPaiement(${idx})">
                    <i class="fa-solid fa-check"></i> Valider le paiement
                    </button>
                    <button class="btn" onclick="fermerFormulairePaiement()">
                    Annuler
                    </button>
                </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'formulaire-paiement-modal';
            modal.className = 'modal-overlay';
            modal.innerHTML = `<div class="modal" style="max-width: 600px;">${modalHTML}</div>`;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) fermerFormulairePaiement();
            });
        }


        function fermerFormulairePaiement() {
            const modal = document.getElementById('formulaire-paiement-modal');
            if (modal) modal.remove();
        }

        function validerPaiement(idx) {
            const h = historique[idx];
            const date = document.getElementById('paiement-date').value;
            const montant = parseFloat(document.getElementById('paiement-montant').value);
            const mode = document.getElementById('paiement-mode').value;
            const note = document.getElementById('paiement-note').value.trim();
            
            // ⬇️ Calculer le reste ACTUEL
            const resteAPayer = h.total - (h.montantPaye || 0);
            
            // ⬇️ VÉRIFICATIONS RENFORCÉES
            if (!date || !montant || montant <= 0) {
                alert('⚠️ Veuillez remplir tous les champs obligatoires.');
                return;
            }
            
            if (resteAPayer <= 0) {
                alert('⚠️ Cette facture est déjà totalement payée !');
                fermerFormulairePaiement();
                return;
            }
            
            if (montant > resteAPayer) {
                alert(`⚠️ Le montant ne peut pas dépasser le reste à payer : ${resteAPayer.toLocaleString()} Ar`);
                return;
            }
            
            // Initialiser le tableau des paiements
            if (!h.paiements) h.paiements = [];
            
            // Ajouter le paiement
            h.paiements.push({
                date: date,
                montant: montant,
                mode: mode,
                note: note
            });
            
            // Mettre à jour le montant payé
            h.montantPaye = (h.montantPaye || 0) + montant;
            
            // Mettre à jour le statut
            if (h.montantPaye >= h.total) {
                h.statutPaiement = 'pay';
                h.datePayement = date;
            } else {
                h.statutPaiement = 'partiel';
            }
            
            // Sauvegarder
            sauvegarderDonnees();
            
            alert(`✅ Paiement de ${montant.toLocaleString()} Ar enregistré avec succès !`);
            fermerFormulairePaiement();
            afficherHistorique();
            updateNotificationBadge();
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notif-dropdown');
            const isVisible = dropdown.style.display === 'block';
            
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                afficherNotifications();
                dropdown.style.display = 'block';
            }
        }

        // ✅ NOUVELLE FONCTION - Update badge UNIQUEMENT
        function updateNotificationBadge() {
            const notifs = getNotificationsPaiements();
            const badge = document.getElementById('notif-count');
            
            if(notifs.length > 0) {
                badge.textContent = notifs.length;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // ✅ FONCTION EXISTANTE - Affiche dropdown + badge
        function afficherNotifications() {
            const notifs = getNotificationsPaiements();
            const list = document.getElementById('notif-list');
            
            // Update badge aussi
            updateNotificationBadge();
            
            // Update liste
            if(notifs.length === 0) {
                list.innerHTML = `<div style="padding:40px;text-align:center;color:#9ca3af">Aucune notification</div>`;
                return;
            }
            
            list.innerHTML = notifs.map(n => `
                <div class="notif-item ${n.type}" onclick="${n.action ? n.action.toString() : ''}">
                    <div class="notif-titre">${n.icon} ${n.titre}</div>
                    <div class="notif-message">${n.message}</div>
                </div>
            `).join('');
        }


        function marquerToutLu() {
            document.getElementById('notif-count').style.display = 'none';
            document.getElementById('notif-dropdown').style.display = 'none';
        }

        // Update automatique du badge
        function updateNotifications() {
            updateNotificationBadge();  // ✅ Badge uniquement, pas le dropdown!
        }

        // Appel initial + auto-refresh
        window.addEventListener('DOMContentLoaded', updateNotifications);
        setInterval(updateNotifications, 60000); // Refresh 1min


        // ========== SÉLECTEUR PÉRIODE VENTES ==========

        let periodeActive = 30; // Default: 30 jours

        function togglePeriodeMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('periode-dropdown');
            const isVisible = dropdown.style.display === 'block';
            
            dropdown.style.display = isVisible ? 'none' : 'block';
        }

        // ✅ GESTION GLOBALE: Fermer dropdowns et date picker si click dehors
        document.addEventListener('click', function(e) {
            // 1) Date picker
            const datePicker = document.getElementById('dash-date-picker');
            const calendarBtn = document.getElementById('dash-calendar-btn');
            
            if (datePicker && calendarBtn) {
                // Si click en dehors du picker et du bouton calendrier
                if (e.target !== datePicker && e.target !== calendarBtn && !calendarBtn.contains(e.target)) {
                    masquerDatePicker();
                }
            }
            
            // 2) Dropdown période ventes
            const periodeDropdown = document.getElementById('periode-dropdown');
            const isBtnDots = e.target.closest('.btn-dots');
            
            if (!isBtnDots && periodeDropdown) {
                periodeDropdown.style.display = 'none';
            }
            
            // 3) Dropdown période transactions
            const transDropdown = document.getElementById('transactions-dropdown');
            
            if (!isBtnDots && transDropdown) {
                transDropdown.style.display = 'none';
            }
            
            // 4) Dropdown notifications
            const notifDropdown = document.getElementById('notif-dropdown');
            const notifBtn = document.getElementById('notif-btn');
            
            if (notifDropdown && notifBtn && e.target !== notifBtn && !notifBtn.contains(e.target) && !notifDropdown.contains(e.target)) {
                notifDropdown.style.display = 'none';
            }
        });


        function changerPeriode(jours) {
            periodeActive = jours;
            
            // Update checks
            ['7', '30', '90', '365'].forEach(j => {
                const check = document.getElementById(`check-${j}`);
                if (check) {
                    check.style.display = j === String(jours) ? 'inline' : 'none';
                }
            });
            
            // Update label
            const label = document.getElementById('periode-label');
            if (label) {
                label.textContent = jours === 365 ? '1 an' : `${jours}j`;
            }
            
            // Fermer dropdown
            document.getElementById('periode-dropdown').style.display = 'none';
            
            // Recalculer KPI
            updateKPIVentesPeriode();
        }

        function updateKPIVentesPeriode() {
            const today = new Date();
            const minDate = new Date();
            minDate.setDate(today.getDate() - periodeActive);
            
            // Somme ventes période actuelle
            const ventesActuelles = historique.filter(h => {
                if (h.type !== 'vente') return false;
                const dateH = new Date(h.date + 'T00:00:00');
                return dateH >= minDate && dateH <= today;
            }).reduce((sum, h) => sum + (h.total || 0), 0);
            
            // Somme ventes période précédente (même durée)
            const minDatePrev = new Date();
            minDatePrev.setDate(today.getDate() - (periodeActive * 2));
            const maxDatePrev = new Date();
            maxDatePrev.setDate(today.getDate() - periodeActive);
            
            const ventesPrecedentes = historique.filter(h => {
                if (h.type !== 'vente') return false;
                const dateH = new Date(h.date + 'T00:00:00');
                return dateH >= minDatePrev && dateH < maxDatePrev;
            }).reduce((sum, h) => sum + (h.total || 0), 0);
            
            // Calcul évolution
            let evolution = 0;
            if (ventesPrecedentes > 0) {
                evolution = ((ventesActuelles - ventesPrecedentes) / ventesPrecedentes) * 100;
            }
            
            // Affichage
            const kpiEl = document.getElementById('kpi-sales-period');
            const trendEl = document.getElementById('kpi-sales-trend');
            
            if (kpiEl) {
                kpiEl.textContent = ventesActuelles.toLocaleString('fr-FR') + ' Ar';
            }
            
            if (trendEl) {
                const arrow = evolution >= 0 ? '↑' : '↓';
                const color = evolution >= 0 ? '#16a34a' : '#dc2626';
                trendEl.innerHTML = `<span style="color: ${color}; font-weight: 700;">${arrow} ${Math.abs(evolution).toFixed(1)}%</span> vs période précédente`;
            }
        }

        // Appel initial
        window.addEventListener('DOMContentLoaded', function() {
            changerPeriode(30); // Default 30j
        });

        // ========== TRANSACTIONS PÉRIODE ==========

        let periodeTransactions = 30; // Default: 30 jours

        function toggleTransactionsMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('transactions-dropdown');
            const isVisible = dropdown.style.display === 'block';
            
            // Fermer menu ventes si ouvert
            const venteDropdown = document.getElementById('periode-dropdown');
            if (venteDropdown) venteDropdown.style.display = 'none';
            
            dropdown.style.display = isVisible ? 'none' : 'block';
        }

        function changerPeriodeTransactions(jours) {
            periodeTransactions = jours;
            
            // Update checks
            ['7', '30', '90', '365'].forEach(j => {
                const check = document.getElementById(`trans-check-${j}`);
                if (check) {
                    check.style.display = j === String(jours) ? 'inline' : 'none';
                }
            });
            
            // Update label
            const label = document.getElementById('transactions-periode-label');
            if (label) {
                label.textContent = jours === 365 ? '1 an' : `${jours}j`;
            }
            
            // Fermer dropdown
            document.getElementById('transactions-dropdown').style.display = 'none';
            
            // Recalculer KPI
            updateKPITransactionsPeriode();
        }

        function updateKPITransactionsPeriode() {
            const today = new Date();
            const minDate = new Date();
            minDate.setDate(today.getDate() - periodeTransactions);
            
            // Compter transactions période
            const count = historique.filter(h => {
                const dateH = new Date(h.date + 'T00:00:00');
                return dateH >= minDate && dateH <= today;
            }).length;
            
            // Affichage
            const kpiEl = document.getElementById('kpi-transactions-period');
            if (kpiEl) {
                kpiEl.textContent = count;
            }
        }

        // Fermer menus si click dehors
        document.addEventListener('click', function(e) {
            const venteDropdown = document.getElementById('periode-dropdown');
            const transDropdown = document.getElementById('transactions-dropdown');
            const btn = e.target.closest('.btn-dots');
            
            if (!btn) {
                if (venteDropdown) venteDropdown.style.display = 'none';
                if (transDropdown) transDropdown.style.display = 'none';
            }
        });

        // Appel initial
        window.addEventListener('DOMContentLoaded', function() {
            changerPeriodeTransactions(30); // Default 30j
        });

        // ========== TO-DO LIST ==========

        let todos = [];

        function chargerTodos() {
            const saved = localStorage.getItem('todos-gestion-achatvente');
            todos = saved ? JSON.parse(saved) : [
                { id: 1, texte: 'Vérifier stock faible', done: false },
                { id: 2, texte: 'Valider les ventes du jour', done: false }
            ];
            renderTodos();
        }

        function sauvegarderTodos() {
            localStorage.setItem('todos-gestion-achatvente', JSON.stringify(todos));
        }

        function renderTodos() {
            const list = document.getElementById('todo-list');
            if (!list) return;
            if (todos.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#9ca3af;">Aucune tâche. Ajoutez-en une !</div>';
                return;
            }
            list.innerHTML = todos.map(t => `
                <div class="todo-item">
                    <div class="todo-ic">
                        <i class="fa-regular fa-circle-check"></i>
                    </div>
                    <div class="todo-text ${t.done ? 'done' : ''}">${t.texte}</div>
                    <div class="todo-actions">
                        <button class="todo-btn" onclick="toggleTache(${t.id})">
                            ${t.done ? '↺' : '✔'}
                        </button>
                        <button class="todo-btn" onclick="supprimerTache(${t.id})">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function ajouterTache() {
            const input = document.getElementById('todo-input');
            if (!input) return;
            const texte = input.value.trim();
            if (!texte) return;

            const id = Date.now();
            todos.push({ id, texte, done: false });
            input.value = '';
            sauvegarderTodos();
            renderTodos();
        }

        function toggleTache(id) {
            todos = todos.map(t => t.id === id ? { ...t, done: !t.done } : t);
            sauvegarderTodos();
            renderTodos();
        }

        function supprimerTache(id) {
            if (!confirm('Supprimer cette tâche ?')) return;
            todos = todos.filter(t => t.id !== id);
            sauvegarderTodos();
            renderTodos();
        }

        // Init au chargement de la page
        window.addEventListener('DOMContentLoaded', chargerTodos);

        function createPagination(containerId, currentPage, totalItems, itemsPerPage, onPageChange, onPerPageChange) {
            // Sécurité: au moins 1 page
            const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));

            // Clamp currentPage ao anelanelan'ny 1 sy totalPages
            currentPage = Math.min(Math.max(1, currentPage), totalPages);

            const hasItems = totalItems > 0;
            const start = hasItems ? ((currentPage - 1) * itemsPerPage + 1) : 0;
            const end   = hasItems ? Math.min(currentPage * itemsPerPage, totalItems) : 0;
            
            let html = `
                <div class="pagination-wrapper">
                    <div class="pagination-info">
                        ${hasItems ? `Affichage ${start}-${end} sur ${totalItems}` : 'Aucune donnée'}
                    </div>
                    
                    <div class="pagination-controls">
                        <button class="pagination-btn" onclick="${onPageChange}(1)" ${currentPage === 1 || !hasItems ? 'disabled' : ''}>
                            <i class="fa-solid fa-angles-left"></i>
                        </button>
                        <button class="pagination-btn" onclick="${onPageChange}(${currentPage - 1})" ${currentPage === 1 || !hasItems ? 'disabled' : ''}>
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>`;
            
            // Pages numéros (max 5 visibles)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            for (let i = startPage; i <= endPage; i++) {
                const funcName = typeof onPageChange === 'string' ? onPageChange : 'onPageChange';
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="${funcName}(${i})">${i}</button>`;
            }

            
            html += `
                        <button class="pagination-btn" onclick="${onPageChange}(${currentPage + 1})" ${currentPage === totalPages || !hasItems ? 'disabled' : ''}>
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                        <button class="pagination-btn" onclick="${onPageChange}(${totalPages})" ${currentPage === totalPages || !hasItems ? 'disabled' : ''}>
                            <i class="fa-solid fa-angles-right"></i>
                        </button>
                    </div>
                    
                    <div class="page-size-selector">
                        <span>Par page:</span>
                        <select onchange="${onPerPageChange}(this.value)">
                            <option value="5"   ${itemsPerPage === 5   ? 'selected' : ''}>5</option>
                            <option value="10"  ${itemsPerPage === 10  ? 'selected' : ''}>10</option>
                            <option value="20"  ${itemsPerPage === 20  ? 'selected' : ''}>20</option>
                            <option value="25"  ${itemsPerPage === 25  ? 'selected' : ''}>25</option>
                            <option value="50"  ${itemsPerPage === 50  ? 'selected' : ''}>50</option>
                            <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100</option>
                        </select>
                    </div>
                </div>
            `;
            
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = html;
            }
        }

        // ✅ AUTO-BACKUP sy RESTORE AUTOMATIQUE
        function exporterDonneesAuto() {
            const data = {
                stock: stock,
                historique: historique,
                config: config,
                demandesPrix: demandesPrix,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-gestion-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('✅ Données sauvegardées !');
        }

        // ✅ Mampiseho notification raha tsy mbola nisy backup tato
        function verifierDernierBackup() {
            const lastBackup = localStorage.getItem('last-backup-date');
            const today = new Date().toISOString().split('T')[0];
            
            if (!lastBackup || lastBackup !== today) {
                // Mampiseho message reminder
                const reminder = document.createElement('div');
                reminder.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #fef3c7;
                    border: 2px solid #f59e0b;
                    border-radius: 12px;
                    padding: 16px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                    z-index: 10000;
                    max-width: 320px;
                `;
                reminder.innerHTML = `
                    <div style="display:flex; gap:12px; align-items:start;">
                        <div style="font-size:24px;">⚠️</div>
                        <div style="flex:1;">
                            <strong style="display:block; margin-bottom:8px;">Backup recommandé</strong>
                            <p style="font-size:13px; margin:0 0 12px 0; color:#92400e;">
                                Sauvegardez vos données pour éviter toute perte.
                            </p>
                            <button onclick="exporterDonneesAuto(); this.parentElement.parentElement.parentElement.remove(); localStorage.setItem('last-backup-date', '${today}');" 
                                    style="background:#111827; color:white; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;">
                                📥 Backup maintenant
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove();" 
                                    style="background:transparent; color:#6b7280; border:none; padding:8px 12px; cursor:pointer; font-size:12px; margin-left:8px;">
                                Plus tard
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(reminder);
            }
        }

        // ✅ Lancer vérification backup 5 secondes après chargement
        setTimeout(verifierDernierBackup, 5000);

        // ✅ SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        
                        // Update automatique
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('🔄 Nouvelle version disponible');
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error('❌ Erreur Service Worker:', error);
                    });
            });
        }

        // ✅ Détecter connexion/déconnexion
        window.addEventListener('online', () => {
            console.log('✅ Connexion rétablie');
            // Optional: afficher notification
        });

        window.addEventListener('offline', () => {
            console.log('⚠️ Mode hors ligne');
            // Optional: afficher notification
        });

    </script>
</body>
</html>
